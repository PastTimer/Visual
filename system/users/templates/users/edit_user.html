{% extends "base_internal.html" %}
{% block content %}

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Edit User</title>

<link href="https://fonts.googleapis.com/css?family=Inter:400,500,700&display=swap" rel="stylesheet">

<style>
    .success-message {
		color: green; 
		margin-bottom: 1rem;
	}

    .error-input {
        border-color: #E53E3E !important;
        background: #FFF5F5 !important;
    }

    .error-select {
        border-color: #E53E3E !important;
        background: 
            #FFF5F5 /* background color */
            url("data:image/svg+xml;utf8,<svg width='16' height='11' viewBox='0 0 16 11' fill='none' xmlns='http://www.w3.org/2000/svg'><path d='M7.99976 7.19417L13.9025 1.29147C14.0125 1.17758 14.144 1.08674 14.2895 1.02424C14.435 0.961746 14.5915 0.92885 14.7498 0.927474C14.9082 0.926098 15.0652 0.95627 15.2117 1.01623C15.3583 1.07619 15.4914 1.16473 15.6034 1.27669C15.7153 1.38866 15.8039 1.5218 15.8638 1.66835C15.9238 1.8149 15.954 1.97192 15.9526 2.13026C15.9512 2.28859 15.9183 2.44506 15.8558 2.59055C15.7933 2.73604 15.7025 2.86762 15.5886 2.97762L8.84283 9.72339C8.61921 9.94694 8.31596 10.0725 7.99976 10.0725C7.68356 10.0725 7.38031 9.94694 7.15669 9.72339L0.41092 2.97762C0.297028 2.86762 0.206183 2.73604 0.143687 2.59055C0.0811915 2.44506 0.0482959 2.28859 0.04692 2.13026C0.0455441 1.97192 0.0757155 1.8149 0.135674 1.66835C0.195632 1.5218 0.284176 1.38866 0.39614 1.27669C0.508103 1.16473 0.641244 1.07619 0.787794 1.01623C0.934343 0.95627 1.09137 0.926098 1.2497 0.927474C1.40804 0.92885 1.56451 0.961746 1.71 1.02424C1.85548 1.08674 1.98706 1.17758 2.09706 1.29147L7.99976 7.19417Z' fill='%23374151'/></svg>") 
            no-repeat right 0.75rem center !important;
    }

    body {
        background: #F9F9F9;
        margin: 0;
        font-family: 'Inter', Arial, sans-serif;
    }

    input, select, textarea {
        font-family: 'Inter', Arial, sans-serif;
        font-weight: 400;
    }

    .user-details-container {
        margin: 60px;
        display: flex;
        flex-direction: column;
        gap: 32px;
    }

    .user-details-title {
        font-size: 32px;
        font-weight: 400;
        color: #000;
        font-family: 'Inter', Arial, sans-serif;
    }

    .user-details-section {
        padding-bottom: 16px;
        border-bottom: 1px solid #E5E7EB;
    }

    .user-details-grid {
        display: grid;
        gap: 20px;
    }

    .user-details-row {
        display: grid;
        gap: 20px;
    }

    .user-details-row.cols-4 {
        grid-template-columns: repeat(4, 1fr);
    }
    
    .user-details-row.cols-3 {
        grid-template-columns: repeat(3, 1fr);
    }

    .user-details-row.cols-2 {
        grid-template-columns: repeat(2, 1fr);
    }
    
    .user-details-category {
        font-size: 1.15rem;
        font-weight: 700;
        color: #000;
    }

    .user-details-label {
        font-weight: 500;
        color: #374151;
        font-size: 1.08rem;
        margin-bottom: 0.25rem;
        margin-top: 1rem;
    }

    .user-details-value {
        font-weight: 500;
        color: #374151;
        font-size: 1.08rem;
        word-break: break-word;
        background: #f7f7f7;
        border-radius: 0.5rem;
        padding: 8px 14px;
        border: 1px solid #e5e7eb;
        min-height: 21px;
        display: block;
        width: 100%;
        box-sizing: border-box;
    }

    select.user-details-value {
		appearance: none;
		-webkit-appearance: none;
		-moz-appearance: none;
		padding-right: 2rem;
		background: url("data:image/svg+xml;utf8,<svg width='16' height='11' viewBox='0 0 16 11' fill='none' xmlns='http://www.w3.org/2000/svg'><path d='M7.99976 7.19417L13.9025 1.29147C14.0125 1.17758 14.144 1.08674 14.2895 1.02424C14.435 0.961746 14.5915 0.92885 14.7498 0.927474C14.9082 0.926098 15.0652 0.95627 15.2117 1.01623C15.3583 1.07619 15.4914 1.16473 15.6034 1.27669C15.7153 1.38866 15.8039 1.5218 15.8638 1.66835C15.9238 1.8149 15.954 1.97192 15.9526 2.13026C15.9512 2.28859 15.9183 2.44506 15.8558 2.59055C15.7933 2.73604 15.7025 2.86762 15.5886 2.97762L8.84283 9.72339C8.61921 9.94694 8.31596 10.0725 7.99976 10.0725C7.68356 10.0725 7.38031 9.94694 7.15669 9.72339L0.41092 2.97762C0.297028 2.86762 0.206183 2.73604 0.143687 2.59055C0.0811915 2.44506 0.0482959 2.28859 0.04692 2.13026C0.0455441 1.97192 0.0757155 1.8149 0.135674 1.66835C0.195632 1.5218 0.284176 1.38866 0.39614 1.27669C0.508103 1.16473 0.641244 1.07619 0.787794 1.01623C0.934343 0.95627 1.09137 0.926098 1.2497 0.927474C1.40804 0.92885 1.56451 0.961746 1.71 1.02424C1.85548 1.08674 1.98706 1.17758 2.09706 1.29147L7.99976 7.19417Z' fill='%23374151'/></svg>")
        		no-repeat right 0.75rem center;
  		background-size: 13px 8px;
    }

    .user-details-picture {
        width: 80px;
        height: 80px;
        border: 2px solid #000;
        object-fit: cover;
        margin-left: 12px;
    }

	.form-actions {
		display: flex;
		gap: 1rem;
		justify-content: flex-end;
	}

    .btn {
		padding: 0.75rem 1.5rem;
		border: none;
		border-radius: 8px;
		font-size: 1rem;
		font-weight: 600;
		cursor: pointer;
		transition: all 0.2s ease;
		font-family: 'Inter', sans-serif;
        text-decoration: none;
    }

    .back {
		background: #6B7280;
		color: white;
    }

    .back:hover {
		background: #4B5563;
		transform: translateY(-1px);
    }

    .save {
		background: #0A6C44;
		color: white;
    }

    .save:hover {
		background: #1f7c57;
		transform: translateY(-1px);
    }
</style>

<!-- File Upload -->
<style>
    .form-group {
        margin-top: 1rem;
        margin-bottom: 1rem;
		display: flex;
		align-items: flex-start;
		gap: 1rem;
	}

	.form-label {
		font-weight: 600;
		color: #374151;
		padding-top: 0.75rem;
		font-size: 0.95rem;
	}

	.upload-area {
		flex: 1;
		border: 2px dashed #E5E7EB;
		border-radius: 8px;
		padding: 2rem;
		text-align: center;
		background: #F9F9F9;
		cursor: pointer;
		transition: all 0.2s ease;
		display: flex;
		flex-direction: column;
		align-items: center;
		gap: 0.5rem;
	}

    .upload-area:hover {
        border-color: #0A6C44;
        background: #F0FDF4;
    }

    .upload-icon {
        width: 24px;
        height: 24px;
        color: #4B5563;
    }

    .upload-text {
        color: #4B5563;
        font-size: 0.95rem;
    }

    .file-preview {
        margin-top: 1rem;
        padding: 1rem;
        background: #F0FDF4;
        border: 1px solid #BBF7D0;
        border-radius: 8px;
        display: none;
    }

    .file-info {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        color: #1f7c57;
        font-size: 0.95rem;
    }

    span.required {
        color: #e53e3e;
    }

    .error-message {
        color: #e53e3e;
        font-size: 0.9rem;
        margin-top: -0.5rem;
        margin-bottom: 0.5rem;
    }
</style>

<!-- Verification -->
<style>
    .verification-badge {
        background: #E6FFFA;
        border: 1px solid #1F7C57;
        color: #1F7C57;
        font-weight: 600;
        font-size: 32px;
        padding: 6px 16px;
        border-radius: 8px;
        cursor: pointer;
        text-decoration: none;
    }

    .verification-badge.unverified {
        background: #FFF5F5;
        border: 1px solid #E53E3E;
        color: #E53E3E;
    }

    .verification-badge:hover {
        opacity: 0.9;
    }
</style>

</head>
<body>
<form method="post" enctype="multipart/form-data">
    {% csrf_token %}
    <div class="user-details-container">
        <div class="user-details-title" style="display:flex;flex-direction:column;gap:8px;">
            <div style="display:flex;justify-content:space-between;align-items:center;">
                <span>Edit User</span>
            </div>
        </div>

        {% if success %}
        <div id="add-success-msg" style="color:#16a34a;font-size:1.1rem;font-weight:500;">User edited successfully.</div>
        {% endif %}

        <div style="position: absolute; top: 140px; right: 60px;">
        {% if user.is_confirmed %}
            <a href="{% url 'unverify_user' user.id %}" class="verification-badge">Verified</a>
        {% else %}
            <a href="{% url 'verify_user' user.id %}" class="verification-badge unverified">Unverified</a>
        {% endif %}
        </div>

        <div class="user-details-section">
            <div class="user-details-category">User Profile</div>
            <div class="user-details-row cols-4">
                <div>
                    <div class="user-details-label">Last Name <span class="required">*</span></div>
                    <input type="text" name="last_name" class="user-details-value" value="{{ user.last_name }}">
                </div>
                <div>
                    <div class="user-details-label">Given Name <span class="required">*</span></div>
                    <input type="text" name="given_name" class="user-details-value" value="{{ user.given_name }}">
                </div>
                <div>
                    <div class="user-details-label">M.I.</div>
                    <input type="text" name="middle_initial" class="user-details-value" value="{{ user.middle_initial }}" data-optional>
                </div>
                <div>
                    <div class="user-details-label">Suffix</div>
                    <input type="text" name="suffix" class="user-details-value" value="{{ user.suffix|default_if_none:'' }}" data-optional>
                </div>
            </div>
            <div class="user-details-row cols-3">
                <div>
                    <div class="user-details-label">Sex <span class="required">*</span></div>
                    <select name="sex" class="user-details-value">
                        <option value="Male" {% if user.sex == 'Male' %}selected{% endif %}>Male</option>
                        <option value="Female" {% if user.sex == 'Female' %}selected{% endif %}>Female</option>
                    </select>
                </div>
                <div>
                    <div class="user-details-label">Email <span class="required">*</span></div>
                    <input type="email" name="email" class="user-details-value" value="{{ user.email }}" id="email-input">
                </div>
                <div>
                    <div class="user-details-label">Contact Number <span class="required">*</span></div>
                    <input type="text" name="contact_no" class="user-details-value" value="{{ user.contact_no }}">
                </div>
            </div>
            {% if user.valid_id %}
            <div>

                <!-- Valid ID Upload -->
                <div class="form-group">
                    <div>
                        <div class="user-details-label">Valid ID</div>
                        <div style="display:flex;align-items:center;">
                        <img id="preview-img" src="{{ user.valid_id.url }}" alt="Valid ID" class="user-details-picture">
                        <a id="preview-link" href="{{ user.valid_id.url }}" style="font-size:18px;color:#00538E;margin-left:18px;vertical-align:middle;text-decoration:none;">View ID</a>
                        </div>
                    </div>

                    <div class="upload-area" onclick="document.getElementById('id_valid_id').click()">
                        <svg class="upload-icon"><use href="#icon-upload"></use></svg>
                        <span class="upload-text">Click to upload</span>
                        <input class="file-input" type="file" name="valid_id" id="id_valid_id" style="display:none;" accept="image/*">
                    </div>
                    <div id="file-error" class="error-message" style="display:none;">File is required.</div>    
                </div>

                <div class="file-preview" id="file-preview">
                <div class="file-info">
                    <svg width="16" height="16"><use href="#icon-upload"></use></svg>
                    <span id="file-name"></span>
                </div>
                </div>

            </div>
            {% else %}
            <div>
                <div class="user-details-label">Valid ID</div>
                <div class="user-details-value">No valid ID uploaded.</div>
            </div>
            {% endif %}
        </div>

        <!-- Account Info Section -->
        <div class="user-details-section">
            <div class="user-details-category">Account Info</div>
            <div class="user-details-row cols-2">
                <div>
                    <div class="user-details-label">Role</div>
                    <select name="role" class="user-details-value">
                        <option value="UESO" {% if user.role == 'UESO' %}selected{% endif %}>UESO</option>
                        <option value="COORDINATOR" {% if user.role == 'COORDINATOR' %}selected{% endif %}>College Coordinator</option>
                        <option value="DEAN" {% if user.role == 'DEAN' %}selected{% endif %}>College Dean</option>
                        <option value="PROGRAM_HEAD" {% if user.role == 'PROGRAM_HEAD' %}selected{% endif %}>Program Head</option>
                        <option value="VP" {% if user.role == 'VP' %}selected{% endif %}>VP</option>
                        <option value="IMPLEMENTER" {% if user.role == 'IMPLEMENTER' %}selected{% endif %}>Implementer</option>
                        <option value="FACULTY" {% if user.role == 'FACULTY' %}selected{% endif %}>Faculty</option>
                        <option value="CLIENT" {% if user.role == 'CLIENT' %}selected{% endif %}>Client</option>
                    </select>
                </div>
                <div>
                    <div class="user-details-label">Joined</div>
                    <input type="text" class="user-details-value" value="{{ user.date_joined|date:'F d, Y' }}" disabled>
                </div>
            </div>
        </div>

        <!-- Implementer Info -->
        <div id="role-info-IMPLEMENTER" class="role-info-block" {% if user.role == 'IMPLEMENTER' %}style="display:block;"{% else %}style="display:none;"{% endif %}>
            <div class="user-details-section">
                <div class="user-details-category">Implementer Info</div>
                <div class="user-details-row cols-2">
                    <div>
                        <div class="user-details-label">Degree <span class="required">*</span></div>
                        <input type="text" name="degree" class="user-details-value" value="{{ user.degree }}" data-role-required>
                    </div>
                    <div>
                        <div class="user-details-label">Expertise <span class="required">*</span></div>
                        <input type="text" name="expertise" class="user-details-value" value="{{ user.expertise }}" data-role-required>
                    </div>
                </div>
            </div>
        </div>

        <!-- Faculty Info -->
        <div id="role-info-FACULTY" class="role-info-block" {% if user.role == 'FACULTY' %}style="display:block;"{% else %}style="display:none;"{% endif %}>
            <div class="user-details-section">
                <div class="user-details-category">Faculty Info</div>
                <div class="user-details-row cols-2">
                    <div>
                        <div class="user-details-label">College <span class="required">*</span></div>
                        <select name="college" class="user-details-value" data-role-required>
                            <option value="">Select College</option>
                            {% for college in colleges %}
                                <option value="{{ college.id }}" {% if user.college and user.college.id == college.id %}selected{% endif %}>{{ college.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div>
                        <div class="user-details-label">Campus <span class="required">*</span></div>
                        <select name="campus" class="user-details-value" data-role-required>
                            <option value="">Select Campus</option>
                            {% for value, label in campus_choices %}
                                <option value="{{ value }}" {% if user.campus == value %}selected{% endif %}>{{ label }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="user-details-row cols-2">
                    <div>
                        <div class="user-details-label">Degree <span class="required">*</span></div>
                        <input type="text" name="degree" class="user-details-value" value="{{ user.degree }}" data-role-required>
                    </div>
                    <div>
                        <div class="user-details-label">Expertise <span class="required">*</span></div>
                        <input type="text" name="expertise" class="user-details-value" value="{{ user.expertise }}" data-role-required>
                    </div>
                </div>
            </div>
        </div>

        <!-- Client Info -->
        <div id="role-info-CLIENT" class="role-info-block" {% if user.role == 'CLIENT' %}style="display:block;"{% else %}style="display:none;"{% endif %}>
            <div class="user-details-section">
                <div class="user-details-category">Client Info</div>
                <div class="user-details-row cols-2">
                    <div>
                        <div class="user-details-label">Company <span class="required">*</span></div>
                        <input type="text" name="company" class="user-details-value" value="{{ user.company }}" data-role-required>
                    </div>
                    <div>
                        <div class="user-details-label">Industry <span class="required">*</span></div>
                        <input type="text" name="industry" class="user-details-value" value="{{ user.industry }}" data-role-required>
                    </div>
                </div>
            </div>
        </div>

        <!-- Dean Info -->
        <div id="role-info-DEAN" class="role-info-block" {% if user.role == 'DEAN' %}style="display:block;"{% else %}style="display:none;"{% endif %}>
            <div class="user-details-section">
                <div class="user-details-category">Dean Info</div>
                <div class="user-details-row cols-2">
                    <div>
                        <div class="user-details-label">College <span class="required">*</span></div>
                        <select name="college" class="user-details-value" data-role-required>
                            <option value="">Select College</option>
                            {% for college in colleges %}
                                <option value="{{ college.id }}" {% if user.college and user.college.id == college.id %}selected{% endif %}>{{ college.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div>
                        <div class="user-details-label">Campus <span class="required">*</span></div>
                        <select name="campus" class="user-details-value" data-role-required>
                            <option value="">Select Campus</option>
                            {% for value, label in campus_choices %}
                                <option value="{{ value }}" {% if user.campus == value %}selected{% endif %}>{{ label }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <!-- Program Head Info -->
        <div id="role-info-PROGRAM_HEAD" class="role-info-block" {% if user.role == 'PROGRAM_HEAD' %}style="display:block;"{% else %}style="display:none;"{% endif %}>
            <div class="user-details-section">
                <div class="user-details-category">Program Head Info</div>
                <div class="user-details-row cols-2">
                    <div>
                        <div class="user-details-label">College <span class="required">*</span></div>
                        <select name="college" class="user-details-value" data-role-required>
                            <option value="">Select College</option>
                            {% for college in colleges %}
                                <option value="{{ college.id }}" {% if user.college and user.college.id == college.id %}selected{% endif %}>{{ college.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div>
                        <div class="user-details-label">Campus <span class="required">*</span></div>
                        <select name="campus" class="user-details-value" data-role-required>
                            <option value="">Select Campus</option>
                            {% for value, label in campus_choices %}
                                <option value="{{ value }}" {% if user.campus == value %}selected{% endif %}>{{ label }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <!-- Coordinator Info -->
        <div id="role-info-COORDINATOR" class="role-info-block" {% if user.role == 'COORDINATOR' %}style="display:block;"{% else %}style="display:none;"{% endif %}>
            <div class="user-details-section">
                <div class="user-details-category">College Coordinator Info</div>
                <div class="user-details-row cols-2">
                    <div>
                        <div class="user-details-label">College <span class="required">*</span></div>
                        <select name="college" class="user-details-value" data-role-required>
                            <option value="">Select College</option>
                            {% for college in colleges %}
                                <option value="{{ college.id }}" {% if user.college and user.college.id == college.id %}selected{% endif %}>{{ college.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div>
                        <div class="user-details-label">Campus <span class="required">*</span></div>
                        <select name="campus" class="user-details-value" data-role-required>
                            <option value="">Select Campus</option>
                            {% for value, label in campus_choices %}
                                <option value="{{ value }}" {% if user.campus == value %}selected{% endif %}>{{ label }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <div class="form-actions">
            <a href="{% url 'manage_user' %}" class="back btn">Back</a>
            <button type="submit" class="save btn">Save Changes</button>
        </div>
    </div>
</form>

<!-- SVG Sprite Section -->
<svg style="display:none;">

    <!-- Upload Icon -->
    <symbol id="icon-upload" viewBox="0 0 24 24" fill="currentColor">
        <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z" />
        <path d="M12,11L8,15H16L12,11Z" />
    </symbol>

</svg>

<script>
    // File Input Change Handler (robust)
    document.getElementById('id_valid_id').addEventListener('change', function(e) {
        const file = e.target.files[0];
        const fileInput = document.getElementById('id_valid_id');
        let fileError = document.getElementById('file-error');
        if (!fileError) {
            fileError = document.createElement('div');
            fileError.id = 'file-error';
            fileError.className = 'error-message';
            fileInput.parentNode.appendChild(fileError);
        }
        fileInput.classList.remove('error-input');
        if (file) {
            document.getElementById('file-name').textContent = file.name;
            document.getElementById('file-preview').style.display = 'block';
            fileError.style.display = 'none';
        } else {
            document.getElementById('file-preview').style.display = 'none';
        }
    });

    // Role-Based Info Display (unchanged)
    document.addEventListener('DOMContentLoaded', function() {
        var roleSelect = document.querySelector('select[name="role"]');
        var roleBlocks = {
            'IMPLEMENTER': document.getElementById('role-info-IMPLEMENTER'),
            'FACULTY': document.getElementById('role-info-FACULTY'),
            'CLIENT': document.getElementById('role-info-CLIENT'),
            'DEAN': document.getElementById('role-info-DEAN'),
            'PROGRAM_HEAD': document.getElementById('role-info-PROGRAM_HEAD'),
            'COORDINATOR': document.getElementById('role-info-COORDINATOR'),
        };
        function updateRoleBlocks() {
            var selected = roleSelect.value;
            Object.keys(roleBlocks).forEach(function(role) {
                var block = roleBlocks[role];
                if (role === selected) {
                    block.style.display = 'block';
                } else {
                    block.style.display = 'none';
                }
            });
        }
        roleSelect.addEventListener('change', updateRoleBlocks);
        updateRoleBlocks();

        // AJAX email uniqueness check (unchanged)
        var emailInput = document.getElementById('email-input');
        var emailError = document.getElementById('email-error');
        function checkEmailAjax() {
            var email = emailInput.value.trim();
            if (!email) {
                emailError.textContent = '';
                emailError.style.display = 'none';
                return;
            }
            fetch('/check-email/?email=' + encodeURIComponent(email))
                .then(response => response.json())
                .then(data => {
                    if (data.exists) {
                        emailError.textContent = 'This email is already registered.';
                        emailError.style.display = 'block';
                    } else {
                        emailError.textContent = '';
                        emailError.style.display = 'none';
                    }
                })
                .catch(() => {
                    emailError.textContent = 'Error checking email.';
                    emailError.style.display = 'block';
                });
        }
        if (emailInput) {
            emailInput.addEventListener('blur', checkEmailAjax);
            emailInput.addEventListener('input', checkEmailAjax);
        }

        // Robust form validation for all required fields
        document.querySelector('form').addEventListener('submit', function(e) {
            let valid = true;
            // Remove previous error states/messages for inputs, selects, textareas
            const fields = Array.from(document.querySelector('form').querySelectorAll('input, select, textarea'));
            fields.forEach(field => {
                field.classList.remove('error-input');
                let err = field.parentNode.querySelector('.field-error');
                if (err) err.remove();
            });
            // Remove file error
            let fileInput = document.getElementById('id_valid_id');
            let fileError = document.getElementById('file-error');
            if (fileError) fileError.style.display = 'none';
            fileInput.classList.remove('error-input');

            // Validate all visible required fields
            fields.forEach(field => {
                // Only validate visible fields
                if (field.offsetParent === null) return;
                // Skip optional fields
                if (field.hasAttribute('data-optional')) return;
                // Validate required fields
                if ((field.tagName === 'INPUT' || field.tagName === 'TEXTAREA') && field.type !== 'file' && !field.value.trim()) {
                    valid = false;
                    field.classList.add('error-input');
                    let err = document.createElement('div');
                    err.className = 'field-error';
                    err.textContent = 'This field is required.';
                    err.style.color = '#E53E3E';
                    err.style.fontSize = '0.95rem';
                    err.style.marginTop = '0.25rem';
                    field.parentNode.appendChild(err);
                }
                if (field.tagName === 'SELECT' && (!field.value || field.value === '' || field.value === field.querySelector('option[disabled]')?.value)) {
                    valid = false;
                    field.classList.add('error-input');
                    let err = document.createElement('div');
                    err.className = 'field-error';
                    err.textContent = 'This field is required.';
                    err.style.color = '#E53E3E';
                    err.style.fontSize = '0.95rem';
                    err.style.marginTop = '0.25rem';
                    field.parentNode.appendChild(err);
                }
            });

            // Validate file upload
            if (!fileInput.files || fileInput.files.length === 0) {
                valid = false;
                fileInput.classList.add('error-input');
                if (!fileError) {
                    fileError = document.createElement('div');
                    fileError.id = 'file-error';
                    fileError.className = 'error-message';
                    fileInput.parentNode.appendChild(fileError);
                }
                fileError.textContent = 'Valid ID is required.';
                fileError.style.display = 'block';
            }

            // Email uniqueness error
            var email = emailInput.value.trim();
            if (email && emailError && emailError.style.display === 'block') {
                valid = false;
                emailInput.classList.add('error-input');
                emailInput.focus();
            }

            if (!valid) {
                e.preventDefault();
            }
        });
    });


    // Image Preview
    // Set valid_id_url from template, fallback to empty string
    var valid_id_url = "{% if user.valid_id and user.valid_id.name %}{{ user.valid_id.url }}{% else %}{% endif %}";
    document.getElementById('id_valid_id').addEventListener('change', function(e) {
        var file = e.target.files[0];
        var previewImg = document.getElementById('preview-img');
        var previewLink = document.getElementById('preview-link');
        var fileNameSpan = document.getElementById('file-name');
        if (file) {
            var reader = new FileReader();
            reader.onload = function(evt) {
                previewImg.src = evt.target.result;
                previewLink.href = evt.target.result;
                previewLink.style.opacity = '0.5';
                previewLink.style.pointerEvents = 'none';
                previewLink.style.cursor = 'not-allowed';
            };
            reader.readAsDataURL(file);
            fileNameSpan.textContent = file.name;
        } else {
            // Reset to original
            previewImg.src = valid_id_url;
            previewLink.href = valid_id_url ? valid_id_url : "#";
            fileNameSpan.textContent = '';
        }
    });
</script>

</body>
</html>

{% endblock %}