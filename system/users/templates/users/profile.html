{% extends base_template %}
{% block content %}
{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>My Profile</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer">

<link href="{% static 'internal/experts/prof.css' %}" rel="stylesheet">

</head>
<body>
    <main> 
        <section>
            <div class="propic" {% if can_edit %}onclick="openImageModal()"{% endif %}>
				{% if profile_user.profile_picture %}
				<img src="{{ profile_user.profile_picture.url }}" alt="{{ profile_user.get_full_name }}" id="profileImg">
				{% else %}
                <div class="propic-placeholder" id="profileInitials">
					{{ profile_user.given_name.0 }}{{ profile_user.last_name.0 }}
				</div>
				{% endif %}
				{% if can_edit %}
				<div class="edit-overlay">
					<i class="fa-solid fa-camera"></i> Change Photo
				</div>
				{% endif %}
			</div>

            <div class="profile-info-grid">
                <div class="personal-info">
					<h2>{{ profile_user.get_full_name }}</h2>
					{% if profile_user.role in HAS_COLLEGE_CAMPUS %}
					<h4><i class="fas fa-map-marker-alt" style="color:red; margin-right:0.5rem;"></i> {{ campus_display }}</h4>
					{% endif %}

					{% if profile_user.role in HAS_COLLEGE_CAMPUS %}
						{% if college_logo %}
						<img src="{{ college_logo }}" alt="{{ college_name }}" title="{{ college_name }}">
						{% else %}
						<div class="college-logo-placeholder">
							{{ college_name.0|default:"?" }}
						</div>
						{% endif %}
					{% endif %}
				</div>
                
                <div class="expertise">
					{% if profile_user.role in HAS_DEGREE_EXPERTISE %}
						<h5>Field of Expertise:</h5>
						<p>{{ profile_user.expertise|default:"Not specified" }}</p>
						{% if college_name and college_name != "N/A" %}
						<h5>{{ profile_user.degree|default:"Degree Not Listed" }}</h5>
						<p>{{ college_name }}</p>
						{% endif %}
					{% elif profile_user.role in HAS_COMPANY_INDUSTRY %}
						<h5>Company:</h5>
						<p>{{ profile_user.company|default:"Not specified" }}</p>
						<h5>Industry:</h5>
						<p>{{ profile_user.industry|default:"Not specified" }}</p>
					{% else %}
						<h5>Role:</h5>
						<p>{{ profile_user.get_role_display }}</p>
						{% if college_name and college_name != "N/A" %}
						<h5>College:</h5>
						<p>{{ college_name }}</p>
						{% endif %}
					{% endif %}
				</div>

                <div class="contact">
					<h5>Contact:</h5>
					<p>{{ profile_user.email }}</p>
                    <p>{{ profile_user.contact_no|default:"" }}</p>
				</div>
			</div>
		</section>

        <section class="lower">
            <div class="bio">
				<div class="lower-header">
					<h1>Bio</h1>
					{% if can_edit %}
						<button class="save" onclick="toggleBioEditor(true)">Edit Bio</button>
					{% endif %}
				</div>
				<div class="bio-content">
					<div class="bio-display" style="margin-top: 1rem;">
						<p class="bio-text">
							{{ profile_user.bio|linebreaksbr|default:"No bio added yet." }}
						</p>
					</div>
					{% if can_edit %}
					<div class="bio-editor">
						<form id="bioForm" method="POST" action="{% url 'update_bio' %}">
							{% csrf_token %}
							<textarea name="bio" id="bioTextarea">{{ profile_user.bio|default:"" }}</textarea>
							<div class="bio-editor-actions">
								<button type="submit" class="save-bio-btn">Save</button>
								<button type="button" class="cancel-bio-btn" onclick="toggleBioEditor(false)">Cancel</button>
							</div>
						</form>
					</div>
					{% endif %}
				</div>
			</div>

            <div class="project">
				<div class="lower-header"> 
					<div>
                        <h1>
                            {% if profile_user.role in "FACULTY,IMPLEMENTER" %}
							{% if can_edit %}My Projects{% else %}Projects{% endif %}
							{% elif profile_user.role in "PROGRAM_HEAD,DEAN,COORDINATOR" %}
							College Projects 
							{% elif profile_user.role == "CLIENT" %}
							{% if can_edit %}My Requests{% else %}Requests{% endif %} 
							{% else %}
							Projects
							{% endif %}
                        </h1>   
					</div>
					<div style="display: flex; flex-shrink: 3; align-items: center; gap: 0.5rem;">
                        <span style="font-size: 1.1rem; font-weight: 500; color: #444; width: 6rem;">Sort by:</span>
						<select id="sortContent" class="dropdown-btn" style="margin: 0.75rem 0;">
							<option value="date-desc">Newest First</option>
							<option value="date-asc">Oldest First</option>
							<option value="title-asc">Title (A-Z)</option>
							<option value="title-desc">Title (Z-A)</option>
							{% if profile_user.role != "CLIENT" %}
							<option value="status">Status</option>
							{% endif %}
						</select>
					</div>
				</div>
                <div class="project-card" id="contentList"> 
					</div>
			</div>
		</section>
	</main>

	<div class="modal-overlay" id="imageModalOverlay" onclick="closeImageModal()"></div>
	<div class="modal" id="imageModal">
		<h3>Change Profile Picture</h3>

		<form id="imageForm" method="POST" action="{% url 'update_profile_picture' %}" enctype="multipart/form-data">
			{% csrf_token %}

			<input 
				type="file" 
				name="profile_picture" 
				id="hiddenFileInput" 
				style="display: none;"
				accept="image/jpeg,image/png,image/jpg,image/gif,image/webp" 
				onchange="document.getElementById('imageForm').submit();"
				required>

			<div class="modal-actions">
				<button 
					type="button" 
					class="save" 
					onclick="document.getElementById('hiddenFileInput').click();">
					Choose File
				</button>
				<button 
					type="button" 
					class="cancel" 
					onclick="closeImageModal()">
					Cancel
				</button>
			</div>
		</form>
	</div>

<script>
// Image modal logic (Unchanged)
function openImageModal() {
	document.getElementById('imageModalOverlay').classList.add('active');
	document.getElementById('imageModal').classList.add('active');
}
function closeImageModal() {
	document.getElementById('imageModalOverlay').classList.remove('active');
	document.getElementById('imageModal').classList.remove('active');
}

// Bio editor logic (Unchanged)
function toggleBioEditor(show) {
	const display = document.querySelector('.bio-display');
	const editor = document.querySelector('.bio-editor');
	
	if (show) {
		display.style.display = 'none';
		editor.classList.add('active');
	} else {
		display.style.display = 'block';
		editor.classList.remove('active');
	}
}

// Content data and rendering
const contentData = [
	{% if profile_user.role == "CLIENT" %}
		{% for request in content_items %}
		{
			id: {{ request.id }},
			title: "{{ request.title|escapejs }}",
			date: "{{ request.created_at|date:'Y-m-d' }}",
            // CHANGED: Date format to match
			dateDisplay: "{{ request.created_at|date:'F j, Y' }}",
			status: "{{ request.status }}",
			type: "request"
		}{% if not forloop.last %},{% endif %}
		{% endfor %}
	{% else %}
		{% for project in content_items %}
		{
			id: {{ project.id }},
			title: "{{ project.title|escapejs }}",
			date: "{{ project.start_date|date:'Y-m-d' }}",
            // CHANGED: Date format to match
			dateDisplay: "{{ project.start_date|date:'F j, Y' }}",
			status: "{{ project.status }}",
			leaderCampus: "{{ project.project_leader.get_campus_display|default:'N/A'|escapejs }}",
			agenda: "{{ project.agenda.name|default:''|escapejs }}",
			leaderName: "{{ project.project_leader.get_full_name|escapejs }}",
            // FIX: Added both initials
			leaderInitials: "{{ project.project_leader.given_name.0 }}{{ project.project_leader.last_name.0 }}",
			providers: [
				{% for provider in project.providers.all %}
				{
                    id: {{ provider.id }},
					name: "{{ provider.get_full_name|escapejs }}",
                    // FIX: Added both initials
					initials: "{{ provider.given_name.0 }}{{ provider.last_name.0 }}"
				}{% if not forloop.last %},{% endif %}
				{% endfor %}
			],
			providersCount: {{ project.providers.count }},
			type: "project"
		}{% if not forloop.last %},{% endif %}
		{% endfor %}
	{% endif %}
];

// 
//  CHANGED: This function now renders HTML that matches experts_profile.html
// 
function renderContent(items) {
	const container = document.getElementById('contentList');
	
	if (items.length === 0) {
		{% if profile_user.role == "CLIENT" %}
		container.innerHTML = '<div style="padding: 1rem 3rem; color: #666; margin-top: 1rem;">{% if can_edit %}You have{% else %}This user has{% endif %} no requests yet.</div>';
		{% else %}
		container.innerHTML = '<div style="padding: 1rem 3rem; color: #666; margin-top: 1rem;">No projects found.</div>';
		{% endif %}
		return;
	}
	
	container.innerHTML = items.map(item => {
		if (item.type === 'request') {
            // Style requests similar to projects
			return `
				<div>
                    <h5>${item.dateDisplay}</h5>
                    <a href="/request/details/${item.id}/" class="title">${item.title}</a>
                    <section class="project-tags">
                        <button class="status" style="color: #007bff; border-color: #007bff;">${item.status}</button>
                    </section>
                    <a href="/request/details/${item.id}/" class="view">View</a>
                </div>
			`;
		} else {
            // This is the project card structure from experts_profile.html
			let statusTag = '';
			if (item.status === 'COMPLETED') {
				statusTag = '<button class="status" style="color: #1CB889; border-color: #1CB889;">Completed</button>';
			} else if (item.status === 'IN_PROGRESS') {
				statusTag = '<button class="status" style="color: #007bff; border-color: #007bff;">Ongoing</button>';
			} else if (item.status === 'NOT_STARTED') {
				statusTag = '<button class="status" style="color: #6c757d; border-color: #6c757d;">Not Started</button>';
			} else if (item.status === 'ON_HOLD') {
				statusTag = '<button class="status" style="color: #ffc107; border-color: #ffc107;">On Hold</button>';
			} else if (item.status === 'CANCELLED') {
				statusTag = '<button class="status" style="color: #dc3545; border-color: #dc3545;">Cancelled</button>';
			} else {
                statusTag = `<button class="status" style="color: #6c757d; border-color: #6c757d;">${item.status}</button>`;
            }
			
            let authorsHTML = '';
            if (item.leaderName) {
                authorsHTML += `
                <content>
                    <div class="avatar-placeholder">${item.leaderInitials}</div>
                    <a href="/experts/profile/${item.id}/">${item.leaderName}</a> 
                </content>
                `;
            }

			const providersList = item.providers.slice(0, 2).map(p => 
				`<content>
                    <div class="avatar-placeholder">${p.initials}</div>
                    <a href="/experts/profile/${p.id}/">${p.name}</a> 
                </content>`
			).join('');
            authorsHTML += providersList;
			
			const moreProviders = item.providersCount > 2 ? 
				`<content style="align-items: center;"><a href="/projects/${item.id}/">+${item.providersCount - 2} more</a></content>` : '';
            authorsHTML += moreProviders;
			
			return `
				<div>
                    <h5>${item.dateDisplay}</h5>
                    <a href="/projects/${item.id}/" class="title">${item.title}</a>
                    <section class="project-tags">
                        <button class="campus">${item.leaderCampus}</button>
                        ${item.agenda ? `<button class="agenda">${item.agenda}</button>` : ''}
                        ${statusTag}
                    </section>
                    <section class="project-authors"> 
                        ${authorsHTML}
                    </section>
                    <a href="/projects/${item.id}/" class="view">View</a> 
                </div>
			`;
		}
	}).join('');
}

// Sort listener (Unchanged, already targets 'sortContent')
document.getElementById('sortContent').addEventListener('change', function(e) {
	const sortBy = e.target.value;
	let sorted = [...contentData];
	
	switch(sortBy) {
		case 'date-desc':
			sorted.sort((a, b) => new Date(b.date) - new Date(a.date));
			break;
		case 'date-asc':
			sorted.sort((a, b) => new Date(a.date) - new Date(b.date));
			break;
		case 'title-asc':
			sorted.sort((a, b) => a.title.localeCompare(b.title));
			break;
		case 'title-desc':
			sorted.sort((a, b) => b.title.localeCompare(a.title));
			break;
		case 'status':
			const statusOrder = {'COMPLETED': 1, 'IN_PROGRESS': 2, 'NOT_STARTED': 3, 'ON_HOLD': 4, 'CANCELLED': 5};
			sorted.sort((a, b) => (statusOrder[a.status] || 99) - (statusOrder[b.status] || 99));
			break;
	}
	
	renderContent(sorted);
});

// Initial render
renderContent(contentData);
</script>

</body>
</html>

{% endblock %}