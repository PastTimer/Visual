{% extends base_template %}
{% block content %}
{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>My Profile</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer">

<link href="{% static 'internal/experts/prof.css' %}" rel="stylesheet">

<style>
    /* Hide input fields by default */
    .edit-mode-field { display: none; }
    .edit-mode-controls { display: none; }
    .edit-profile-picture-trigger { display: none; }

    /* When edit mode is active */
    main.edit-mode .edit-mode-field { display: block; } /* Show input fields */
    main.edit-mode .display-mode-field { display: none; } /* Hide display fields */
    main.edit-mode .edit-mode-controls { display: flex; gap: 10px; margin-top: 15px; } /* Show Save/Cancel buttons */
    main.edit-mode .edit-profile-picture-trigger { display: block; cursor: pointer; color: #007bff; text-align: center; margin-top: 10px; font-size: 0.9em;} /* Show Change Picture link */
    main.edit-mode .edit-overlay { display: none; } /* Hide default hover overlay in edit mode */

    /* Style inputs to somewhat match display */
    .edit-mode-field input[type="text"],
    .edit-mode-field input[type="email"],
    .edit-mode-field input[type="tel"],
    .edit-mode-field textarea {
        width: 100%;
        padding: 8px;
        margin-top: 5px;
        border: 1px solid #ccc;
        border-radius: 4px;
        font-family: inherit;
        font-size: inherit;
    }
    .edit-mode-field textarea {
        min-height: 100px;
        resize: vertical;
    }
    
    /* Style for the main Edit Profile button */
    .edit-profile-button-container {
      position: absolute; /* Position relative to the section */
      top: 1rem;
      right: 1rem;
    }

    .edit-profile-button {
      padding: 8px 16px;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 0.9em;
    }
    .edit-profile-button:hover {
      background-color: #0056b3;
    }

    /* Adjust profile picture container for edit mode */
     main.edit-mode .propic { cursor: default; } /* Remove pointer cursor in edit mode */

     /* Make sure labels are visible */
     .edit-mode-field label {
         display: block;
         margin-top: 10px;
         font-weight: bold;
         font-size: 0.9em;
         color: #333;
     }

     /* Standardize button styles used in edit mode */
    .save-bio-btn, .cancel-bio-btn {
        padding: 8px 16px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
    }
    .save-bio-btn {
        background: linear-gradient(90deg, #9409FF 0%, #FF3300 100%);
        color: white;
    }
    .cancel-bio-btn {
        background: #6c757d;
        color: white;
    }


</style>

</head>
<body>
    <form id="profileForm" method="POST" action="{% url 'update_profile' %}" enctype="multipart/form-data">
        {% csrf_token %}
        <main> 
            <section style="position: relative;"> 
                
                {% if can_edit %}
                <div class="edit-profile-button-container display-mode-field">
                    <button type="button" class="edit-profile-button" onclick="toggleEditMode(true)">Edit Profile</button>
                </div>
                {% endif %}

                <div class="propic">
                    <div class="display-mode-field">
                        {% if profile_user.profile_picture %}
                        <img src="{{ profile_user.profile_picture.url }}" alt="{{ profile_user.get_full_name }}" id="profileImgDisplay">
                        {% else %}
                        <div class="propic-placeholder" id="profileInitialsDisplay">
                            {{ profile_user.given_name.0 }}{{ profile_user.last_name.0 }}
                        </div>
                        {% endif %}
                        {% if can_edit %}
                        <div class="edit-overlay">
                            <i class="fa-solid fa-camera"></i> Change Photo (Click Edit)
                        </div>
                        {% endif %}
                    </div>
                    <div class="edit-mode-field">
                         {% if profile_user.profile_picture %}
                            <img src="{{ profile_user.profile_picture.url }}" alt="{{ profile_user.get_full_name }}" id="profileImgEdit" style="width:100%; height: 100%; object-fit: cover; border-radius: 50%;">
                         {% else %}
                             <div class="propic-placeholder" id="profileInitialsEdit" style="font-size: 6rem;">{{ profile_user.given_name.0 }}{{ profile_user.last_name.0 }}</div>
                         {% endif %}
                        <input type="file" name="profile_picture" id="profilePictureInput" style="display: none;" accept="image/*" onchange="previewImage(event)">
                        <a class="edit-profile-picture-trigger" onclick="document.getElementById('profilePictureInput').click();">Change Picture</a>
                    </div>
                </div>

                <div class="profile-info-grid">
                    
                    <div class="personal-info">
                        <h2 class="display-mode-field">{{ profile_user.get_full_name }}</h2>
                        <div class="edit-mode-field">
                            <label for="id_given_name">First Name:</label>
                            <input type="text" name="given_name" id="id_given_name" value="{{ profile_user.given_name }}">
                            <label for="id_last_name">Last Name:</label>
                            <input type="text" name="last_name" id="id_last_name" value="{{ profile_user.last_name }}">
                        </div>

                        {% if profile_user.role in HAS_COLLEGE_CAMPUS %}
                        <h4 class="display-mode-field"><i class="fas fa-map-marker-alt" style="color:red; margin-right:0.5rem;"></i> {{ campus_display }}</h4>
                        <div class="edit-mode-field">
                           <label for="id_campus">Campus:</label>
                           <select name="campus" id="id_campus">
                               {% for value, display in profile_user.Campus.choices %}
                                   <option value="{{ value }}" {% if profile_user.campus == value %}selected{% endif %}>{{ display }}</option>
                               {% endfor %}
                           </select>
                        </div>
                        {% endif %}

                        {% if profile_user.role in HAS_COLLEGE_CAMPUS %}
                            {% if college_logo %}
                            <img class="display-mode-field edit-mode-field" src="{{ college_logo }}" alt="{{ college_name }}" title="{{ college_name }}">
                            {% else %}
                            <div class="college-logo-placeholder display-mode-field edit-mode-field">
                                {{ college_name.0|default:"?" }}
                            </div>
                            {% endif %}
                        {% endif %}
                    </div>
                    
                    <div class="expertise">
                        {% if profile_user.role in HAS_DEGREE_EXPERTISE %}
                            <h5 class="display-mode-field">Field of Expertise:</h5>
                            <p class="display-mode-field">{{ profile_user.expertise|default:"Not specified" }}</p>
                            <div class="edit-mode-field">
                                <label for="id_expertise">Field of Expertise:</label>
                                <input type="text" name="expertise" id="id_expertise" value="{{ profile_user.expertise|default:"" }}">
                            </div>

                            {% if college_name and college_name != "N/A" %}
                            <h5 class="display-mode-field">{{ profile_user.degree|default:"Degree Not Listed" }}</h5>
                            <p class="display-mode-field">{{ college_name }}</p>
                            <div class="edit-mode-field">
                                <label for="id_degree">Degree:</label>
                                <input type="text" name="degree" id="id_degree" value="{{ profile_user.degree|default:"" }}">
                                <p style="font-size: 0.9em; color: #666;">College: {{ college_name }} (Cannot be changed here)</p>
                            </div>
                            {% endif %}
                        {% elif profile_user.role in HAS_COMPANY_INDUSTRY %}
                             <h5 class="display-mode-field">Company:</h5>
                            <p class="display-mode-field">{{ profile_user.company|default:"Not specified" }}</p>
                            <h5 class="display-mode-field">Industry:</h5>
                            <p class="display-mode-field">{{ profile_user.industry|default:"Not specified" }}</p>
                             <div class="edit-mode-field">
                                <label for="id_company">Company:</label>
                                <input type="text" name="company" id="id_company" value="{{ profile_user.company|default:"" }}">
                                <label for="id_industry">Industry:</label>
                                <input type="text" name="industry" id="id_industry" value="{{ profile_user.industry|default:"" }}">
                            </div>
                        {% else %}
                            <h5>Role:</h5>
                            <p>{{ profile_user.get_role_display }}</p>
                            {% if college_name and college_name != "N/A" %}
                            <h5>College:</h5>
                            <p>{{ college_name }}</p>
                            {% endif %}
                        {% endif %}
                    </div>

                    <div class="contact">
                        <h5 class="display-mode-field">Contact:</h5>
                        <p class="display-mode-field">{{ profile_user.email }}</p>
                        <p class="display-mode-field">{{ profile_user.contact_no|default:"" }}</p>
                        <div class="edit-mode-field">
                            <label for="id_email">Email:</label>
                            <input type="email" name="email" id="id_email" value="{{ profile_user.email }}">
                            <label for="id_contact_no">Contact No:</label>
                            <input type="tel" name="contact_no" id="id_contact_no" value="{{ profile_user.contact_no|default:"" }}">
                        </div>
                    </div>
                </div>
            </section>

            <section class="lower">
                <div class="bio">
                    <div class="lower-header">
                        <h1>Bio</h1>
                        <div class="edit-mode-controls">
                            <button type="submit" class="save-bio-btn">Save Changes</button>
                            <button type="button" class="cancel-bio-btn" onclick="toggleEditMode(false)">Cancel</button>
                        </div>
                    </div>
                    <div class="bio-content">
                        <div class="bio-display display-mode-field" style="margin-top: 1rem;">
                            <p class="bio-text">
                                {{ profile_user.bio|linebreaksbr|default:"No bio added yet." }}
                            </p>
                        </div>
                        <div class="bio-editor edit-mode-field">
                             <label for="id_bio">Bio:</label>
                             <textarea name="bio" id="id_bio">{{ profile_user.bio|default:"" }}</textarea>
                        </div>
                    </div>
                </div>

                <div class="project">
                    <div class="lower-header"> 
                        <div>
                            <h1>
                                {% if profile_user.role in "FACULTY,IMPLEMENTER" %}{% if can_edit %}My Projects{% else %}Projects{% endif %}
                                {% elif profile_user.role in "PROGRAM_HEAD,DEAN,COORDINATOR" %}College Projects 
                                {% elif profile_user.role == "CLIENT" %}{% if can_edit %}My Requests{% else %}Requests{% endif %} 
                                {% else %}Projects{% endif %}
                            </h1>   
                        </div>
                        <div style="display: flex; flex-shrink: 3; align-items: center; gap: 0.5rem;">
                            <span style="font-size: 1.1rem; font-weight: 500; color: #444; width: 6rem;">Sort by:</span>
                            <select id="sortContent" class="dropdown-btn" style="margin: 0.75rem 0;">
                                <option value="date-desc">Newest First</option>
                                <option value="date-asc">Oldest First</option>
                                <option value="title-asc">Title (A-Z)</option>
                                <option value="title-desc">Title (Z-A)</option>
                                {% if profile_user.role != "CLIENT" %}
                                <option value="status">Status</option>
                                {% endif %}
                            </select>
                        </div>
                    </div>
                    <div class="project-card" id="contentList"> 
                        </div>
                </div>
            </section>
        </main>
    </form> <script>
    const mainElement = document.querySelector('main');

    function toggleEditMode(enable) {
        if (enable) {
            mainElement.classList.add('edit-mode');
        } else {
            mainElement.classList.remove('edit-mode');
            // Reset form fields to original values on cancel
             document.getElementById('profileForm').reset(); 
             // Reset image preview if cancelled
             resetImagePreview();
        }
    }

    function previewImage(event) {
        const reader = new FileReader();
        const fileInput = event.target;
        
        reader.onload = function(){
            const outputImg = document.getElementById('profileImgEdit');
            const outputInitials = document.getElementById('profileInitialsEdit');

            // If the element for image preview exists (either img or initials div)
            const previewContainer = outputImg ? outputImg.parentNode : (outputInitials ? outputInitials.parentNode : null);
            if (!previewContainer) return; // Should not happen

            let imgElement = document.getElementById('profileImgEdit');

            // If the preview element is currently the initials div, replace it with an img tag
            if (outputInitials && !imgElement) {
                 imgElement = document.createElement('img');
                 imgElement.id = 'profileImgEdit';
                 imgElement.style.width = '100%';
                 imgElement.style.height = '100%';
                 imgElement.style.objectFit = 'cover';
                 imgElement.style.borderRadius = '50%';
                 outputInitials.parentNode.replaceChild(imgElement, outputInitials);
            }
            
            // Set the src for the img element (either existing or newly created)
            if(imgElement) {
                imgElement.src = reader.result;
            }
        };

        if (fileInput.files && fileInput.files[0]) {
            reader.readAsDataURL(fileInput.files[0]);
        }
    }

    function resetImagePreview() {
         const displayImgSrc = document.getElementById('profileImgDisplay')?.src;
         const displayInitialsHTML = document.getElementById('profileInitialsDisplay')?.innerHTML;
         
         const editPreviewContainer = document.querySelector('.edit-mode-field .propic') || document.querySelector('.propic .edit-mode-field'); // Find the container holding the preview
         const editImg = document.getElementById('profileImgEdit');
         const editInitials = document.getElementById('profileInitialsEdit'); 
         const fileInput = document.getElementById('profilePictureInput');

         if (editPreviewContainer) {
             // Clear current preview
             editPreviewContainer.innerHTML = ''; 

             // Restore based on original display state
             if (displayImgSrc) {
                 const img = document.createElement('img');
                 img.src = displayImgSrc;
                 img.alt = "{{ profile_user.get_full_name }}";
                 img.id = 'profileImgEdit';
                 img.style.width = '100%';
                 img.style.height = '100%';
                 img.style.objectFit = 'cover';
                 img.style.borderRadius = '50%';
                 editPreviewContainer.appendChild(img);
             } else if (displayInitialsHTML) {
                 const initialsDiv = document.createElement('div');
                 initialsDiv.className = 'propic-placeholder';
                 initialsDiv.id = 'profileInitialsEdit';
                 initialsDiv.style.fontSize = '6rem';
                 initialsDiv.innerHTML = displayInitialsHTML;
                 editPreviewContainer.appendChild(initialsDiv);
             }
             // Re-add the hidden file input and trigger link which might have been removed
             editPreviewContainer.insertAdjacentHTML('beforeend', `
                <input type="file" name="profile_picture" id="profilePictureInput" style="display: none;" accept="image/*" onchange="previewImage(event)">
                <a class="edit-profile-picture-trigger" onclick="document.getElementById('profilePictureInput').click();">Change Picture</a>
             `);
         }

         // Clear the file input value
         if (fileInput) {
             fileInput.value = ''; 
         }
    }


    // --- Content data and rendering (Keep this section as it was) ---
    const contentData = [
        {% if profile_user.role == "CLIENT" %}
            {% for request in content_items %} { id: {{ request.id }}, title: "{{ request.title|escapejs }}", date: "{{ request.created_at|date:'Y-m-d' }}", dateDisplay: "{{ request.created_at|date:'F j, Y' }}", status: "{{ request.status }}", type: "request" }{% if not forloop.last %},{% endif %} {% endfor %}
        {% else %}
            {% for project in content_items %} { id: {{ project.id }}, title: "{{ project.title|escapejs }}", date: "{{ project.start_date|date:'Y-m-d' }}", dateDisplay: "{{ project.start_date|date:'F j, Y' }}", status: "{{ project.status }}", leaderCampus: "{{ project.project_leader.get_campus_display|default:'N/A'|escapejs }}", agenda: "{{ project.agenda.name|default:''|escapejs }}", leaderName: "{{ project.project_leader.get_full_name|escapejs }}", leaderInitials: "{{ project.project_leader.given_name.0 }}{{ project.project_leader.last_name.0 }}", providers: [ {% for provider in project.providers.all %} { id: {{ provider.id }}, name: "{{ provider.get_full_name|escapejs }}", initials: "{{ provider.given_name.0 }}{{ provider.last_name.0 }}" }{% if not forloop.last %},{% endif %} {% endfor %} ], providersCount: {{ project.providers.count }}, type: "project" }{% if not forloop.last %},{% endif %} {% endfor %}
        {% endif %}
    ];

    function renderContent(items) { /* ... Same rendering logic as before ... */ }
    document.getElementById('sortContent').addEventListener('change', function(e) { /* ... Same sort logic as before ... */ });
    renderContent(contentData); // Initial render

    // --- Paste the full renderContent function logic here ---
    function renderContent(items) {
        const container = document.getElementById('contentList');
        if (items.length === 0) {
            {% if profile_user.role == "CLIENT" %} container.innerHTML = '<div style="padding: 1rem 3rem; color: #666; margin-top: 1rem;">{% if can_edit %}You have{% else %}This user has{% endif %} no requests yet.</div>';
            {% else %} container.innerHTML = '<div style="padding: 1rem 3rem; color: #666; margin-top: 1rem;">No projects found.</div>';
            {% endif %}
            return;
        }
        container.innerHTML = items.map(item => {
            if (item.type === 'request') {
                return `<div><h5>${item.dateDisplay}</h5><a href="/request/details/${item.id}/" class="title">${item.title}</a><section class="project-tags"><button class="status" style="color: #007bff; border-color: #007bff;">${item.status}</button></section><a href="/request/details/${item.id}/" class="view">View</a></div>`;
            } else {
                let statusTag = '';
                if (item.status === 'COMPLETED') { statusTag = '<button class="status" style="color: #1CB889; border-color: #1CB889;">Completed</button>'; }
                else if (item.status === 'IN_PROGRESS') { statusTag = '<button class="status" style="color: #007bff; border-color: #007bff;">Ongoing</button>'; }
                else if (item.status === 'NOT_STARTED') { statusTag = '<button class="status" style="color: #6c757d; border-color: #6c757d;">Not Started</button>'; }
                else if (item.status === 'ON_HOLD') { statusTag = '<button class="status" style="color: #ffc107; border-color: #ffc107;">On Hold</button>'; }
                else if (item.status === 'CANCELLED') { statusTag = '<button class="status" style="color: #dc3545; border-color: #dc3545;">Cancelled</button>'; }
                else { statusTag = `<button class="status" style="color: #6c757d; border-color: #6c757d;">${item.status}</button>`; }
                let authorsHTML = '';
                if (item.leaderName) { authorsHTML += `<content><div class="avatar-placeholder">${item.leaderInitials}</div><a href="/experts/profile/${item.id}/">${item.leaderName}</a></content>`; } // NOTE: Used item.id here for leader profile link, might need adjustment if leader ID is different
                const providersList = item.providers.slice(0, 2).map(p => `<content><div class="avatar-placeholder">${p.initials}</div><a href="/experts/profile/${p.id}/">${p.name}</a></content>`).join('');
                authorsHTML += providersList;
                const moreProviders = item.providersCount > 2 ? `<content style="align-items: center;"><a href="/projects/${item.id}/">+${item.providersCount - 2} more</a></content>` : '';
                authorsHTML += moreProviders;
                return `<div><h5>${item.dateDisplay}</h5><a href="/projects/${item.id}/" class="title">${item.title}</a><section class="project-tags"><button class="campus">${item.leaderCampus}</button>${item.agenda ? `<button class="agenda">${item.agenda}</button>` : ''}${statusTag}</section><section class="project-authors">${authorsHTML}</section><a href="/projects/${item.id}/" class="view">View</a></div>`;
            }
        }).join('');
    }
    // --- End of pasted renderContent ---

    // --- Paste the full sort logic here ---
    document.getElementById('sortContent').addEventListener('change', function(e) {
        const sortBy = e.target.value;
        let sorted = [...contentData];
        switch(sortBy) {
            case 'date-desc': sorted.sort((a, b) => new Date(b.date) - new Date(a.date)); break;
            case 'date-asc': sorted.sort((a, b) => new Date(a.date) - new Date(b.date)); break;
            case 'title-asc': sorted.sort((a, b) => a.title.localeCompare(b.title)); break;
            case 'title-desc': sorted.sort((a, b) => b.title.localeCompare(a.title)); break;
            case 'status':
                const statusOrder = {'COMPLETED': 1, 'IN_PROGRESS': 2, 'NOT_STARTED': 3, 'ON_HOLD': 4, 'CANCELLED': 5};
                // Ensure requests (which might not have standard status) are handled, e.g., put them last
                sorted.sort((a, b) => {
                     const aOrder = a.type === 'project' ? (statusOrder[a.status] || 99) : 100;
                     const bOrder = b.type === 'project' ? (statusOrder[b.status] || 99) : 100;
                     return aOrder - bOrder;
                });
                break;
        }
        renderContent(sorted);
    });
    // --- End of pasted sort logic ---

</script>

</body>
</html>

{% endblock %}