{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Forgot Password</title>
    <link href="https://fonts.googleapis.com/css2?family=Instrument+Sans:wght@500&family=Inter:wght@200;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer">
    <link href="{% static 'users/login_styles.css' %}" rel="stylesheet">
</head>
<body>
    <!-- Code Display Modal (Testing - Top Left) -->
    <div id="reset-code-modal" style="display:none; position:fixed; top:20px; left:20px; background:white; padding:1.5rem; border-radius:8px; box-shadow:0 4px 12px rgba(0,0,0,0.15); z-index:2000; min-width:280px; border-left:4px solid #0099FF;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem;">
            <h4 style="margin:0; font-size:0.875rem; font-weight:600; color:#2D3748;">Reset Code (Testing)</h4>
            <button onclick="closeResetCodeModal()" style="background:none; border:none; cursor:pointer; color:#A0AEC0; font-size:1.25rem; padding:0; line-height:1;">&times;</button>
        </div>
        <div style="background:#F7FAFC; padding:1rem; border-radius:6px; margin-bottom:1rem; text-align:center;">
            <div style="font-size:0.75rem; color:#718096; margin-bottom:0.25rem;">Your Code:</div>
            <div id="reset-code-value" style="font-size:2rem; font-weight:700; color:#0099FF; letter-spacing:0.5rem; font-family:monospace;"></div>
        </div>
        <button onclick="copyResetCode()" id="copy-reset-code-btn" style="width:100%; background:#0099FF; color:white; padding:0.75rem; border:none; border-radius:6px; cursor:pointer; font-size:0.875rem; font-weight:600; transition:all 0.2s;">
            <i class="fa-solid fa-copy" style="margin-right:0.5rem;"></i>
            <span id="copy-reset-btn-text">Copy Code</span>
        </button>
    </div>

    <!-- Step 1: Enter Email -->
    <div class="sign-in-container" id="reset-step-1">
        <a href="/home/" class="logo-container">
            <img src="{% static 'ueso.png' %}" class="logo-icon" alt="UESO Logo">
            <div class="logo-text">University Extension<br>Services Office</div>
        </a>
        <div class="center-container">
            <div class="text-container">
                <div class="welcome-text">Forgot Password</div>
                <div class="psu-text">Input your email to reset your password.</div>
            </div>
            <form id="forgot-password-form" style="width:100%;">
                {% csrf_token %}
                <div class="fillbox-container">
                    <div class="fillbox-label">Email</div>
                    <div class="fillbox-field">
                        <i class="far fa-envelope icon"></i> 
                        <input type="email" name="email" id="reset-email" required placeholder="Enter your email address">
                    </div>
                </div>
                <div id="email-error" style="color:#E53E3E; font-size:0.875rem; margin-top:0.5rem; display:none;"></div>
                <button type="submit" class="sign-in-button">Send Reset Code</button>
            </form>
        </div>
        <div class="back-container">
            <a href="/login/" class="back-btn">
                <svg width="18" height="19" viewBox="0 0 18 19" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <use xlink:href="#icon-arrow-left" />
                </svg>
                <span class="back-btn-text">Back to Login</span>
            </a>
        </div>
    </div>

    <!-- Step 2: Verify Code -->
    <div class="sign-in-container" id="reset-step-2" style="display:none;">
        <a href="/home/" class="logo-container">
            <img src="{% static 'ueso.png' %}" class="logo-icon" alt="UESO Logo">
            <div class="logo-text">University Extension<br>Services Office</div>
        </a>
        <div class="center-container">
            <div class="text-container">
                <div class="welcome-text">Verify Your Code</div>
                <div class="psu-text">Enter the 6-digit code sent to your email</div>
            </div>
            <form id="verify-reset-code-form" style="width:100%;">
                {% csrf_token %}
                <div class="fillbox-container">
                    <div class="fillbox-label">Verification Code</div>
                    <div class="fillbox-field">
                        <input type="text" name="code" id="reset_code" maxlength="6" placeholder="000000" required style="width:100%; border:none; outline:none; text-align:center; font-size:1.5rem; letter-spacing:0.5rem; font-weight:600; font-family:monospace;padding:0.75rem;">
                    </div>
                    <p style="font-size:0.875rem; color:#718096; margin-top:0.5rem; text-align:center;">
                        Didn't receive the code? <a href="#" id="resend-reset-code" style="color:#0099FF; text-decoration:underline;">Resend Code</a>
                    </p>
                </div>
                <div id="code-error" style="color:#E53E3E; font-size:0.875rem; margin-top:0.5rem; display:none;"></div>
                <button type="submit" class="sign-in-button">Verify Code</button>
            </form>
        </div>
        <div class="back-container">
            <a href="/login/" class="back-btn">
                <svg width="18" height="19" viewBox="0 0 18 19" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <use xlink:href="#icon-arrow-left" />
                </svg>
                <span class="back-btn-text">Back to Login</span>
            </a>
        </div>
    </div>

    <!-- Step 3: Set New Password -->
    <div class="sign-in-container" id="reset-step-3" style="display:none;">
        <a href="/home/" class="logo-container">
            <img src="{% static 'ueso.png' %}" class="logo-icon" alt="UESO Logo">
            <div class="logo-text">University Extension<br>Services Office</div>
        </a>
        <div class="center-container">
            <div class="text-container">
                <div class="welcome-text">Set New Password</div>
                <div class="psu-text">Create a strong password for your account</div>
            </div>
            <form id="reset-password-form" style="width:100%;">
                {% csrf_token %}
                <div class="fillbox-container">
                    <div class="fillbox-label">New Password</div>
                    <div class="fillbox-field">
                        <i class="fas fa-lock icon"></i> 
                        <input type="password" name="new_password" id="new_password" required placeholder="Enter new password">
                    </div>
                    <div class="fillbox-label">Confirm New Password</div>
                    <div class="fillbox-field">
                        <i class="fas fa-lock icon"></i> 
                        <input type="password" name="confirm_password" id="confirm_password" required placeholder="Confirm new password">
                    </div>
                </div>
                <div id="reset-error" style="color:#E53E3E; font-size:0.875rem; margin-top:0.5rem; display:none;"></div>
                <button type="submit" class="sign-in-button">Reset Password</button>
            </form>
        </div>
        <div class="back-container">
            <a href="/login/" class="back-btn">
                <svg width="18" height="19" viewBox="0 0 18 19" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <use xlink:href="#icon-arrow-left" />
                </svg>
                <span class="back-btn-text">Back to Login</span>
            </a>
        </div>
    </div>

    <!-- Step 4: Success Message -->
    <div class="sign-in-container" id="reset-step-4" style="display:none;">
        <a href="/home/" class="logo-container">
            <img src="{% static 'ueso.png' %}" class="logo-icon" alt="UESO Logo">
            <div class="logo-text">University Extension<br>Services Office</div>
        </a>
        <div class="center-container">
            <div class="text-container" style="text-align:center;">
                <div style="display:inline-flex; align-items:center; justify-content:center; width:80px; height:80px; background:#E6F7FF; border-radius:50%; margin:0 auto 1.5rem;">
                    <i class="fa-solid fa-check" style="font-size:2.5rem; color:#0099FF;"></i>
                </div>
                <div class="welcome-text">Password Reset Successful!</div>
                <div class="psu-text">You can now log in with your new password.</div>
            </div>
            <a href="/login/" class="sign-in-button" style="display:block; text-align:center; text-decoration:none; margin-top:2rem;">Go to Login</a>
        </div>
    </div>

<svg style="display: none;">
    <symbol id="icon-arrow-left" viewBox="0 0 18 19">
        <path d="M4.60755 10.4L10.7675 16.56L9.20005 18.1L0.400047 9.3L9.20005 0.5L10.7675 2.04L4.60755 8.2H18V10.4H4.60755Z" fill="#0099FF"/>
    </symbol>
</svg>

<script>
    // Reset Code Modal Functions
    function showResetCodeModal(code) {
        document.getElementById('reset-code-value').textContent = code;
        document.getElementById('reset-code-modal').style.display = 'block';
        setTimeout(() => closeResetCodeModal(), 30000);
    }

    function closeResetCodeModal() {
        document.getElementById('reset-code-modal').style.display = 'none';
    }

    function copyResetCode() {
        const code = document.getElementById('reset-code-value').textContent;
        navigator.clipboard.writeText(code).then(() => {
            const btn = document.getElementById('copy-reset-code-btn');
            const btnText = document.getElementById('copy-reset-btn-text');
            btnText.textContent = 'Copied!';
            btn.style.background = '#48BB78';
            setTimeout(() => {
                btnText.textContent = 'Copy Code';
                btn.style.background = '#0099FF';
            }, 2000);
        });
    }

    // Store email globally for resend functionality
    let currentResetEmail = '';

    // Step 1: Send Reset Code
    document.getElementById('forgot-password-form').addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = new FormData(this);
        const errorDiv = document.getElementById('email-error');
        currentResetEmail = document.getElementById('reset-email').value;

        fetch('/send-password-reset-code/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            },
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Show step 2 (verify code)
                document.getElementById('reset-step-1').style.display = 'none';
                document.getElementById('reset-step-2').style.display = 'block';
                // Show code modal for testing
                if (data.code) {
                    showResetCodeModal(data.code);
                }
            } else {
                errorDiv.textContent = data.error || 'Failed to send reset code.';
                errorDiv.style.display = 'block';
            }
        })
        .catch(error => {
            errorDiv.textContent = 'An error occurred. Please try again.';
            errorDiv.style.display = 'block';
        });
    });

    // Resend code functionality
    document.getElementById('resend-reset-code').addEventListener('click', function(e) {
        e.preventDefault();
        const formData = new FormData();
        formData.append('email', currentResetEmail);

        fetch('/send-password-reset-code/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            },
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success && data.code) {
                showResetCodeModal(data.code);
            }
        });
    });

    // Step 2: Verify Code
    document.getElementById('verify-reset-code-form').addEventListener('submit', function(e) {
        e.preventDefault();
        const code = document.getElementById('reset_code').value.trim();
        const errorDiv = document.getElementById('code-error');

        if (!code || code.length !== 6) {
            errorDiv.textContent = 'Please enter a valid 6-digit code.';
            errorDiv.style.display = 'block';
            return;
        }

        // Store code in session by making a simple verification request
        const formData = new FormData();
        formData.append('code', code);
        formData.append('verify_only', 'true');

        fetch('/verify-reset-code/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            },
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Move to step 3 (set new password)
                document.getElementById('reset-step-2').style.display = 'none';
                document.getElementById('reset-step-3').style.display = 'block';
                closeResetCodeModal();
            } else {
                errorDiv.textContent = data.error || 'Invalid verification code.';
                errorDiv.style.display = 'block';
            }
        })
        .catch(error => {
            errorDiv.textContent = 'An error occurred. Please try again.';
            errorDiv.style.display = 'block';
        });
    });

    // Step 3: Reset Password
    document.getElementById('reset-password-form').addEventListener('submit', function(e) {
        e.preventDefault();
        const errorDiv = document.getElementById('reset-error');
        const newPassword = document.getElementById('new_password').value;
        const confirmPassword = document.getElementById('confirm_password').value;

        // Check password match
        if (newPassword !== confirmPassword) {
            errorDiv.textContent = 'Passwords do not match.';
            errorDiv.style.display = 'block';
            return;
        }

        const formData = new FormData(this);

        fetch('/reset-password/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            },
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Show success step
                document.getElementById('reset-step-3').style.display = 'none';
                document.getElementById('reset-step-4').style.display = 'block';
            } else {
                errorDiv.textContent = data.error || 'Failed to reset password.';
                errorDiv.style.display = 'block';
            }
        })
        .catch(error => {
            errorDiv.textContent = 'An error occurred. Please try again.';
            errorDiv.style.display = 'block';
        });
    });
</script>

</body>
</html>
