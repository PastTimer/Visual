{% extends "base_internal.html" %}
{% block content %}

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Add Project</title>

<link href="https://fonts.googleapis.com/css?family=Inter:400,500,700&display=swap" rel="stylesheet">

<style>
    .success-message {
		color: green; 
		margin-bottom: 1rem;
	}

    .error-input {
        border-color: #E53E3E !important;
        background: #FFF5F5 !important;
    }

    .error-select {
        border-color: #E53E3E !important;
        background: 
            #FFF5F5 /* background color */
            url("data:image/svg+xml;utf8,<svg width='16' height='11' viewBox='0 0 16 11' fill='none' xmlns='http://www.w3.org/2000/svg'><path d='M7.99976 7.19417L13.9025 1.29147C14.0125 1.17758 14.144 1.08674 14.2895 1.02424C14.435 0.961746 14.5915 0.92885 14.7498 0.927474C14.9082 0.926098 15.0652 0.95627 15.2117 1.01623C15.3583 1.07619 15.4914 1.16473 15.6034 1.27669C15.7153 1.38866 15.8039 1.5218 15.8638 1.66835C15.9238 1.8149 15.954 1.97192 15.9526 2.13026C15.9512 2.28859 15.9183 2.44506 15.8558 2.59055C15.7933 2.73604 15.7025 2.86762 15.5886 2.97762L8.84283 9.72339C8.61921 9.94694 8.31596 10.0725 7.99976 10.0725C7.68356 10.0725 7.38031 9.94694 7.15669 9.72339L0.41092 2.97762C0.297028 2.86762 0.206183 2.73604 0.143687 2.59055C0.0811915 2.44506 0.0482959 2.28859 0.04692 2.13026C0.0455441 1.97192 0.0757155 1.8149 0.135674 1.66835C0.195632 1.5218 0.284176 1.38866 0.39614 1.27669C0.508103 1.16473 0.641244 1.07619 0.787794 1.01623C0.934343 0.95627 1.09137 0.926098 1.2497 0.927474C1.40804 0.92885 1.56451 0.961746 1.71 1.02424C1.85548 1.08674 1.98706 1.17758 2.09706 1.29147L7.99976 7.19417Z' fill='%23374151'/></svg>") 
            no-repeat right 0.75rem center !important;
    }


    body {
        background: #F9F9F9;
        margin: 0;
        font-family: 'Inter', Arial, sans-serif;
    }

    input, select, textarea {
        font-family: 'Inter', Arial, sans-serif;
        font-weight: 400;
    }

    .user-details-container {
        margin: 60px;
        display: flex;
        flex-direction: column;
        gap: 32px;
    }

    .user-details-title {
        font-size: 32px;
        font-weight: 400;
        color: #000;
        font-family: 'Inter', Arial, sans-serif;
    }

    .user-details-section {
        padding-bottom: 16px;
        border-bottom: 1px solid #E5E7EB;
    }

    .user-details-grid {
        display: grid;
        gap: 20px;
    }

    .user-details-row {
        display: grid;
        gap: 20px;
    }

    .user-details-row.cols-4 {
        grid-template-columns: repeat(4, 1fr);
    }
    
    .user-details-row.cols-3 {
        grid-template-columns: repeat(3, 1fr);
    }

    .user-details-row.cols-2 {
        grid-template-columns: repeat(2, 1fr);
    }
    
    .user-details-category {
        font-size: 1.15rem;
        font-weight: 700;
        color: #000;
    }

    .user-details-label {
        font-weight: 500;
        color: #374151;
        font-size: 1.08rem;
        margin-bottom: 0.25rem;
        margin-top: 1rem;
    }

    .user-details-value {
        font-weight: 500;
        color: #374151;
        font-size: 1.08rem;
        word-break: break-word;
        background: #f7f7f7;
        border-radius: 0.5rem;
        padding: 8px 14px;
        border: 1px solid #e5e7eb;
        min-height: 21px;
        display: block;
        width: 100%;
        box-sizing: border-box;
    }

    select.user-details-value {
		appearance: none;
		-webkit-appearance: none;
		-moz-appearance: none;
		padding-right: 2rem;
		background: url("data:image/svg+xml;utf8,<svg width='16' height='11' viewBox='0 0 16 11' fill='none' xmlns='http://www.w3.org/2000/svg'><path d='M7.99976 7.19417L13.9025 1.29147C14.0125 1.17758 14.144 1.08674 14.2895 1.02424C14.435 0.961746 14.5915 0.92885 14.7498 0.927474C14.9082 0.926098 15.0652 0.95627 15.2117 1.01623C15.3583 1.07619 15.4914 1.16473 15.6034 1.27669C15.7153 1.38866 15.8039 1.5218 15.8638 1.66835C15.9238 1.8149 15.954 1.97192 15.9526 2.13026C15.9512 2.28859 15.9183 2.44506 15.8558 2.59055C15.7933 2.73604 15.7025 2.86762 15.5886 2.97762L8.84283 9.72339C8.61921 9.94694 8.31596 10.0725 7.99976 10.0725C7.68356 10.0725 7.38031 9.94694 7.15669 9.72339L0.41092 2.97762C0.297028 2.86762 0.206183 2.73604 0.143687 2.59055C0.0811915 2.44506 0.0482959 2.28859 0.04692 2.13026C0.0455441 1.97192 0.0757155 1.8149 0.135674 1.66835C0.195632 1.5218 0.284176 1.38866 0.39614 1.27669C0.508103 1.16473 0.641244 1.07619 0.787794 1.01623C0.934343 0.95627 1.09137 0.926098 1.2497 0.927474C1.40804 0.92885 1.56451 0.961746 1.71 1.02424C1.85548 1.08674 1.98706 1.17758 2.09706 1.29147L7.99976 7.19417Z' fill='%23374151'/></svg>")
        		no-repeat right 0.75rem center;
  		background-size: 13px 8px;
    }

    .user-details-picture {
        width: 80px;
        height: 80px;
        border: 2px solid #000;
        object-fit: cover;
        margin-left: 12px;
    }

	.form-actions {
		display: flex;
		gap: 1rem;
		justify-content: flex-end;
	}

    .btn {
		padding: 0.75rem 1.5rem;
		border: none;
		border-radius: 8px;
		font-size: 1rem;
		font-weight: 600;
		cursor: pointer;
		transition: all 0.2s ease;
		font-family: 'Inter', sans-serif;
        text-decoration: none;
    }

    .back {
		background: #6B7280;
		color: white;
    }

    .back:hover {
		background: #4B5563;
		transform: translateY(-1px);
    }

    .save {
		background: #0A6C44;
		color: white;
    }

    .save:hover {
		background: #1f7c57;
		transform: translateY(-1px);
    }

    span.required {
        color: #e53e3e;
    }

    .error-message {
        color: #e53e3e;
        font-size: 0.9rem;
        margin-top: -0.5rem;
        margin-bottom: 0.5rem;
    }
</style>

<!-- File Upload -->
<style>
    .form-group {
        margin-top: 1rem;
        margin-bottom: 1rem;
		display: flex;
		align-items: flex-start;
		gap: 1rem;
	}

	.form-label {
		font-weight: 600;
		color: #374151;
		padding-top: 0.75rem;
		font-size: 0.95rem;
	}

	.upload-area {
        flex: 1;
		border: 2px dashed #E5E7EB;
		border-radius: 8px;
		padding: 2rem;
		text-align: center;
		background: #F9F9F9;
		cursor: pointer;
		transition: all 0.2s ease;
		display: flex;
		flex-direction: column;
		align-items: center;
		gap: 0.5rem;
	}

    .upload-area:hover {
        border-color: #0A6C44;
        background: #F0FDF4;
    }

    .upload-icon {
        width: 24px;
        height: 24px;
        color: #4B5563;
    }

    .upload-text {
        color: #4B5563;
        font-size: 0.95rem;
    }

    .file-preview {
        padding: 1rem;
        background: #F0FDF4;
        border: 1px solid #BBF7D0;
        border-radius: 8px;
        display: none;
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 15px;
    }

    .file-info {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        color: #1f7c57;
        font-size: 0.95rem;
        flex: 1;
    }

    .remove-x {
        color: #E53E3E;
        font-weight: 400;
        font-size: 1.1rem;
        margin-left: auto;
        cursor: pointer;
        border: none;
        background: none;
        padding: 0 6px;
        align-self: center;
    }
</style>

<!-- Bordered Box -->
<style>
    .college-tag {
        background: #F8F8F8;
        border: 1px solid #000;
        border-radius: 5px;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.35rem 0.85rem 0.35rem 0.5rem;
        font-size: 0.95rem;
        font-family: 'Inter', Arial, sans-serif;
        vertical-align: middle;
    }
    
    .college-tag .remove-x {
        color: #E53E3E;
        font-weight: bold;
        font-size: 1.1rem;
        margin-left: 3px;
        margin-right: 1px;
        cursor: pointer;
        border: none;
        background: none;
        padding: 0;
    }

    .add-college-btn {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        background: #F0F0F0;
        border: 1px solid rgba(0,0,0,0.16);
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: box-shadow 0.2s;
        font-family: 'Inter', Arial, sans-serif;
    }

    .add-college-btn:hover {
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }

    .college-select-modal {
        display: none;
        position: absolute;
        z-index: 1000;
        background: white;
        border: 1px solid #E5E7EB;
        border-radius: 8px;
        box-shadow: 0 4px 16px rgba(0,0,0,0.08);
        padding: 1rem;
    }

    .college-row {
        display: flex;
        align-items: center;
        flex-wrap: wrap;
        position: relative;
        gap: 10px;
        margin-bottom: 15px;
        margin-top: 5px;
    }

    #project-leader-tag-row-dropdown, #providers-tag-row-dropdown, #sdgs-tag-row-dropdown {
        font-family: 'Inter', Arial, sans-serif;
        font-size: 13px;
        padding: 8px 30px 8px 16px;
        border-radius: 6px;
        appearance: none;
        -webkit-appearance: none;
        -moz-appearance: none;
        background: white url('data:image/svg+xml;utf8,<svg fill="none" height="16" viewBox="0 0 16 16" width="16" xmlns="http://www.w3.org/2000/svg"><path d="M4 6L8 10L12 6" stroke="%23374151" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>') no-repeat right 18px center/16px 16px;
        padding-right: 30px !important;
    }
</style>

</head>

<body>
<form method="post" enctype="multipart/form-data" id="addProjectForm">
    {% csrf_token %}
    <div class="user-details-container">
        <div class="user-details-title" style="display:flex;flex-direction:column;gap:8px;">
            <div style="display:flex;justify-content:space-between;align-items:center;">
                <span>Add Project</span>
            </div>
        </div>

        {% if success %}
        <div id="add-success-msg" class="success-message">Project added successfully.</div>
        {% endif %}

        <div class="user-details-section">
            <div class="user-details-category">Project Profile</div>
            <div class="user-details-row cols-1">
                <div>
                    <div class="user-details-label">Title <span class="required">*</span></div>
                    <input type="text" name="title" class="user-details-value">
                </div>
            </div>

            <div class="user-details-row cols-2">
                <div>
                    <div class="user-details-label">Project Leader <span class="required">*</span></div>
                    <div id="project-leader-tag-row" class="college-row"></div>
                    <select id="project-leader-options-template" style="display:none;">
                        <option value="">Select Leader</option>
                        {% for user in faculty_users %}
                        <option value="{{ user.id }}">{{ user.get_full_name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div>
                    <div class="user-details-label">Provider/s (Members)</div>
                    <div id="providers-tag-row" class="college-row"></div>
                    <select id="providers-options-template" style="display:none;" multiple>
                        <option value="">Select Provider</option>
                        {% for user in provider_users %}
                        <option value="{{ user.id }}">{{ user.get_full_name }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <div class="user-details-row cols-2">
                <div>
                    <div class="user-details-label">Agenda <span class="required">*</span></div>
                    <select name="agenda" class="user-details-value">
                        <option value="" selected disabled>Select Agenda</option>
                        {% for agenda in agendas %}
                        <option value="{{ agenda }}">{{ agenda }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div>
                    <div class="user-details-label">Project Type <span class="required">*</span></div>
                    <select name="project_type" class="user-details-value">
                        <option value="" selected disabled>Select Type</option>
                        <option value="NEEDS_BASED">Needs Based</option>
                        <option value="RESEARCH_BASED">Research Based</option>
                    </select>
                </div>
            </div>

            <div class="user-details-row cols-1">
                <div>
                    <div class="user-details-label">Sustainable Development Goals <span class="required">*</span></div>
                    <div id="sdgs-tag-row" class="college-row"></div>
                    <select id="sdgs-options-template" style="display:none;" multiple>
                        <option value="">Select SDG</option>
                        {% for sdg in sdgs %}
                        <option value="{{ sdg.id }}">{{ sdg.name }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
        </div>

        <div class="user-details-section">
            <div class="user-details-category">Beneficiary</div>
            <div class="user-details-row cols-2">
                <div>
                    <div class="user-details-label">Primary Beneficiary <span class="required">*</span></div>
                    <input type="text" name="primary_beneficiary" class="user-details-value">
                </div>
                <div>
                    <div class="user-details-label">No. of Estimated Events <span class="required">*</span></div>
                    <input type="number" name="estimated_events" class="user-details-value" min="0">
                </div>
            </div>

            <div class="user-details-row cols-2">
                <div>
                    <div class="user-details-label">Primary Location <span class="required">*</span></div>
                    <input type="text" name="primary_location" class="user-details-value">
                </div>
                <div>
                    <div class="user-details-label">No. of Estimated Trainees <span class="required">*</span></div>
                    <input type="number" name="estimated_trainees" class="user-details-value" min="0">
                </div>
            </div>
        </div>

        <div class="user-details-section">
            <div class="user-details-category">Logistics</div>

            <!-- Logistics Type -->
            <div class="user-details-row cols-1">
                <div>
                    <div class="user-details-label">Type <span class="required">*</span></div>
                    <select name="logistics_type" class="user-details-value">
                        <option value="BOTH">Both</option>
                        <option value="INTERNAL">Internal</option>
                        <option value="EXTERNAL">External</option>
                    </select>
                </div>
            </div>

            <!-- BOTH -->
            <div id="logistics-both" {% if logistics_type == 'BOTH' %}style="display:block;"{% else %}style="display:none;"{% endif %}>
                <div class="user-details-row cols-2">
                    <div>
                        <div class="user-details-label">Internal Budget Assigned <span class="required">*</span></div>
                        <input type="number" name="internal_budget" class="user-details-value" min="0" step="0.01">
                    </div>
                    <div>
                        <div class="user-details-label">External Budget Assigned <span class="required">*</span></div>
                        <input type="number" name="external_budget" class="user-details-value" min="0" step="0.01">
                    </div>
                </div>

                <div class="user-details-row cols-1">
                    <div>
                        <div class="user-details-label">Sponsor Name <span class="required">*</span></div>
                        <input type="text" name="sponsor_name" class="user-details-value">
                    </div>
                </div>
            </div>

            <!-- Internal -->
            <div id="logistics-internal" {% if project.logistics_type == 'INTERNAL' %}style="display:block;"{% else %}style="display:none;"{% endif %}>
                <div class="user-details-row cols-2">
                    <div>
                        <div class="user-details-label">Internal Budget Assigned <span class="required">*</span></div>
                        <input type="number" name="internal_budget" class="user-details-value" min="0" step="0.01">
                    </div>
                    <div></div>
                </div>
            </div>

            <!-- External -->
            <div id="logistics-external" {% if project.logistics_type == 'EXTERNAL' %}style="display:block;"{% else %}style="display:none;"{% endif %}>
                <div class="user-details-row cols-2">
                    <div>
                        <div class="user-details-label">External Budget Assigned <span class="required">*</span></div>
                        <input type="number" name="external_budget" class="user-details-value" min="0" step="0.01">
                    </div>
                    <div>
                        <div class="user-details-label">Sponsor Name <span class="required">*</span></div>
                        <input type="text" name="sponsor_name" class="user-details-value">
                    </div>
                </div>
            </div>

            <!-- Date and Document Upload -->
            <div class="user-details-row cols-2">
                <div>
                    <div class="user-details-label">Start Date <span class="required">*</span></div>
                    <input type="date" name="start_date" class="user-details-value">
                </div>
                <div>
                    <div class="user-details-label">Estimated End Date <span class="required">*</span></div>
                    <input type="date" name="estimated_end_date" class="user-details-value">
                </div>
            </div>

            <div class="user-details-row cols-2">
                <div>
                    <div class="form-group">
                        <div class="user-details-label">Proposal Document <span class="required">*</span></div>
                        <div class="upload-area" onclick="document.getElementById('id_proposal_document').click()">
                            <svg class="upload-icon"><use href="#icon-upload"></use></svg>
                            <span class="upload-text">Click to upload</span>
                            <input class="file-input" type="file" name="proposal_file" id="id_proposal_file" style="display:none;" accept="application/pdf,application/msword,application/vnd.openxmlformats-officedocument.wordprocessingml.document">
                        </div>
                    </div>
                    <div class="file-preview" id="proposal-file-preview" style="display:none;">
                        <div class="file-info" style="flex:1;">
                            <svg width="16" height="16"><use href="#icon-upload"></use></svg>
                            <span id="proposal-file-name"></span>
                        </div>
                        <button type="button" id="remove-proposal-file" class="remove-x">✕</button>
                    </div>
                </div>
                <div>
                    <div class="form-group">
                        <div class="user-details-label">Additional Documents <span class="required">*</span></div>
                        <div class="upload-area" onclick="document.getElementById('id_additional_documents').click()">
                            <svg class="upload-icon"><use href="#icon-upload"></use></svg>
                            <span class="upload-text">Click to upload</span>
                            <input class="file-input" type="file" name="additional_documents" id="id_additional_documents" style="display:none;" multiple accept="*/*">
                        </div>
                    </div>
                    <div id="additional-files-list"></div>
                </div>
            </div>
        </div>

        <div class="form-actions">
            <a href="{% url 'project_dispatcher' %}" class="back btn">Back</a>
            <button type="submit" class="save btn">Add Project</button>
        </div>
    </div>
</form>


<!-- SVG Sprite Section -->
<svg style="display:none;" xmlns="http://www.w3.org/2000/svg">

    <!-- Add Icon -->
    <symbol id="icon-add" viewBox="0 0 16 16">
        <path d="M6.80039 14.4004C6.80039 14.7187 6.92682 15.0239 7.15186 15.2489C7.37691 15.474 7.68213 15.6004 8.00039 15.6004C8.31865 15.6004 8.62388 15.474 8.84892 15.2489C9.07396 15.0239 9.20039 14.7187 9.20039 14.4004V9.20039H14.4004C14.7187 9.20039 15.0239 9.07396 15.2489 8.84892C15.474 8.62388 15.6004 8.31865 15.6004 8.00039C15.6004 7.68213 15.474 7.37691 15.2489 7.15186C15.0239 6.92682 14.7187 6.80039 14.4004 6.80039H9.20039V1.60039C9.20039 1.28213 9.07396 0.976906 8.84892 0.751863C8.62388 0.526819 8.31865 0.400391 8.00039 0.400391C7.68213 0.400391 7.37691 0.526819 7.15186 0.751863C6.92682 0.976906 6.80039 1.28213 6.80039 1.60039V6.80039H1.60039C1.28213 6.80039 0.976906 6.92682 0.751863 7.15186C0.526819 7.37691 0.400391 7.68213 0.400391 8.00039C0.400391 8.31865 0.526819 8.62388 0.751863 8.84892C0.976906 9.07396 1.28213 9.20039 1.60039 9.20039H6.80039V14.4004Z" fill="black"/>
    </symbol>

    <!-- Edit Icon -->
    <symbol id="icon-edit" viewBox="0 0 18 18" fill="none" xmlns="http://www.w3.org/2000/svg">
    <path d="M2 16H3.425L13.2 6.225L11.775 4.8L2 14.575V16ZM1 18C0.716667 18 0.479333 17.904 0.288 17.712C0.0966668 17.52 0.000666667 17.2827 0 17V14.575C0 14.3083 0.0500001 14.054 0.15 13.812C0.25 13.57 0.391667 13.3577 0.575 13.175L13.2 0.575C13.4 0.391667 13.621 0.25 13.863 0.15C14.105 0.0500001 14.359 0 14.625 0C14.891 0 15.1493 0.0500001 15.4 0.15C15.6507 0.25 15.8673 0.4 16.05 0.6L17.425 2C17.625 2.18333 17.7707 2.4 17.862 2.65C17.9533 2.9 17.9993 3.15 18 3.4C18 3.66667 17.954 3.921 17.862 4.163C17.77 4.405 17.6243 4.62567 17.425 4.825L4.825 17.425C4.64167 17.6083 4.429 17.75 4.187 17.85C3.945 17.95 3.691 18 3.425 18H1ZM12.475 5.525L11.775 4.8L13.2 6.225L12.475 5.525Z" fill="black"/>
    </symbol>

    <!-- Upload Icon -->
    <symbol id="icon-upload" viewBox="0 0 24 24" fill="currentColor">
        <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z" />
        <path d="M12,11L8,15H16L12,11Z" />
    </symbol>

</svg>


<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Global error catcher for form submission
        var form = document.getElementById('addProjectForm');
        if (form) {
            form.addEventListener('submit', function(e) {
                // Remove previous error states and messages
                let valid = true;
                // Remove all previous error states/messages for inputs, selects, textareas
                const fields = Array.from(form.querySelectorAll('input, select, textarea'));
                fields.forEach(field => {
                    field.classList.remove('error-input');
                    let err = field.parentNode.querySelector('.field-error');
                    if (err) err.remove();
                });
                // Remove custom errors for tag UIs and files
                function removeError(tagRow, errorId) {
                    let err = document.getElementById(errorId);
                    if (err) err.remove();
                    if (tagRow) tagRow.classList.remove('error-input');
                }
                removeError(document.getElementById('project-leader-tag-row'), 'leader-error');
                removeError(document.getElementById('sdgs-tag-row'), 'sdgs-error');
                removeError(document.getElementById('id_proposal_document'), 'proposal-error');
                removeError(document.getElementById('id_additional_documents'), 'additional-error');

                // Validate all required fields except providers and logistics-dependent
                // For logistics-dependent, only validate if visible
                fields.forEach(field => {
                    if (field.name === 'providers' || field.name === 'providers[]') return;
                    // Only validate visible fields
                    if (field.offsetParent === null) return;
                    // Validate required fields
                    if ((field.tagName === 'INPUT' || field.tagName === 'TEXTAREA') && !field.value.trim()) {
                        valid = false;
                        field.classList.add('error-input');
                        let err = document.createElement('div');
                        err.className = 'field-error';
                        err.textContent = 'This field is required.';
                        err.style.color = '#E53E3E';
                        err.style.fontSize = '0.95rem';
                        err.style.marginTop = '0.25rem';
                        field.parentNode.appendChild(err);
                    }
                    if (field.tagName === 'SELECT' && (!field.value || field.value === '' || field.value === field.querySelector('option[disabled]')?.value)) {
                        valid = false;
                        field.classList.add('error-select');
                        let err = document.createElement('div');
                        err.className = 'field-error';
                        err.textContent = 'This field is required.';
                        err.style.color = '#E53E3E';
                        err.style.fontSize = '0.95rem';
                        err.style.marginTop = '0.25rem';
                        field.parentNode.appendChild(err);
                    }
                });

                // Validate Project Leader
                var leaderTagRow = document.getElementById('project-leader-tag-row');
                var leaderSelected = leaderTagRow && leaderTagRow.querySelectorAll('.college-tag').length > 0;
                if (!leaderSelected) {
                    valid = false;
                    leaderTagRow.classList.add('error-input');
                    let err = document.createElement('div');
                    err.id = 'leader-error';
                    err.textContent = 'Project Leader is required.';
                    err.style.color = '#E53E3E';
                    err.style.fontSize = '0.95rem';
                    err.style.marginTop = '0.25rem';
                    leaderTagRow.appendChild(err);
                }

                // Validate SDGs
                var sdgsTagRow = document.getElementById('sdgs-tag-row');
                var sdgsSelected = sdgsTagRow && sdgsTagRow.querySelectorAll('.college-tag').length > 0;
                if (!sdgsSelected) {
                    valid = false;
                    sdgsTagRow.classList.add('error-input');
                    let err = document.createElement('div');
                    err.id = 'sdgs-error';
                    err.textContent = 'At least one SDG is required.';
                    err.style.color = '#E53E3E';
                    err.style.fontSize = '0.95rem';
                    err.style.marginTop = '0.25rem';
                    sdgsTagRow.appendChild(err);
                }

                // Validate Proposal Document
                var proposalInput = document.getElementById('id_proposal_document');
                var proposalSelected = proposalInput && proposalInput.files && proposalInput.files.length > 0;
                if (!proposalSelected) {
                    valid = false;
                    proposalInput.classList.add('error-input');
                    let err = document.createElement('div');
                    err.id = 'proposal-error';
                    err.textContent = 'Proposal Document is required.';
                    err.style.color = '#E53E3E';
                    err.style.fontSize = '0.95rem';
                    err.style.marginTop = '0.25rem';
                    proposalInput.parentNode.appendChild(err);
                }

                // Validate Additional Documents
                var additionalInput = document.getElementById('id_additional_documents');
                var additionalSelected = additionalInput && typeof additionalFiles !== 'undefined' && additionalFiles.length > 0;
                if (!additionalSelected) {
                    valid = false;
                    additionalInput.classList.add('error-input');
                    let err = document.createElement('div');
                    err.id = 'additional-error';
                    err.textContent = 'At least one Additional Document is required.';
                    err.style.color = '#E53E3E';
                    err.style.fontSize = '0.95rem';
                    err.style.marginTop = '0.25rem';
                    additionalInput.parentNode.appendChild(err);
                }

                // Providers is optional, so no error for that

                if (!valid) {
                    e.preventDefault();
                    return;
                }

                // Guarantee hidden inputs for all selected providers and SDGs
                function ensureHiddenInputs(tagRow, inputName, single) {
                    if (!tagRow) return;
                    Array.from(tagRow.querySelectorAll('input[name^="' + inputName + '"]')).forEach(function(input) {
                        input.remove();
                    });
                    var tags = tagRow.querySelectorAll('.college-tag');
                    tags.forEach(function(tag) {
                        var value = tag.getAttribute('data-id');
                        if (!value) {
                            var hidden = tag.querySelector('input[type="hidden"]');
                            if (hidden) value = hidden.value;
                        }
                        if (value) {
                            var hiddenInput = document.createElement('input');
                            hiddenInput.type = 'hidden';
                            hiddenInput.name = inputName + (single ? '' : '[]');
                            hiddenInput.value = value;
                            tagRow.appendChild(hiddenInput);
                        }
                    });
                }
                ensureHiddenInputs(document.getElementById('providers-tag-row'), 'providers', false);
                ensureHiddenInputs(document.getElementById('sdgs-tag-row'), 'sdgs', false);

                // Guarantee all files in additional documents input are present
                if (additionalInput && typeof additionalFiles !== 'undefined' && additionalFiles.length > 0) {
                    var dt = new DataTransfer();
                    additionalFiles.forEach(function(file) { dt.items.add(file); });
                    additionalInput.files = dt.files;
                }

                try {
                    // You can add other custom validation here if needed
                } catch (err) {
                    e.preventDefault();
                }
            });
        }
    });

    // Catch any uncaught JS errors and display them
    window.addEventListener('error', function(event) {
        var errorDiv = document.getElementById('form-error-message');
        if (errorDiv) {
            errorDiv.textContent = 'JavaScript error: ' + event.message;
            if (errorDiv) errorDiv.style.display = 'block';
        }
    });
    // File Input Change Handler
    // Proposal Document Preview
    const proposalInput = document.getElementById('id_proposal_document');
    const proposalPreview = document.getElementById('proposal-file-preview');
    const proposalNameSpan = document.getElementById('proposal-file-name');
    const removeProposalBtn = document.getElementById('remove-proposal-file');

    proposalInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            proposalNameSpan.textContent = file.name;
            if (proposalPreview) proposalPreview.style.display = 'flex';
            if (removeProposalBtn) removeProposalBtn.style.display = 'inline-block';
        } else {
            proposalNameSpan.textContent = '';
            if (proposalPreview) proposalPreview.style.display = 'none';
            if (removeProposalBtn) removeProposalBtn.style.display = 'none';
        }
    });

    removeProposalBtn.addEventListener('click', function() {
        proposalInput.value = '';
        proposalNameSpan.textContent = '';
    if (proposalPreview) proposalPreview.style.display = 'none';
    if (removeProposalBtn) removeProposalBtn.style.display = 'none';
    });

    // Additional Documents Preview (show all file names with remove buttons)
    const additionalInput = document.getElementById('id_additional_documents');
    const additionalPreview = document.getElementById('additional-file-preview');
    const additionalFilesList = document.getElementById('additional-files-list');
    let additionalFiles = [];

    // Allow adding more files to the list, not replacing
    additionalInput.addEventListener('change', function(e) {
        const newFiles = Array.from(e.target.files);
        // Only add files that aren't already present (by name and size)
        newFiles.forEach(f => {
            if (!additionalFiles.some(existing => existing.name === f.name && existing.size === f.size)) {
                additionalFiles.push(f);
            }
        });
        updateAdditionalInput();
        renderAdditionalFiles();
    });

    function renderAdditionalFiles() {
        additionalFilesList.innerHTML = '';
        if (additionalFiles.length > 0) {
            additionalFiles.forEach((file, idx) => {
                // Create a separate file-preview block for each file
                const preview = document.createElement('div');
                preview.className = 'file-preview';
                if (preview) preview.style.display = 'flex';
                preview.style.alignItems = 'center';
                preview.style.justifyContent = 'space-between';
                const info = document.createElement('div');
                info.className = 'file-info';
                info.innerHTML = `<svg width="16" height="16"><use href="#icon-upload"></use></svg> <span>${file.name}</span>`;
                const removeBtn = document.createElement('button');
                removeBtn.textContent = '✕';
                removeBtn.type = 'button';
                removeBtn.className = 'remove-x';
                removeBtn.onclick = function() {
                    additionalFiles.splice(idx, 1);
                    updateAdditionalInput();
                    renderAdditionalFiles();
                };
                preview.appendChild(info);
                preview.appendChild(removeBtn);
                additionalFilesList.appendChild(preview);
            });
            if (additionalPreview) additionalPreview.style.display = 'block';
        } else {
            if (additionalPreview) additionalPreview.style.display = 'none';
        }
    }

    function updateAdditionalInput() {
        // Create a new DataTransfer to update the input's files
        const dt = new DataTransfer();
        additionalFiles.forEach(file => dt.items.add(file));
        additionalInput.files = dt.files;
    }


    // Tag UI logic for Project Leader, Providers, SDGs

    // Enhanced Tag UI logic for Project Leader, Providers, SDGs
    function setupTagUI(rowId, optionsTemplateId, inputName, single=false, excludeIds=[]) {
        const tagRow = document.getElementById(rowId);
        const optionsTemplate = document.getElementById(optionsTemplateId);
        const selectDropdown = document.createElement('select');
        selectDropdown.id = rowId + '-dropdown';
    if (selectDropdown) selectDropdown.style.display = 'none';
        selectDropdown.style.position = 'fixed';
        selectDropdown.style.fontFamily = "Inter, Arial, sans-serif";
        selectDropdown.style.fontSize = "13px";
        selectDropdown.style.padding = "8px 30px 8px 16px";
        selectDropdown.style.borderRadius = "6px";
        selectDropdown.style.appearance = "none";
        selectDropdown.style.background = "white url('data:image/svg+xml;utf8,<svg fill=\"none\" height=\"16\" viewBox=\"0 0 16 16\" width=\"16\" xmlns=\"http://www.w3.org/2000/svg\"><path d=\"M4 6L8 10L12 6\" stroke=\"%23374151\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\"/></svg>') no-repeat right 10px center/16px 16px";

        Array.from(optionsTemplate.options).forEach(opt => {
            selectDropdown.appendChild(opt.cloneNode(true));
        });

        // Get options
        const options = Array.from(selectDropdown.options)
            .filter(opt => opt.value)
            .map(opt => ({id: opt.value, name: opt.text}));

        let selected = [];
            function renderTags() {
                // Always update providers' exclude when rendering leader
                if (rowId === 'project-leader-tag-row' && typeof updateProvidersExclude === 'function') {
                    updateProvidersExclude(selected[0] || null);
                }
            tagRow.innerHTML = '';
            selected.forEach(id => {
                const obj = options.find(o => o.id === id);
                if (obj) {
                    const tag = document.createElement('span');
                    tag.className = 'college-tag';
                    if (single) {
                        // Show red x for removal only
                        const removeBtn = document.createElement('button');
                        removeBtn.type = 'button';
                        removeBtn.className = 'remove-x';
                        removeBtn.innerHTML = '&times;';
                        removeBtn.onclick = function() {
                            selected = [];
                            renderTags();
                        };
                        tag.appendChild(removeBtn);
                    } else {
                        const removeBtn = document.createElement('button');
                        removeBtn.type = 'button';
                        removeBtn.className = 'remove-x';
                        removeBtn.innerHTML = '&times;';
                        removeBtn.onclick = function() {
                            selected = selected.filter(cid => cid !== id);
                            renderTags();
                        };
                        tag.appendChild(removeBtn);
                    }
                    tag.appendChild(document.createTextNode(obj.name));
                    tagRow.appendChild(tag);
                }
            });
            if (!single || selected.length === 0) {
                const addBtn = document.createElement('button');
                addBtn.type = 'button';
                addBtn.id = rowId + '-add-btn';
                addBtn.className = 'add-college-btn';
                addBtn.style.marginLeft = '8px';
                addBtn.innerHTML = `<svg width="16" height="16"><use href="#icon-add" /></svg>`;
                addBtn.onclick = function(e) {
                    const btnRect = addBtn.getBoundingClientRect();
                    if (selectDropdown) selectDropdown.style.display = 'block';
                    selectDropdown.style.position = 'fixed';
                    selectDropdown.style.left = (btnRect.left) + 'px';
                    selectDropdown.style.top = (btnRect.bottom + 4) + 'px';
                    selectDropdown.innerHTML = '';
                    const templateOptions = Array.from(optionsTemplate.options);
                    let exclude = excludeIds.slice();
                    if (rowId === 'project-leader-tag-row') {
                        // Exclude providers from leader options
                        const providerTagRow = document.getElementById('providers-tag-row');
                        if (providerTagRow) {
                            const providerInputs = providerTagRow.querySelectorAll('input[name="providers[]"]');
                            providerInputs.forEach(input => {
                                if (input.value && !exclude.includes(input.value)) exclude.push(input.value);
                            });
                        }
                    } else if (rowId === 'providers-tag-row') {
                        // Exclude leader from provider options
                        const leaderTagRow = document.getElementById('project-leader-tag-row');
                        if (leaderTagRow) {
                            const leaderInput = leaderTagRow.querySelector('input[name="project_leader"]');
                            if (leaderInput && leaderInput.value && !exclude.includes(leaderInput.value)) {
                                exclude.push(leaderInput.value);
                            }
                        }
                    }
                    templateOptions.forEach(opt => {
                        if (!opt.value || (!selected.includes(opt.value) && !exclude.includes(opt.value))) {
                            selectDropdown.appendChild(opt.cloneNode(true));
                        }
                    });
                    selectDropdown.focus();
                };
                tagRow.appendChild(addBtn);
            } else if (single && selected.length === 1) {
                // Show edit button outside the tag, same position as add
                const editBtn = document.createElement('button');
                editBtn.type = 'button';
                editBtn.id = rowId + '-edit-btn';
                editBtn.className = 'add-college-btn';
                editBtn.style.marginLeft = '8px';
                editBtn.innerHTML = `<svg width="16" height="16"><use href="#icon-edit" /></svg>`;
                editBtn.title = 'Change';
                editBtn.onclick = function() {
                    const btnRect = editBtn.getBoundingClientRect();
                    if (selectDropdown) selectDropdown.style.display = 'block';
                    selectDropdown.style.position = 'fixed';
                    selectDropdown.style.left = (btnRect.left) + 'px';
                    selectDropdown.style.top = (btnRect.bottom + 4) + 'px';
                    selectDropdown.innerHTML = '';
                    const templateOptions = Array.from(optionsTemplate.options);
                        let exclude = excludeIds.slice();
                        if (rowId === 'project-leader-tag-row') {
                            // Exclude providers from leader options
                            const providerTagRow = document.getElementById('providers-tag-row');
                            if (providerTagRow) {
                                const providerInputs = providerTagRow.querySelectorAll('input[name="providers[]"]');
                                providerInputs.forEach(input => {
                                    if (input.value && !exclude.includes(input.value)) exclude.push(input.value);
                                });
                            }
                        } else if (rowId === 'providers-tag-row') {
                            // Exclude leader from provider options
                            const leaderTagRow = document.getElementById('project-leader-tag-row');
                            if (leaderTagRow) {
                                const leaderInput = leaderTagRow.querySelector('input[name="project_leader"]');
                                if (leaderInput && leaderInput.value && !exclude.includes(leaderInput.value)) {
                                    exclude.push(leaderInput.value);
                                }
                            }
                        }
                        templateOptions.forEach(opt => {
                            if (!opt.value || (!selected.includes(opt.value) && !exclude.includes(opt.value))) {
                                selectDropdown.appendChild(opt.cloneNode(true));
                            }
                        });
                    selectDropdown.focus();
                };
                tagRow.appendChild(editBtn);
            }
            if (!document.body.contains(selectDropdown)) {
                document.body.appendChild(selectDropdown);
            }
            selected.forEach(cid => {
                const hidden = document.createElement('input');
                hidden.type = 'hidden';
                hidden.name = inputName + (single ? '' : '[]');
                hidden.value = cid;
                tagRow.appendChild(hidden);
            });
        }
        renderTags();
        selectDropdown.onchange = function() {
            const selectedId = selectDropdown.value;
            if (selectedId && !selected.includes(selectedId)) {
                if (single) {
                    selected = [selectedId];
                } else {
                    selected.push(selectedId);
                }
                renderTags();
            }
            selectDropdown.value = '';
            if (selectDropdown) selectDropdown.style.display = 'none';
                // If project leader changed, update providers (handled in renderTags now)
        };
        document.addEventListener('mousedown', function(e) {
            if (selectDropdown && !selectDropdown.contains(e.target) && e.target.id !== rowId + '-add-btn' && e.target.id !== rowId + '-edit-btn') {
                if (selectDropdown) selectDropdown.style.display = 'none';
            }
        });
        return {
            getSelected: () => selected.slice(),
            setExclude: (ids) => { excludeIds = ids; renderTags(); },
        };
    }

    // Setup tag UIs
    var leaderTagUI = setupTagUI('project-leader-tag-row', 'project-leader-options-template', 'project_leader', true);
    var providersTagUI = setupTagUI('providers-tag-row', 'providers-options-template', 'providers');
    setupTagUI('sdgs-tag-row', 'sdgs-options-template', 'sdgs');

    // Update providers to exclude selected leader
    function updateProvidersExclude(leaderId) {
        if (providersTagUI) {
            providersTagUI.setExclude(leaderId ? [leaderId] : []);
        }
    }

    // Logistics Block Logic with custom required
    document.addEventListener('DOMContentLoaded', function() {
        var logisticsSelects = document.querySelector('select[name="logistics_type"]');
        var logisticsBlock = {
            'BOTH': document.getElementById('logistics-both'),
            'INTERNAL': document.getElementById('logistics-internal'),
            'EXTERNAL': document.getElementById('logistics-external'),
        };
        function updateLogisticsBlocks() {
            if (!logisticsSelects) return;
            var selected = logisticsSelects.value;
            Object.keys(logisticsBlock).forEach(function(logistics_type) {
                var block = logisticsBlock[logistics_type];
                if (!block) return;
                if (logistics_type === selected) {
                    if (block) block.style.display = 'block';
                    // Add required to all inputs/selects in this block with data-logistics-required
                    Array.from(block.querySelectorAll('input,select,textarea')).forEach(function(el) {
                        if (el.hasAttribute('data-logistics-required')) {
                            el.required = true;
                        }
                    });
                } else {
                    if (block) block.style.display = 'none';
                    // Remove required from all inputs/selects in this block with data-logistics-required
                    Array.from(block.querySelectorAll('input,select,textarea')).forEach(function(el) {
                        if (el.hasAttribute('data-logistics-required')) {
                            el.required = false;
                        }
                    });
                }
            });
        }
        if (logisticsSelects) {
            logisticsSelects.addEventListener('change', updateLogisticsBlocks);
            updateLogisticsBlocks();
        }
    });
</script>

{% endblock %}
