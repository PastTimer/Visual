{% extends "projects/base_project_profile.html" %}
{% block profile_content %}

<style>
    .card-body {
        text-align: center;
        color: #555;
        font-size: 0.95rem;
    }

    .event-card {
        display: grid;
        grid-auto-rows: auto;
        gap: 2rem;
    }

    .events-section {
        margin-top: 1.5rem;
    }

    .event-card > section {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .event-card img {
        max-width: 30rem;
        aspect-ratio: 16 / 9;
        object-fit: cover;
        border-radius: 0.75rem;
        cursor: pointer;
        border: 0.08rem solid #525252;
    }

    .event-details {
        display: flex;
        align-items: center;
        justify-content: space-between;
        flex-direction: row;
        width: 100%;
    }

    .event-info {
        min-width: 20rem;
        max-width: 30rem;
        text-align: justify;
        max-height: 15rem;
        overflow-y: auto;
        word-break: break-word;
        white-space: normal;
    }

    .event-info p {
        margin: 0.5rem 0;
        overflow-wrap: break-word;  
        word-break: break-word;     
        white-space: normal;    
    }

    .status-text {
        font-weight: bold;
        margin-bottom: 1rem;
    }

    .status-text span {
        font-weight: normal;
    }

    .progress {
        display: inline-block;
        width: 75%;
        height: 0.5rem;
        background-color: #ddd;
        border-radius: 10px;
        overflow: hidden;
        margin-top: 1rem;
    }

    .progress-bar {
        height: 100%;
        background: linear-gradient(90deg, #0a8927, #17f058);
        transition: width 0.5s ease;
    }

    .overlay {
        display: none;
        position: fixed;
        top: 0; left: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(0, 0, 0, 0.8);
        justify-content: center;
        align-items: center;
        z-index: 1000;
    }

    .overlay img {
        max-width: 90%;
        max-height: 90%;
        border-radius: 0.5rem;
        object-fit: contain;
    }

    .tracker-box { 
        background-color: whitesmoke;
        border: 1px solid #ccc;
        border-radius: 2rem;
        justify-content: center; 
        align-items: center;
        text-align: center;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }
</style>

<style>
    .form-group {
		display: flex;
		align-items: flex-start;
		gap: 1rem;
        margin-bottom: 0.5rem;
	}

	.form-label {
		font-weight: 600;
		color: #374151;
		font-size: 0.95rem;
	}

    .required {
        color: #DC2626;
    }

    .form-actions {
        display: flex;
        gap: 1rem;
        margin-top: 1.5rem;
    }

    .submit-btn {
        background-color: #0A6C44;
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 1rem;
        font-weight: 600;
    }

    .submit-btn:hover {
        background-color: #07532F;
    }

    .back-btn {
        background-color: #E5E7EB;
        color: #374151;
        padding: 10px 20px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 1rem;
        font-weight: 600;
    }

    .back-btn:hover {
        background-color: #D1D5DB;
    }

    textarea {
        resize: none;
    }

    input[type="text"], input[type="date"], textarea, input[type="file"], input[type="datetime-local"] {
        flex: 1;
        border-radius: 8px;
        border: 1px solid #e5e7eb;
        padding: 0.75rem;
        font-size: 1rem;
        font-family: 'Inter', sans-serif;
    }
</style>

<style>
    .required {
        color: #DC2626;
    }

    .event-modal {
        position: fixed;
        z-index: 9999;
        left: 0; top: 0; width: 100vw; height: 100vh;
        background: rgba(0,0,0,0.25);
        display: none; align-items: center; justify-content: center;
    }
    
    .event-modal-content {
        background: #fff;
        border-radius: 12px;
        padding: 2rem 2rem 2rem 2rem;
        min-width: 400px;
        max-width: 95vw;
        box-shadow: 0 8px 32px rgba(0,0,0,0.18);
        position: relative;
    }

    .event-modal-content h2 { margin-top:0; font-size:1.5rem; color:#000; font-weight: 400; }
    .event-modal-content .close {
        position: absolute; right: 1.5rem; top: 1.25rem;
        font-size: 1.5rem; color: #888; cursor: pointer;
    }
</style>


<div class="card-header">
    <h3>Events Pipeline Status</h3>
    {% if request.user.role in ADMIN_ROLES %}
    <button class="admin-button" type="button" id="openAddEventModal">Add Event</button>
    {% endif %}
</div>

<div class="card-body">
    <div class="tracker-box">
        <div class="progress">
            <div class="progress-bar" style="width: {{ percent|default_if_none:'0' }}%;"></div>
        </div>
        <p class="status-text">{{ completed }}/{{ total }} events completed ({{ percent }}%)</p>
    </div>
</div>
    <section class="events-section">
        <div class="event-card">
            {% for event in events %}
            <div class="event-details">
                <div class="event-info">
                    <div style="display:flex;align-items:center;gap:0.5rem;">
                        <h4 style="margin:0;">{{ event.title }}</h4>
                        {% if event.related_submissions %}
                            {% if event.related_submissions.status == 'PENDING' or event.related_submissions.status == 'REVISION_REQUESTED' %}
                                <span style="background:#FEF3C7;color:#D97706;padding:0.25rem 0.5rem;border-radius:4px;font-size:0.75rem;font-weight:500;">Submission Required</span>
                            {% elif event.related_submissions.status == 'SUBMITTED' %}
                                <span style="background:#DBEAFE;color:#1D4ED8;padding:0.25rem 0.5rem;border-radius:4px;font-size:0.75rem;font-weight:500;">Under Review</span>
                            {% elif event.related_submissions.status == 'FORWARDED' %}
                                <span style="background:#E0E7FF;color:#6366F1;padding:0.25rem 0.5rem;border-radius:4px;font-size:0.75rem;font-weight:500;">Forwarded</span>
                            {% elif event.related_submissions.status == 'APPROVED' %}
                                <span style="background:#D1FAE5;color:#059669;padding:0.25rem 0.5rem;border-radius:4px;font-size:0.75rem;font-weight:500;">Completed</span>
                            {% elif event.related_submissions.status == 'REJECTED' %}
                                <span style="background:#FEE2E2;color:#DC2626;padding:0.25rem 0.5rem;border-radius:4px;font-size:0.75rem;font-weight:500;">Rejected</span>
                            {% elif event.related_submissions.status == 'OVERDUE' %}
                                <span style="background:#FEE2E2;color:#DC2626;padding:0.25rem 0.5rem;border-radius:4px;font-size:0.75rem;font-weight:500;">Overdue</span>
                            {% endif %}
                        {% endif %}
                        {% if request.user.role in ADMIN_ROLES %}
                        <button type="button" style="background:none;border:none;cursor:pointer;padding:0;" onclick="document.getElementById('edit-event-modal-{{ event.id }}').style.display='flex'">
                            <i class="fa-solid fa-pen-to-square" style="color:#0A6C44;"></i>
                        </button>
                        <button type="button" title="Delete Event" style="background:none;border:none;cursor:pointer;padding:0;" onclick="openDeleteEventModal('{{ event.id }}')">
                            <i class="fa-solid fa-trash" style="color:#E53E3E;"></i>
                        </button>
                        {% endif %}
                    </div>
                    <p>{{ event.description|default:'No description.' }}</p>
                    {% if event.placeholder %}{% else %}<p>{{ event.datetime|date:'F d, Y' }} at {{ event.datetime|date:'g:i A' }}</p>{% endif %}
                    {% if event.location %}<p><strong>Location:</strong> {{ event.location }}</p>{% else %}{% endif %}
                    {% if event.placeholder and request.user.role in ADMIN_ROLES %}<p style="color:red;">Set Date Time and Location to be able to Add Submission</p>{% endif %}
                </div>
                <div style="height:15rem;display:flex; text-align: center; align-items: center;">
                {% if event.image %}
                    <img src="{{ event.image.url }}" alt="Event Photo" style="width:100%;height:100%;object-fit:cover;border-radius:0.75rem;border:0.08rem solid #525252;">
                {% else %}
                    <img src="https://via.placeholder.com/300x200.png?text=No+Image" alt="No Image Available" style="width:100%;height:100%;">
                {% endif %}
                </div>
            </div>

            <!-- Edit Event Modal for this specific event -->
            <div id="edit-event-modal-{{ event.id }}" class="event-modal" style="display:none;">
                <div class="event-modal-content">
                    <span class="close" onclick="document.getElementById('edit-event-modal-{{ event.id }}').style.display='none'">&times;</span>
                    <h2>Edit Event</h2>
                    <form method="post" enctype="multipart/form-data">
                        {% csrf_token %}
                        <input type="hidden" name="event_id" value="{{ event.id }}">
                        <div class="form-group">
                            <label class="form-label">Title <span class="required">*</span></label>
                            <input type="text" name="title" value="{{ event.title }}" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Description <span class="required">*</span></label>
                            <textarea name="description" required>{{ event.description }}</textarea>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Date Time <span class="required">*</span></label>
                            <input type="datetime-local" name="datetime" value="{{ event.datetime|date:'Y-m-d\\TH:i' }}" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Location <span class="required">*</span></label>
                            <input type="text" name="location" value="{{ event.location }}" required>
                        </div>
                        <div class="form-actions" style="justify-content:flex-end;">
                            <button type="button" class="back-btn" onclick="document.getElementById('edit-event-modal-{{ event.id }}').style.display='none'">Cancel</button>
                            <button type="submit" class="submit-btn">Save Changes</button>
                        </div>
                    </form>
                </div>
            </div>

            <script>
                document.getElementById('edit-event-modal-{{ event.id }}').onclick = function(e) {
                    if (e.target === this) {
                        this.style.display = 'none';
                    }
                };
            </script>

            {% empty %}
            <style>.event-details { display: flex; flex-direction: column; align-items: center; }</style>
            <section><div class="event-details"><div class="event-info" style="width: auto;"><h4 style="text-align: center;">No events scheduled.</h4></div></div></section>
            {% endfor %}
        </div>
    </div>
</section>

<!-- Add Event Confirmation Modal -->
<div id="add-event-modal" class="event-modal" style="display:none;">
    <div class="event-modal-content" style="min-width:320px;max-width:95vw;">
        <span class="close" id="close-add-event-modal">&times;</span>
        <h2 style="margin-top:0;font-size:1.3rem;text-align:center;">Add New Event</h2>
        <p style="text-align:center;">Are you sure you want to add a new event?<br>This will increment the event count and create a placeholder event.</p>
        <form method="post" style="margin-top:2rem;gap:15px;display:flex;align-items:center;justify-content:center">
            {% csrf_token %}
            <button type="button" class="back-btn" id="cancel-add-event-modal">Cancel</button>
            <button type="submit" class="submit-btn" name="add_event" value="1">Confirm</button>
        </form>
    </div>
</div>

<script>
    // Add Event Modal logic
    document.getElementById('openAddEventModal').onclick = function() {
        document.getElementById('add-event-modal').style.display = 'flex';
    };
    document.getElementById('close-add-event-modal').onclick = function() {
        document.getElementById('add-event-modal').style.display = 'none';
    };
    document.getElementById('cancel-add-event-modal').onclick = function() {
        document.getElementById('add-event-modal').style.display = 'none';
    };
    document.getElementById('add-event-modal').onclick = function(e) {
        if (e.target === this) {
            this.style.display = 'none';
        }
    };
</script>

<!-- Delete Event Confirmation Modal -->
<div id="delete-event-modal" class="event-modal" style="display:none;">
    <div class="event-modal-content" style="min-width:320px;max-width:95vw;">
        <span class="close" id="close-delete-event-modal">&times;</span>
        <h2 style="margin-top:0;font-size:1.3rem;text-align:center;">Delete Event</h2>
        <p style="text-align:center;">Are you sure you want to delete this event?<br>This will remove the event and decrement the event count.</p>
        <p style="text-align:center;color:#DC2626;font-weight:500;margin-top:1rem;">⚠️ Warning: All submissions related to this event will also be deleted permanently.</p>
        <form id="delete-event-confirm-form" method="post" style="margin-top:2rem;gap:15px;display:flex;align-items:center;justify-content:center">
            {% csrf_token %}
            <input type="hidden" name="delete_event_id" id="delete_event_id_input" value="">
            <button type="button" class="back-btn" id="cancel-delete-event-modal">Cancel</button>
            <button type="submit" class="submit-btn">Confirm Delete</button>
        </form>
    </div>
</div>

<script>
    // Delete Event Modal logic
    function openDeleteEventModal(eventId) {
        document.getElementById('delete_event_id_input').value = eventId;
        document.getElementById('delete-event-modal').style.display = 'flex';
    }
    document.getElementById('close-delete-event-modal').onclick = function() {
        document.getElementById('delete-event-modal').style.display = 'none';
    };
    document.getElementById('cancel-delete-event-modal').onclick = function() {
        document.getElementById('delete-event-modal').style.display = 'none';
    };
    document.getElementById('delete-event-modal').onclick = function(e) {
        if (e.target === this) {
            this.style.display = 'none';
        }
    };
</script>




{% endblock %}