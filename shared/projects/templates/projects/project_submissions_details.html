{% extends base_template %}
{% block content %}
<title>Submission Details</title>

<style>
    body {
        background: #F9F9F9;
        margin: 0;
        font-family: 'Inter', sans-serif;
    }

    .main-container {
        margin: 60px;
        display: flex;
        flex-direction: column;
        gap: 30px;
    }

    .detail-text {
        font-family: 'Inter', sans-serif;
        font-weight: 400;
        font-size: 32px;
        color: #000000;
    }

    .detail-container {
        border-radius: 20px;
        background: #FEFCFC;
        box-shadow: 0 0 8px 1px rgba(0, 0, 0, 0.25);
        padding: 50px 60px;
        display: flex;
        flex-direction: column;
        gap: 20px;
    }

    .detail-trio {
        display: flex;
        align-items: flex-start;
    }

    .detail-trio > :nth-child(1) {
        margin-right: 10px;
    }

    .detail-trio > :nth-child(2) {
        margin-right: 75px;
    }

    .detail-icon {
        width: 28px;
        height: 28px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .detail-item {
        font-family: 'Inter', sans-serif;
        font-weight: 600;
        font-size: 20px;
        width: 210px;
    }

    .detail-value {
        font-family: 'Inter', sans-serif;
        font-weight: 400;
        font-size: 20px;
    }


    .back-btn, .action-btn, .reject-btn {
        display: inline-block;
        color: white;
        padding: 0.75rem 1.5rem;
        border-radius: 8px;
        text-decoration: none;
        font-size: 1rem;
        font-weight: 500;
        border: none;
        text-align: center;
        font-family: 'Inter', sans-serif;
        cursor: pointer;
        transition: background 0.2s;
    }
    
    .back-btn { background: #6B7280; }
    .back-btn:hover { background: #4b5563; }
    .action-btn { background: #063A1C; }
    .action-btn:hover { background: #095c2d; }
    .reject-btn { background: #D5110A; }
    .reject-btn:hover { background: #a10c07; }

    /* Modal Styles */
    .modal-bg {
        position: fixed;
        top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(0,0,0,0.25);
        z-index: 1000;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .modal {
        background: #fff;
        border-radius: 1rem;
        box-shadow: 0 2px 16px rgba(0,0,0,0.18);
        padding: 2.5rem 2.5rem 2rem 2.5rem;
        min-width: 350px;
        max-width: 95vw;
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
        align-items: center;
    }

    .modal-title {
        font-size: 1.3rem;
        font-weight: 600;
        margin-bottom: 0.5rem;
        color: #222;
    }
    .modal-content {
        font-size: 1rem;
        color: #444;
        margin-bottom: 1rem;
        text-align: center;
    }
    .modal-actions {
        display: flex;
        gap: 20px;
        justify-content: center;
        width: 100%;
    }
    .modal input, .modal textarea {
        width: 100%;
        padding: 0.5rem;
        border-radius: 6px;
        border: 1px solid #ccc;
        font-size: 1rem;
        font-family: 'Inter', sans-serif;
        margin-bottom: 1rem;
    }

    textarea {
        resize: none;
    }

</style>

<style>
    .name-link {
        color: #0A6C44;
        text-decoration: none;
    }

    .name-link:hover {
        color: #095c2d;
        text-decoration: underline;
    }

    .upper {
        display: flex;
        flex-direction: row;
        justify-content: space-between;
    }

    .upper-left {
        display: flex;
        flex-direction: column;
        justify-content: center;
        gap: 5px;
    }

    .upper-right {
        display: flex;
        flex-direction: column;
        gap: 5px;
        align-items: flex-end;
    }

    .file-text {
        font-size: 2.3em;
        font-weight: 600;
    }

    .green-text {
        color: #0A6C44;
    }

    .grey-text {
        font-size: 0.9em;
        font-weight: 400;
        color: #6c757d;
    }
    
    .deadline-text {
        font-size: 1.1em;
        font-weight: 600;
        color: #181818;
    }

    hr {
        border: none;
        border-top: 1px solid #7b7b7b;
        margin: 0.5rem 1rem;
    }

    .notes-text {
        font-size: 1.1em;
        font-weight: 400;
        color: #181818;
        word-break: break-word;
    }

    .trained-individuals-text {
        font-size: 1.5em;
        font-weight: 600;
        color: #181818;
    }

    input[type="checkbox"] {
        width: 20px;
        height: 20px;
        margin-top: 4px;
        accent-color: black;
    }

    .content-leftright {
        display: flex;
        flex-direction: row;
        justify-content: space-between;
        gap: 150px;
    }

    .content-left {
        display: flex;
        flex-direction: column;
        gap: 30px;
    }

    .content-right {
        display: flex;
        flex-direction: column;
        gap: 30px;
        min-width: 40%;
        max-width: 40%;
    }

    .final-text {
        font-size: 1.2em;
        font-weight: 500;
    }

    .event-image {
        width: 300px;
        height: auto;
        border-radius: 8px;
        object-fit: cover;
    }

    .red {
        color: #D5110A;
    }

    .redirect-text {
        color: #007bff;
        text-decoration: none;
    }

    .redirect-container {
        display: flex;
        gap: 20px;
    }
    
    .redirect-text:hover {
        text-decoration: underline;
        cursor: pointer;
    }

    .action-container {
        margin-top: 0.5rem;
    }

    .action-form {
        display: flex;
        gap: 15px;
        justify-content: center;
    }
    
    .final-adjust {
        margin-left: 0.5rem;
    }
</style>

<div class="main-container">

    <div class="redirect-container">
        <a href="{% url 'project_submissions' project.id %}" class="redirect-text">Go to Project Details ðŸ¡•</a>
        {% if request.user.role in ADMIN_ROLES or request.user.role in COORDINATOR_ROLE %}
        <a href="{% url 'submissions_admin' %}" class="redirect-text">Go to Submissions ðŸ¡•</a>
        {% endif %}
    </div>

    <div class="upper">
        <div class="upper-left">
            {% if submission.downloadable.file.url %}
            <a href="{{ submission.downloadable.file.url }}" target="_blank" class="name-link file-text">{{ submission.downloadable.name }}</a>
            {% endif %}
            
            <span class="green-text">
                <a class="name-link" href="{% url 'project_submissions' submission.project.id %}">{{ submission.project.title }}</a>
                {% if submission.downloadable.submission_type == "event" %} â€¢ {{ submission.event.title }}{% endif %}
            </span>

            <span class="grey-text">Assigned: {{ submission.created_at|date:"F j, Y, H:i" }}{% if request.user.role in ADMIN_ROLES%} â€¢ {{ submission.created_by.get_full_name }}{% endif %}</span>
         
            {% if submission.status != "PENDING" %}
            <span class="grey-text">Submitted:  {{ submission.submitted_at|date:"F j, Y, H:i" }} â€¢ {{ submission.submitted_by.get_full_name }}</span>
            {% endif %}
            {% if submission.status != "PENDING" and submission.status != "SUBMITTED" %}
            <span class="grey-text">Reviewed:  {{ submission.reviewed_at|date:"F j, Y, H:i" }}{% if request.user.role in ADMIN_ROLES or request.user.role in COORDINATOR_ROLE %} â€¢ {{ submission.reviewed_by.get_full_name }}{% endif %}</span>
            {% endif %}
            {% if submission.status != "PENDING" and submission.status != "SUBMITTED" and submission.status != "REQUESTED_REVISION" and submission.status != "FORWARDED" %}
            <span class="grey-text">Authorized: {{ submission.authorized_at|date:"F j, Y, H:i" }}{% if request.user.role in ADMIN_ROLES%} â€¢ {{ submission.authorized_by.get_full_name }}{% endif %}</span>
            {% endif %}
        </div>

        <div class="upper-right">
            <span class="deadline-text">Due on {{ submission.deadline|date:"F j, Y, H:i" }}</span>
            <span class="grey-text">Status: {{ submission.get_status_display }}</span>
        </div>
    </div>

    <hr>

    <div class="content-leftright">
        <div class="content-left">
            {% if submission.notes %} <span class="notes-text">{{ submission.notes }}</span> {% endif %}
            {% if submission.status == "REVISION_REQUESTED" %} <span class="notes-text"><strong class="red">Reason/s for Requesting Revision</strong><br>{{ submission.reason_for_revision }}</span>{% endif %}
            {% if submission.status == "REJECTED" %} <span class="notes-text"><strong class="red">Reason/s for Rejection</strong><br>{{ submission.reason_for_rejection }}</span>{% endif %}
            {% if submission.file %} <span class="notes-text"><a href="{{ submission.file.url }}" target="_blank" class="name-link">File Here</a></span>{% endif %}
        </div>

        <div class="content-right">
            {% if submission.status != "PENDING" %}
                <!-- Submission [Event] Details -->
                {% if submission.downloadable.submission_type == "event" %}
                    <span class="trained-individuals-text">{{ submission.num_trained_individuals }} Trained Individuals</span>

                    {% if submission.image_event %}
                    <span class="event-image"><a href="{{ submission.image_event.url }}" target="_blank" class="name-link">Image Here</a></span>
                    {% else %}
                    <span class="event-image">No Image</span>
                    {% endif %}

                    <span class="notes-text">{{ submission.image_description }}</span>

                <!-- Submission [Final] Details -->
                {% elif submission.downloadable.submission_type == "final" %}
                    <span class="final-text">{% if submission.for_product_production %}<i class="fa-solid fa-check"></i>{% else %}<i class="fa-solid fa-xmark"></i>{% endif %} <span class="final-adjust">For Product Production</span></span>
                    <span class="final-text">{% if submission.for_research %}<i class="fa-solid fa-check"></i>{% else %}<i class="fa-solid fa-xmark"></i>{% endif %} <span class="final-adjust">For Research</span></span>
                    <span class="final-text">{% if submission.for_extension %}<i class="fa-solid fa-check"></i>{% else %}<i class="fa-solid fa-xmark"></i>{% endif %} <span class="final-adjust">For Extension</span></span>
                {% endif %}
            {% endif %}
        </div>
    </div>

    <div class="action-container">
        {% if submission.status == 'SUBMITTED' and request.user.role == 'COORDINATOR' %}
        <form method="post" action="{% url 'admin_submission_action' project.id submission.id %}" class="action-form">
            {% csrf_token %}
            <button type="submit" name="action" value="forward" class="action-btn">Forward to UESO</button>
            <button type="button" class="reject-btn" id="request-revision-btn">Request Revision</button>
        </form>
        {% elif submission.status == 'FORWARDED' and request.user.role in ADMIN_ROLES %}
        <form method="post" action="{% url 'admin_submission_action' project.id submission.id %}" class="action-form">
            {% csrf_token %}
            <button type="submit" name="action" value="accept" class="action-btn">Accept</button>
            <button type="button" class="reject-btn" id="reject-btn">Reject</button>
        </form>
        {% endif %}
    </div>

    <!-- Modals -->
    <div id="modal-bg" class="modal-bg" style="display:none;">
        <div class="modal" id="modal-reject" style="display:none;">
            <div class="modal-title">Reject Submission</div>
            <div class="modal-content">Please provide a reason for rejection:</div>
            <form method="post" action="{% url 'admin_submission_action' project.id submission.id %}" style="width:100%;">
                {% csrf_token %}
                <input type="hidden" name="action" value="reject" />
                <textarea name="reason" rows="3" required placeholder="Enter reason..." style="resize:vertical;"></textarea>
                <div class="modal-actions">
                    <button type="button" class="back-btn" id="cancel-reject">Cancel</button>
                    <button type="submit" class="reject-btn">Reject</button>
                </div>
            </form>
        </div>
        <div class="modal" id="modal-request-revision" style="display:none;">
            <div class="modal-title">Request Revision</div>
            <div class="modal-content">Please provide a reason for revision:</div>
            <form method="post" action="{% url 'admin_submission_action' project.id submission.id %}" style="width:100%;">
                {% csrf_token %}
                <input type="hidden" name="action" value="request_revision" />
                <textarea name="reason" rows="3" required placeholder="Enter reason..." style="resize:vertical;"></textarea>
                <div class="modal-actions">
                    <button type="button" class="back-btn" id="cancel-request-revision">Cancel</button>
                    <button type="submit" class="reject-btn">Request Revision</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- SVG Icons -->
<svg style="display:none;">
    <symbol id="detail-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M11.8008 17.5508C12.1266 17.5508 12.3999 17.4404 12.6207 17.2196C12.8415 16.9988 12.9515 16.7258 12.9508 16.4008V11.8008C12.9508 11.4749 12.8404 11.202 12.6196 10.982C12.3988 10.7619 12.1258 10.6515 11.8008 10.6508C11.4757 10.65 11.2028 10.7604 10.982 10.982C10.7612 11.2035 10.6508 11.4765 10.6508 11.8008V16.4008C10.6508 16.7266 10.7612 16.9999 10.982 17.2207C11.2028 17.4415 11.4757 17.5515 11.8008 17.5508ZM11.8008 8.35078C12.1266 8.35078 12.3999 8.24038 12.6207 8.01958C12.8415 7.79878 12.9515 7.52585 12.9508 7.20078C12.95 6.87571 12.8396 6.60278 12.6196 6.38198C12.3995 6.16118 12.1266 6.05078 11.8008 6.05078C11.4749 6.05078 11.202 6.16118 10.982 6.38198C10.7619 6.60278 10.6515 6.87571 10.6508 7.20078C10.65 7.52585 10.7604 7.79916 10.982 8.02073C11.2035 8.2423 11.4765 8.35231 11.8008 8.35078ZM11.8008 23.3008C10.2099 23.3008 8.71495 22.9987 7.31578 22.3946C5.91662 21.7904 4.69953 20.9713 3.66453 19.937C2.62953 18.9028 1.81035 17.6857 1.20698 16.2858C0.603616 14.8858 0.301549 13.3908 0.300783 11.8008C0.300016 10.2107 0.602083 8.71571 1.20698 7.31578C1.81188 5.91585 2.63107 4.69876 3.66453 3.66453C4.698 2.6303 5.91508 1.81111 7.31578 1.20698C8.71648 0.602848 10.2115 0.300781 11.8008 0.300781C13.3901 0.300781 14.8851 0.602848 16.2858 1.20698C17.6865 1.81111 18.9036 2.6303 19.937 3.66453C20.9705 4.69876 21.7901 5.91585 22.3957 7.31578C23.0014 8.71571 23.3031 10.2107 23.3008 11.8008C23.2985 13.3908 22.9964 14.8858 22.3946 16.2858C21.7927 17.6857 20.9736 18.9028 19.937 19.937C18.9005 20.9713 17.6834 21.7908 16.2858 22.3957C14.8881 23.0006 13.3931 23.3023 11.8008 23.3008ZM11.8008 21.0008C14.3691 21.0008 16.5445 20.1095 18.327 18.327C20.1095 16.5445 21.0008 14.3691 21.0008 11.8008C21.0008 9.23245 20.1095 7.05703 18.327 5.27453C16.5445 3.49203 14.3691 2.60078 11.8008 2.60078C9.23245 2.60078 7.05703 3.49203 5.27453 5.27453C3.49203 7.05703 2.60078 9.23245 2.60078 11.8008C2.60078 14.3691 3.49203 16.5445 5.27453 18.327C7.05703 20.1095 9.23245 21.0008 11.8008 21.0008Z" fill="black"/>
    </symbol>
</svg>

<script>
    // Modal logic
    function showModal(which) {
        document.getElementById('modal-bg').style.display = 'flex';
        document.getElementById('modal-reject').style.display = (which === 'reject') ? 'flex' : 'none';
        document.getElementById('modal-request-revision').style.display = (which === 'request-revision') ? 'flex' : 'none';
    }

    function hideModal() {
        document.getElementById('modal-bg').style.display = 'none';
        document.getElementById('modal-reject').style.display = 'none';
        document.getElementById('modal-request-revision').style.display = 'none';
    }

    document.addEventListener('DOMContentLoaded', function() {
        var rejectBtn = document.getElementById('reject-btn');
        var requestRevisionBtn = document.getElementById('request-revision-btn');
        if (rejectBtn) rejectBtn.onclick = function() { showModal('reject'); };
        if (requestRevisionBtn) requestRevisionBtn.onclick = function() { showModal('request-revision'); };
        // Cancel buttons
        var cancelReject = document.getElementById('cancel-reject');
        var cancelRequestRevision = document.getElementById('cancel-request-revision');
        if (cancelReject) cancelReject.onclick = hideModal;
        if (cancelRequestRevision) cancelRequestRevision.onclick = hideModal;
        // Hide modal when clicking outside
        document.getElementById('modal-bg').addEventListener('click', function(e) {
            if (e.target === this) hideModal();
        });
    });
</script>

{% endblock %}