{% extends "base_internal.html" %}
{% block content %}

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Calendar</title>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css"/>
<link href="https://fonts.googleapis.com/css2?family=Instrument+Sans:wght@400;700&family=Inter:wght@300;400;700&display=swap" rel="stylesheet">

<style>
    body {
        margin: 0;
        padding: 0;
        font-family: 'Inter', sans-serif;
        background: #D9D9D9;
    }

    /* --- MAIN CONTAINER --- */
    #calendar-wrapper {
        display: flex;
        height: 640px;
        background: white;
        border-bottom: 1px solid rgba(0,0,0,0.3);
    }

    /* --- LEFT SIDEBAR --- */
    #calendar-sidebar-left {
        width: 220px;
        background: #D9D9D9;
        padding-top: 30px;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 25px;
        box-sizing: border-box;
    }

    #calendar-sidebar-left h2 {
        font-size: 24px;
        font-weight: 400;
        margin: 0;
        text-align: center;
    }

    #year-selector {
        font-size: 24px;
        font-weight: 300;
        padding: 5px 10px;
        border-radius: 6px;
        width: 110px;
        height: 50px;
        border: none;
        background: none;
        cursor: pointer;
        appearance: none;
        -webkit-appearance: none;
        -moz-appearance: none;
        background-image: none;
        flex: none;
		background: url("data:image/svg+xml;utf8,<svg width='16' height='11' viewBox='0 0 16 11' fill='none' xmlns='http://www.w3.org/2000/svg'><path d='M7.99976 7.19417L13.9025 1.29147C14.0125 1.17758 14.144 1.08674 14.2895 1.02424C14.435 0.961746 14.5915 0.92885 14.7498 0.927474C14.9082 0.926098 15.0652 0.95627 15.2117 1.01623C15.3583 1.07619 15.4914 1.16473 15.6034 1.27669C15.7153 1.38866 15.8039 1.5218 15.8638 1.66835C15.9238 1.8149 15.954 1.97192 15.9526 2.13026C15.9512 2.28859 15.9183 2.44506 15.8558 2.59055C15.7933 2.73604 15.7025 2.86762 15.5886 2.97762L8.84283 9.72339C8.61921 9.94694 8.31596 10.0725 7.99976 10.0725C7.68356 10.0725 7.38031 9.94694 7.15669 9.72339L0.41092 2.97762C0.297028 2.86762 0.206183 2.73604 0.143687 2.59055C0.0811915 2.44506 0.0482959 2.28859 0.04692 2.13026C0.0455441 1.97192 0.0757155 1.8149 0.135674 1.66835C0.195632 1.5218 0.284176 1.38866 0.39614 1.27669C0.508103 1.16473 0.641244 1.07619 0.787794 1.01623C0.934343 0.95627 1.09137 0.926098 1.2497 0.927474C1.40804 0.92885 1.56451 0.961746 1.71 1.02424C1.85548 1.08674 1.98706 1.17758 2.09706 1.29147L7.99976 7.19417Z' fill='%23374151'/></svg>")
        		no-repeat right 0.75rem center;
    }

    select#year-selector:focus {
        outline: none;
        box-shadow: 0 0 0 2px #245F3E;
    }

    #month-selector {
        list-style: none;
        display: flex;
        flex-direction: column;
        width: 100%;
        padding: 0;
        margin: 0;
        overflow-y: auto;
        }

    #month-selector li {
        font-size: 16px;
        font-weight: 300;
        padding: 20px 0 20px 40px;
        cursor: pointer;
        border-top: 0.8px solid rgba(0, 0, 0, 0.5);
    }

    #month-selector li:hover {
        background: #bfbfbf;
    }

    #month-selector li.active {
        background: #1A1A1A;
        color: white;
    }

    /* --- CENTER CALENDAR --- */
    #calendar-container {
        flex:1;
        padding: 20px;
    }

    #month-name {
        font-size: 32px;
        font-weight: 400;
        text-align: center;
        margin-bottom: 20px;
    }

    .weekdays {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        text-align: center;
        font-size: 15px;
        font-weight: 400;
        margin-bottom: 10px;
    }

    .weekdays div {
        padding: 5px 0;
    }

    .calendar-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 5px;
    }

    .calendar-day {
        border: 1px solid #ccc;
        padding: 10px;
        min-height: 60px;
        cursor: pointer;
        border-radius: 6px;
        text-align: center;
    }

    .calendar-day:hover {
        background: #e6e6e6;
    }


    /* --- RIGHT SIDEBAR --- */
    #calendar-sidebar-right {
        background: #1A1A1A;
        color: white;
        padding: 40px;
        box-sizing: border-box;
        overflow-y: overlay;
        width: 250px;
    }

    /* Universal custom scrollbar for right sidebar */
    #calendar-sidebar-right, #month-selector {
        scrollbar-width: thin;
        scrollbar-color: #444 transparent;
    }
    #calendar-sidebar-right::-webkit-scrollbar, #month-selector::-webkit-scrollbar,
    #calendar-sidebar-right::-moz-scrollbar, #month-selector::-moz-scrollbar,
    #calendar-sidebar-right::-ms-scrollbar, #month-selector::-ms-scrollbar {
        width: 8px;
        background: transparent;
    }
    #calendar-sidebar-right::-webkit-scrollbar-thumb, #month-selector::-webkit-scrollbar-thumb,
    #calendar-sidebar-right::-moz-scrollbar-thumb, #month-selector::-moz-scrollbar-thumb,
    #calendar-sidebar-right::-ms-scrollbar-thumb, #month-selector::-ms-scrollbar-thumb {
        background: #444;
        border-radius: 6px;
    }
    #calendar-sidebar-right::-webkit-scrollbar-track, #month-selector::-webkit-scrollbar-track,
    #calendar-sidebar-right::-moz-scrollbar-track, #month-selector::-moz-scrollbar-track,
    #calendar-sidebar-right::-ms-scrollbar-track, #month-selector::-ms-scrollbar-track {
        background: transparent;
    }

    #calendar-sidebar-right h2 {
        font-size: 30px;
        font-weight: 500;
        margin-bottom: 25px;
    }

    #event-list {
        list-style: none;
        padding: 0;
        margin: 0;
    }

    #event-list li {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        display: block;
        max-width: 170px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        margin-bottom: 25px;
    }

    #event-list h3 {
        font-size: 15px;
        font-weight: 500;
        margin: 0;
    }

    #event-list h4 {
        font-size: 20px;
        font-weight: 500;
        margin: 5px 0 0 15px;
        position: relative;
    }

    #event-list h4::before {
        content: "â€¢";
        position: absolute;
        left: -15px;
        color: #fff;
    }

    /* --- MODAL --- */
    .modal {
        display:none;
        position: fixed;
        z-index:1000;
        inset:0;
        background: rgba(0,0,0,0.5);
        justify-content:center;
        align-items:center;
    }
    .modal-content {
        background:#fff;
        width:600px;
        max-width:calc(100% - 40px);
        height:500px;
        max-height:500px;
        padding:60px;
        border-radius:16px;
        display:flex;
        flex-direction:column;
        gap:20px;
        position:relative;
        overflow-y:auto;
        box-sizing:border-box;
    }

    .close-btn, .edit-btn, .delete-btn {
        position: absolute;
        top: 25px;
        font-size: 24px;
        cursor: pointer;
    }

    .close-btn { right: 25px; }
    .edit-btn { right: 60px; }
    .delete-btn { right: 95px; }

    .event-title {
        font-family: 'Inter', sans-serif;
        font-size: 40px;
        border: none;
        border-bottom: 1px solid #000;
        outline: none;
        color: #888;
    }

    .event-title::placeholder {
        color: #aaa;
    }

    .inline {
        display: inline-flex;
        align-items: center;
        gap: 10px;
    }

    .section-line {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .label {
        font-size: 20px;
    }

    .field-input {
        width: 100%;
        font-size: 20px;
        border: none;
        border-bottom: 1px solid #000;
        outline: none;
        padding: 6px 0;
        color: #888;
    }

    .field-input::placeholder {
        color: #aaa;
    }

    .date-time-row {
        display: flex;
        align-items: center;
        gap: 20px;
        flex-wrap: wrap;
        font-size: 24px;
    }

    .divider {
        width: 1px;
        height: 24px;
        background: rgba(0, 0, 0, 0.2);
    }

    .time-select {
        display: inline-flex;
        align-items: center;
        gap: 8px;
    }

    .time-select select {
        font-size: 18px;
        padding: 4px 8px;
        border-radius: 6px;
        border: 1px solid #ccc;
        outline: none;
        background: #fff;
    }

    .participants-row {
        display: inline-flex;
        align-items: center;
        gap: 10px;
    }

    .add-participant {
        border: none;
        background: #245F3E;
        color: #fff;
        border-radius: 50%;
        width: 32px;
        height: 32px;
        font-size: 20px;
        cursor: pointer;
        line-height: 32px;
    }

    .event-notes {
        width: 100%;
        min-height: 120px;
        border: 1px solid #ccc;
        border-radius: 8px;
        resize: vertical;
        font-size: 16px;
        padding: 8px;
    }

    .add-event-btn {
        align-self: center;
        font-family: 'Inter', sans-serif;
        font-size: 20px;
        background: #245F3E;
        color: #fff;
        border: none;
        border-radius: 24px;
        padding: 12px 32px;
        cursor: pointer;
    }

</style>

<style>
    /* --- General Tag UI Styles (Reusable) --- */
    .tag-box {
        background: #F8F8F8;
        border: 1px solid #000;
        border-radius: 5px;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.35rem 0.85rem 0.35rem 0.5rem;
        font-size: 0.95rem;
        font-family: 'Inter', Arial, sans-serif;
        vertical-align: middle;
        margin-right: 6px;
        margin-bottom: 4px;
    }
    .tag-box .tag-remove {
        color: #E53E3E;
        font-weight: bold;
        font-size: 1.1rem;
        margin-left: 3px;
        margin-right: 1px;
        cursor: pointer;
        border: none;
        background: none;
        padding: 0;
    }
    .tag-add-btn {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        background: #F0F0F0;
        border: 1px solid rgba(0,0,0,0.16);
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: box-shadow 0.2s;
        font-family: 'Inter', Arial, sans-serif;
    }
    .tag-add-btn:hover {
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    .tag-row {
        display: flex;
        align-items: center;
        flex-wrap: wrap;
        position: relative;
        gap: 10px;
        margin-bottom: 15px;
        margin-top: 5px;
    }
</style>

<style>
    .event-modal {
        position: fixed;
        z-index: 9999;
        left: 0; top: 0; width: 100vw; height: 100vh;
        background: rgba(0,0,0,0.25);
        display: none; align-items: center; justify-content: center;
    }
    .event-modal-content {
        background: #fff;
        border-radius: 12px;
        padding: 2rem 2rem 2rem 2rem;
        min-width: 400px;
        max-width: 95vw;
        max-height: 420px;
        box-shadow: 0 8px 32px rgba(0,0,0,0.18);
        position: relative;
        overflow-y: auto;
    }
    .event-modal-content h2 { margin-top:0; font-size:1.5rem; color:#000; font-weight: 400; }
    .event-modal-content .close {
        position: absolute; right: 1.5rem; top: 1.25rem;
        font-size: 1.5rem; color: #888; cursor: pointer;
    }
    .form-group {
        display: flex;
        align-items: flex-start;
        gap: 1rem;
        margin-bottom: 0.5rem;
    }
    .form-label {
        font-weight: 600;
        color: #374151;
        font-size: 0.95rem;
    }
    .required { color: #DC2626; }
    .form-actions { display: flex; gap: 1rem; margin-top: 1.5rem; }
    .submit-btn {
        background-color: #0A6C44;
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 1rem;
        font-weight: 600;
    }
    .submit-btn:hover { background-color: #07532F; }
    .back-btn {
        background-color: #E5E7EB;
        color: #374151;
        padding: 10px 20px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 1rem;
        font-weight: 600;
    }
    .back-btn:hover { background-color: #D1D5DB; }
    textarea { resize: none; }
    input[type="text"], input[type="date"], input[type="time"], textarea, select {
        flex: 1;
        border-radius: 8px;
        border: 1px solid #e5e7eb;
        padding: 0.75rem;
        font-size: 1rem;
        font-family: 'Inter', sans-serif;
    }
</style>

<!-- Event Details Modal Styles -->
<style>
    #event-details-modal .event-modal-content {
        padding: 2.5rem 2.5rem 2.5rem 2.5rem;
        border-radius: 16px;
        background: #fff;
        box-shadow: 0 8px 32px rgba(0,0,0,0.18);
        color: #222;
        max-width: 500px;
        max-height: 420px;
        overflow-y: auto;
    }
    #event-details-title {
        font-size: 2rem;
        font-weight: 600;
        margin-bottom: 0.5rem;
        color: #245F3E;
    }
    #event-details-info {
        font-size: 1.1rem;
        line-height: 1.7;
        margin-bottom: 1.5rem;
    }
    .event-details-label {
        font-weight: 600;
        color: #245F3E;
        margin-right: 8px;
    }
</style>


</head>
<body>

<!-- Main Calendar -->
<div id="calendar-wrapper">
    <!-- LEFT -->
    <div id="calendar-sidebar-left">
        <h2>My Calendar</h2>
        <select id="year-selector"></select>
        <ul id="month-selector">
            <li data-month="0">January</li><li data-month="1">February</li>
            <li data-month="2">March</li><li data-month="3">April</li>
            <li data-month="4">May</li><li data-month="5">June</li>
            <li data-month="6">July</li><li data-month="7">August</li>
            <li data-month="8">September</li><li data-month="9">October</li>
            <li data-month="10">November</li><li data-month="11">December</li>
        </ul>
    </div>

    <!-- CENTER -->
    <div id="calendar-container">
        <h2 id="month-name"></h2>
        <div class="weekdays">
            <div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div>
        </div>
        <div id="calendar" class="calendar-grid"></div>
    </div>

    <!-- RIGHT -->
    <div id="calendar-sidebar-right">
        <h2>Events</h2>
        <ul id="event-list"><li></li></ul>
    </div>
</div>

<!-- Add Event Modal -->
<div id="add-event-modal" class="event-modal" style="display:none;align-items:center;justify-content:center;">
    <div class="event-modal-content">
        <span class="close" id="close-add-event-modal">&times;</span>
        <h2 id="add-event-modal-title">Add Meeting</h2>
        <form id="add-event-form" method="post" enctype="multipart/form-data" action="/calendar/add_event/">
            {% csrf_token %}
            <div class="form-group">
                <label class="form-label">Title <span class="required">*</span></label>
                <input type="text" name="title" id="add_event_title" required style="flex:1;">
            </div>
            <div class="form-group">
                <label class="form-label">Description <span class="required">*</span></label>
                <textarea name="description" id="add_event_description" rows="2" required style="flex:1;border-radius:8px;border:1px solid #e5e7eb;padding:0.75rem;font-size:1rem;"></textarea>
            </div>
            <div class="form-group">
                <label class="form-label">Date <span class="required">*</span></label>
                <input type="date" name="date" id="add_event_date" required style="flex:1; color: #888; pointer-events: none;" readonly tabindex="-1">
                <label class="form-label" style="margin-left:1rem;">Time <span class="required">*</span></label>
                <input type="time" name="time" id="add_event_time" required style="flex:1;">
            </div>
            <div class="form-group">
                <label class="form-label">Location <span class="required">*</span></label>
                <input type="text" name="location" id="add_event_location" required style="flex:1;">
            </div>
            <div class="form-group" style="flex-direction: column; gap:0.5rem;">
                <label class="form-label">Add to Other's Calendar</label>
                <div id="participants-tag-row" class="tag-row"></div>
                <select id="participants-options-template" style="display:none;" multiple>
                    <option value="">Select Participant</option>
                    {% for user in users %}
                        <option value="{{ user.id }}">{{ user.get_full_name|default:user.username }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="form-group">
                <label class="form-label">Notes (Optional)</label>
                <textarea name="notes" id="add_event_notes" rows="2" style="flex:1;border-radius:8px;border:1px solid #e5e7eb;padding:0.75rem;font-size:1rem;"></textarea>
            </div>
            <div class="form-actions" style="justify-content:flex-end;">
                <button type="button" class="back-btn" id="cancel-add-event-modal">Cancel</button>
                <button type="submit" class="submit-btn">Add Event</button>
            </div>
        </form>
    </div>
</div>

<!-- Edit Event Modal -->
<div id="edit-event-modal" class="event-modal" style="display:none;align-items:center;justify-content:center;">
    <div class="event-modal-content" style="max-width:600px;">
        <span class="close" id="close-edit-event-modal">&times;</span>
        <h2 id="edit-event-modal-title">Edit Event</h2>
        <form id="edit-event-form" method="post" enctype="multipart/form-data" action="/calendar/edit_event/">
            {% csrf_token %}
            <input type="hidden" name="event_id" id="edit_event_id">
            <div class="form-group">
                <label class="form-label">Title <span class="required">*</span></label>
                <input type="text" name="title" id="edit_event_title" required style="flex:1;">
            </div>
            <div class="form-group">
                <label class="form-label">Description <span class="required">*</span></label>
                <textarea name="description" id="edit_event_description" rows="2" required style="flex:1;border-radius:8px;border:1px solid #e5e7eb;padding:0.75rem;font-size:1rem;"></textarea>
            </div>
            <div class="form-group">
                <label class="form-label">Date <span class="required">*</span></label>
                <input type="date" name="date" id="edit_event_date" required style="flex:1; color: #888;">
                <label class="form-label" style="margin-left:1rem;">Time <span class="required">*</span></label>
                <input type="time" name="time" id="edit_event_time" required style="flex:1;">
            </div>
            <div class="form-group">
                <label class="form-label">Location <span class="required">*</span></label>
                <input type="text" name="location" id="edit_event_location" required style="flex:1;">
            </div>
            <div class="form-group" style="flex-direction: column; gap:0.5rem;">
                <label class="form-label">Participants</label>
                <div id="edit-participants-tag-row" class="tag-row"></div>
                <select id="edit-participants-options-template" style="display:none;" multiple>
                    <option value="">Select Participant</option>
                    {% for user in users %}
                        <option value="{{ user.id }}">{{ user.get_full_name|default:user.username }}</option>
                    {% endfor %}
                </select>
                <script id="participants-data" type="application/json"></script>
            </div>
            <div class="form-group">
                <label class="form-label">Notes (Optional)</label>
                <textarea name="notes" id="edit_event_notes" rows="2" style="flex:1;border-radius:8px;border:1px solid #e5e7eb;padding:0.75rem;font-size:1rem;"></textarea>
            </div>
            <div class="form-actions" style="justify-content:flex-end;">
                <button type="button" class="back-btn" id="cancel-edit-event-modal">Cancel</button>
                <button type="submit" class="submit-btn">Save Changes</button>
            </div>
        </form>
    </div>
</div>


<!-- Event Details Modal -->
<div id="event-details-modal" class="event-modal" style="display:none;align-items:center;justify-content:center;">
    <div class="event-modal-content" style="max-width:600px;">
        <span class="close" id="close-event-details-modal">&times;</span>
        <h2 id="event-details-title" style="margin-bottom:10px;"></h2>
        <div id="event-details-info">
            <!-- Details will be injected here -->
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div id="delete-confirm-modal" class="event-modal" style="display:none;align-items:center;justify-content:center;">
    <div class="event-modal-content" style="max-width:400px;">
        <h2 style="margin-bottom:20px;color:#E53E3E;font-size:1.3rem;">Confirm Delete</h2>
        <div id="delete-confirm-message" style="font-size:1.1rem;margin-bottom:30px;color:#333;"></div>
        <div style="display:flex;justify-content:flex-end;gap:15px;">
            <button type="button" class="back-btn" id="cancel-delete-modal">Cancel</button>
            <button type="button" class="submit-btn" id="confirm-delete-btn" style="background:#E53E3E;">Delete</button>
        </div>
    </div>
</div>

<svg>
    <!-- Add Icon -->
    <symbol id="icon-add" viewBox="0 0 16 16">
        <path d="M6.80039 14.4004C6.80039 14.7187 6.92682 15.0239 7.15186 15.2489C7.37691 15.474 7.68213 15.6004 8.00039 15.6004C8.31865 15.6004 8.62388 15.474 8.84892 15.2489C9.07396 15.0239 9.20039 14.7187 9.20039 14.4004V9.20039H14.4004C14.7187 9.20039 15.0239 9.07396 15.2489 8.84892C15.474 8.62388 15.6004 8.31865 15.6004 8.00039C15.6004 7.68213 15.474 7.37691 15.2489 7.15186C15.0239 6.92682 14.7187 6.80039 14.4004 6.80039H9.20039V1.60039C9.20039 1.28213 9.07396 0.976906 8.84892 0.751863C8.62388 0.526819 8.31865 0.400391 8.00039 0.400391C7.68213 0.400391 7.37691 0.526819 7.15186 0.751863C6.92682 0.976906 6.80039 1.28213 6.80039 1.60039V6.80039H1.60039C1.28213 6.80039 0.976906 6.92682 0.751863 7.15186C0.526819 7.37691 0.400391 7.68213 0.400391 8.00039C0.400391 8.31865 0.526819 8.62388 0.751863 8.84892C0.976906 9.07396 1.28213 9.20039 1.60039 9.20039H6.80039V14.4004Z" fill="black"/>
    </symbol>
</svg>

<!-- Participants Tagging -->
<script>
    // Edit modal logic (adapted from project_events.html)
    function openEditEventModal(eventObj) {
        document.getElementById('event-details-modal').style.display = 'none';
        document.getElementById('edit-event-modal').style.display = 'flex';
        document.getElementById('edit_event_id').value = eventObj.id;
        document.getElementById('edit_event_title').value = eventObj.title || '';
        document.getElementById('edit_event_description').value = eventObj.description || '';
        document.getElementById('edit_event_date').value = eventObj.date || '';
        document.getElementById('edit_event_time').value = eventObj.time || '';
        document.getElementById('edit_event_location').value = eventObj.location || '';
        document.getElementById('edit_event_notes').value = eventObj.notes || '';
        // Participants tag UI
        const tagRow = document.getElementById('edit-participants-tag-row');
        while (tagRow.firstChild) tagRow.removeChild(tagRow.firstChild);
        // Set JSON data for participants
        document.getElementById('participants-data').textContent = JSON.stringify(eventObj.participants || []);
        renderParticipantTags();
    }

    function renderParticipantTags() {
        const tagRow = document.getElementById('edit-participants-tag-row');
        const optionsTemplate = document.getElementById('edit-participants-options-template');
        let selectedParticipants = [];
        try {
            selectedParticipants = JSON.parse(document.getElementById('participants-data').textContent);
        } catch (e) {
            selectedParticipants = [];
        }
        tagRow.innerHTML = '';
        selectedParticipants.forEach(id => {
            const opt = Array.from(optionsTemplate.options).find(o => String(o.value) === String(id));
            if (opt) {
                const tag = document.createElement('span');
                tag.className = 'tag-box';
                tag.textContent = opt.textContent;
                const removeBtn = document.createElement('button');
                removeBtn.type = 'button';
                removeBtn.className = 'tag-remove';
                removeBtn.innerHTML = '&times;';
                removeBtn.onclick = function() {
                    selectedParticipants = selectedParticipants.filter(pid => pid !== id);
                    document.getElementById('participants-data').textContent = JSON.stringify(selectedParticipants);
                    renderParticipantTags();
                };
                tag.appendChild(removeBtn);
                tagRow.appendChild(tag);
            }
        });
        // Add button logic
        const addBtn = document.createElement('button');
        addBtn.type = 'button';
        addBtn.innerHTML = '<svg width="16" height="16"><use href="#icon-add" /></svg>';
        addBtn.className = 'tag-add-btn';
        addBtn.onclick = function(e) {
            const selectDropdown = document.createElement('select');
            selectDropdown.multiple = false;
            selectDropdown.style.position = 'absolute';
            selectDropdown.style.zIndex = 9999;
            selectDropdown.style.display = 'block';
            selectDropdown.style.left = (addBtn.getBoundingClientRect().left + window.scrollX) + 'px';
            selectDropdown.style.top = (addBtn.getBoundingClientRect().bottom + window.scrollY) + 'px';
            Array.from(optionsTemplate.options).forEach(opt => {
                if (!opt.value || selectedParticipants.includes(opt.value)) return;
                const option = document.createElement('option');
                option.value = opt.value;
                option.textContent = opt.textContent;
                selectDropdown.appendChild(option);
            });
            selectDropdown.onchange = function() {
                const selectedId = selectDropdown.value;
                if (selectedId && !selectedParticipants.includes(selectedId)) {
                    selectedParticipants.push(selectedId);
                    document.getElementById('participants-data').textContent = JSON.stringify(selectedParticipants);
                    renderParticipantTags();
                }
                selectDropdown.value = '';
                selectDropdown.style.display = 'none';
            };
            document.body.appendChild(selectDropdown);
            selectDropdown.focus();
            document.addEventListener('mousedown', function handler(e) {
                if (!selectDropdown.contains(e.target) && e.target.className !== 'tag-add-btn') {
                    selectDropdown.style.display = 'none';
                    selectDropdown.remove();
                    document.removeEventListener('mousedown', handler);
                }
            });
        };
        tagRow.appendChild(addBtn);
        selectedParticipants.forEach(id => {
            const hidden = document.createElement('input');
            hidden.type = 'hidden';
            hidden.name = 'participants[]';
            hidden.value = id;
            tagRow.appendChild(hidden);
        });
    }
    document.getElementById('close-edit-event-modal').onclick = function() {
        document.getElementById('edit-event-modal').style.display = 'none';
    };
    document.getElementById('cancel-edit-event-modal').onclick = function() {
        document.getElementById('edit-event-modal').style.display = 'none';
    };
    document.getElementById('edit-event-modal').onclick = function(e) {
        if (e.target === this) {
            this.style.display = 'none';
        }
    };
    // Handle edit event form submit
    editEventForm.onsubmit = function(e) {
        e.preventDefault();
        const event_id = document.getElementById('edit_event_id').value;
        const title = document.getElementById('edit_event_title').value.trim();
        const description = document.getElementById('edit_event_description').value.trim();
        const date = document.getElementById('edit_event_date').value;
        const time = document.getElementById('edit_event_time').value;
        const location = document.getElementById('edit_event_location').value.trim();
        const participants = Array.from(document.querySelectorAll('#edit-participants-tag-row input[name="participants[]"]')).map(input => input.value);
        const notes = document.getElementById('edit_event_notes').value.trim();
        if (!event_id || !title || !description || !date || !time || !location) {
            alert('Please fill in all required fields.');
            return;
        }
        const csrfToken = document.querySelector('input[name="csrfmiddlewaretoken"]').value;
        fetch('/calendar/edit_event/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({
                event_id, title, description, date, time, location, participants, notes
            })
        }).then(r => r.json()).then(resp => {
            if (resp.status === 'success') {
                editEventModal.style.display = 'none';
                // Fetch latest events from backend
                fetch('/calendar/events_json/')
                  .then(r => r.json())
                  .then(data => {
                      events = data;
                      renderCalendar(currentYear, currentMonth);
                      fetchEvents();
                  })
                  .catch(err => {
                      alert('Could not refresh events: ' + err.message);
                      renderCalendar(currentYear, currentMonth);
                      fetchEvents();
                  });
            } else {
                alert('Error: ' + JSON.stringify(resp.errors || resp));
            }
        }).catch(err => alert('Network error: ' + err.message));
    };
    
    // Placeholder for fetchEvents function
    function fetchEvents() {
        // Display events for the selected month in the right sidebar
        const eventList = document.getElementById('event-list');
        eventList.innerHTML = '';
        let found = false;
        // events is a global object: { 'YYYY-MM-DD': [ {title, date, ...}, ... ] }
        for (const dateStr in events) {
            if (events.hasOwnProperty(dateStr)) {
                const dateObj = new Date(dateStr);
                if (dateObj.getFullYear() === currentYear && dateObj.getMonth() === currentMonth) {
                    events[dateStr].forEach(ev => {
                        const li = document.createElement('li');
                        li.innerHTML = `<strong>${ev.title}</strong><br><span style='font-size:0.95em;color:#bbb;'>${dateStr}</span>`;
                        eventList.appendChild(li);
                        found = true;
                    });
                }
            }
        }
        if (!found) {
            eventList.innerHTML = '<li>No events this month.</li>';
        }
    }
    // Tag UI logic for participants (similar to providers in add_project)
    function setupTagUI(rowId, templateId, inputName, single=false) {
        var tagRow = document.getElementById(rowId);
        var templateOptions = Array.from(document.getElementById(templateId).options);
        var selected = [];
        var excludeIds = [];
        var selectDropdown = document.createElement('select');
        selectDropdown.multiple = !single;
        selectDropdown.style.position = 'absolute';
        selectDropdown.style.zIndex = 9999;
        selectDropdown.style.display = 'none';
        function renderTags() {
            tagRow.innerHTML = '';
            selected.forEach(cid => {
                var opt = templateOptions.find(o => o.value == cid);
                if (opt) {
                    var tag = document.createElement('span');
                    tag.className = 'tag-box';
                    tag.textContent = opt.textContent;
                    var removeBtn = document.createElement('button');
                    removeBtn.type = 'button';
                    removeBtn.innerHTML = '<span class="tag-remove">&times;</span>';
                    removeBtn.className = 'tag-remove';
                    removeBtn.onclick = function() {
                        selected = selected.filter(id => id != cid);
                        renderTags();
                    };
                    tag.appendChild(removeBtn);
                    tagRow.appendChild(tag);
                }
            });
            var addBtn = document.createElement('button');
            addBtn.type = 'button';
            addBtn.innerHTML = '<svg width="16" height="16"><use href="#icon-add" /></svg>';
            addBtn.className = 'tag-add-btn';
            addBtn.onclick = function(e) {
                selectDropdown.innerHTML = '';
                var template = document.getElementById(templateId);
                Array.from(template.options).forEach(opt => {
                    if (!opt.value || selected.includes(opt.value) || excludeIds.includes(opt.value)) return;
                    var option = document.createElement('option');
                    option.value = opt.value;
                    option.textContent = opt.textContent;
                    selectDropdown.appendChild(option);
                });
                selectDropdown.style.display = 'block';
                selectDropdown.style.position = 'absolute';
                selectDropdown.style.left = (addBtn.getBoundingClientRect().left + window.scrollX) + 'px';
                selectDropdown.style.top = (addBtn.getBoundingClientRect().bottom + window.scrollY) + 'px';
                document.body.appendChild(selectDropdown);
                selectDropdown.focus();
            };
            tagRow.appendChild(addBtn);
            selected.forEach(cid => {
                var hidden = document.createElement('input');
                hidden.type = 'hidden';
                hidden.name = inputName + (single ? '' : '[]');
                hidden.value = cid;
                tagRow.appendChild(hidden);
            });
        }
        selectDropdown.onchange = function() {
            var selectedId = selectDropdown.value;
            if (selectedId && !selected.includes(selectedId)) {
                if (single) {
                    selected = [selectedId];
                } else {
                    selected.push(selectedId);
                }
                renderTags();
            }
            selectDropdown.value = '';
            selectDropdown.style.display = 'none';
        };
        document.addEventListener('mousedown', function(e) {
            if (selectDropdown && !selectDropdown.contains(e.target) && e.target.className !== 'add-tag-btn') {
                selectDropdown.style.display = 'none';
            }
        });
        tagRow.appendChild(selectDropdown);
        renderTags();
        function setSelected(ids) {
            selected = Array.isArray(ids) ? ids.slice() : [];
            renderTags();
        }
        return {
            getSelected: () => selected.slice(),
            setExclude: (ids) => { excludeIds = ids; renderTags(); },
            setSelected,
        };
    }
    document.addEventListener('DOMContentLoaded', function() {
        setupTagUI('participants-tag-row', 'participants-options-template', 'participants');
    });
</script>

<!-- Add Event Modal -->
<script>
    // --- Add Event Modal Logic ---
    const addEventModal = document.getElementById('add-event-modal');
    const closeAddEventModal = document.getElementById('close-add-event-modal');
    const cancelAddEventModal = document.getElementById('cancel-add-event-modal');
    const addEventForm = document.getElementById('add-event-form');
    const addEventDateInput = document.getElementById('add_event_date');

    function openAddEventModal(dateStr) {
        // Reset all form fields
        document.getElementById('add_event_title').value = '';
        document.getElementById('add_event_description').value = '';
        document.getElementById('add_event_time').value = '';
        document.getElementById('add_event_location').value = '';
        document.getElementById('add_event_notes').value = '';
        // Remove all participant tags
        const tagRow = document.getElementById('participants-tag-row');
        while (tagRow.firstChild) tagRow.removeChild(tagRow.firstChild);
        // Re-initialize tag UI
        setupTagUI('participants-tag-row', 'participants-options-template', 'participants');
        addEventDateInput.value = dateStr;
        addEventModal.style.display = 'flex';
    }

    closeAddEventModal.onclick = function() { addEventModal.style.display = 'none'; };
    cancelAddEventModal.onclick = function() { addEventModal.style.display = 'none'; };
    addEventModal.onclick = function(e) { if (e.target === addEventModal) addEventModal.style.display = 'none'; };

    // Intercept form submit for AJAX
    addEventForm.onsubmit = function(e) {
        e.preventDefault();
        const title = document.getElementById('add_event_title').value.trim();
        const description = document.getElementById('add_event_description').value.trim();
        const date = document.getElementById('add_event_date').value;
        const time = document.getElementById('add_event_time').value;
        const location = document.getElementById('add_event_location').value.trim();
        const participants = Array.from(document.querySelectorAll('#participants-tag-row input[name="participants[]"]')).map(input => input.value);
        const notes = document.getElementById('add_event_notes').value.trim();
        if (!title || !description || !date || !time || !location) {
            alert('Please fill in all required fields.');
            return;
        }
        const csrfToken = document.querySelector('input[name="csrfmiddlewaretoken"]').value;
        fetch('/calendar/add_event/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({
                title, description, date, time, location, participants, notes
            })
        })
        .then(function(r) { return r.json(); })
        .then(function(resp) {
            if (resp.status === 'success') {
                addEventModal.style.display = 'none';
                // Fetch latest events from backend and update calendar grid
                fetch('/calendar/events_json/')
                  .then(function(r) { return r.json(); })
                  .then(function(data) {
                      events = data;
                      renderCalendar(currentYear, currentMonth); // update calendar grid
                      fetchEvents(); // update sidebar event list
                  })
                  .catch(function(err) {
                      alert('Could not refresh events: ' + err.message);
                      renderCalendar(currentYear, currentMonth);
                      fetchEvents();
                  });
            } else {
                alert('Error: ' + JSON.stringify(resp.errors || resp));
            }
        })
        .catch(function(err) {
            alert('Network error: ' + err.message);
        });
    };

    // Hook up calendar day click to open modal
    function renderCalendar(year, month) {
        const monthNames=["January","February","March","April","May","June","July","August","September","October","November","December"];
        document.getElementById('month-name').textContent=monthNames[month];
        calendar.innerHTML='';
        const firstDay=new Date(year,month,1).getDay();
        const daysInMonth=new Date(year,month+1,0).getDate();
        for(let i=0;i<firstDay;i++){ calendar.appendChild(document.createElement('div')); }
        for(let d=1;d<=daysInMonth;d++){
            const cell=document.createElement('div');
            const dateStr=`${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
            cell.className='calendar-day';
            cell.textContent=d;
            cell.dataset.date=dateStr;
            if(events[dateStr]){
                let hasMeeting = events[dateStr].some(ev => ev.type === 'meeting');
                let hasProject = events[dateStr].some(ev => ev.type === 'project');
                // Determine if all events are done (past date)
                const today = new Date();
                const cellDate = new Date(year, month, d);
                let isPast = cellDate < new Date(today.getFullYear(), today.getMonth(), today.getDate());
                if (isPast) {
                    // Faded blue/green for done
                    if (hasMeeting && hasProject) {
                        cell.style.background = 'linear-gradient(90deg, #A9C6DD 50%, #B6D3C2 50%)';
                    } else if (hasMeeting) {
                        cell.style.backgroundColor = '#A9C6DD';
                    } else if (hasProject) {
                        cell.style.backgroundColor = '#B6D3C2';
                    }
                    cell.style.color = '#eee';
                } else {
                    if (hasMeeting && hasProject) {
                        cell.style.background = 'linear-gradient(90deg, #3A7CA5 50%, #245F3E 50%)';
                        cell.style.color = 'white';
                    } else if (hasMeeting) {
                        cell.style.backgroundColor = '#3A7CA5';
                        cell.style.color = 'white';
                    } else if (hasProject) {
                        cell.style.backgroundColor = '#245F3E';
                        cell.style.color = 'white';
                    }
                }
                cell.style.cursor = "pointer";
                cell.onclick = function() {
                    showEventDetails(events[dateStr], dateStr);
                };
            } else {
                cell.onclick = function() {
                    openAddEventModal(dateStr);
                };
            }
            // Highlight current day
            const today = new Date();
            if (year === today.getFullYear() && month === today.getMonth() && d === today.getDate()) {
                cell.style.border = '2px solid #FFE066';
                cell.style.boxShadow = '0 0 0 2px #FFE066';
            }
            calendar.appendChild(cell);
        }
    }

    // Event Details Modal Logic
    const eventDetailsModal = document.getElementById('event-details-modal');
    const closeEventDetailsModal = document.getElementById('close-event-details-modal');
    closeEventDetailsModal.onclick = function() { eventDetailsModal.style.display = 'none'; };
    eventDetailsModal.onclick = function(e) { if (e.target === eventDetailsModal) eventDetailsModal.style.display = 'none'; };

    function showEventDetails(eventArr, dateStr) {
        eventDetailsModal.style.display = 'flex';
        let html = '';
        const currentUserId = "{{ request.user.id|default:'' }}";
        const currentUserRole = "{{ request.user.role|default:''|escapejs }}";
        eventArr.forEach(ev => {
            if (ev.type === 'meeting') {
                let canEdit = false;
                if (currentUserId !== "" && (ev.created_by == currentUserId || ["DIRECTOR","UESO","VP"].includes(currentUserRole))) {
                    canEdit = true;
                }
                html += `<div class="event-details-row" style="display:flex;align-items:center;">
                    <div style="font-size:1.5rem;font-weight:600;color:#3A7CA5;margin-bottom:0.3rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:100%;flex:1;">${ev.title}</div>
                    ${canEdit ? `<i class='fa-solid fa-pen-to-square' style='font-size:1.3rem;color:#3A7CA5;cursor:pointer;margin-left:10px;' title='Edit' onclick='window.openEditEventModal(${JSON.stringify(ev)})'></i>` : ''}
                    ${canEdit ? `<i class='fa-solid fa-trash' style='font-size:1.3rem;color:#E53E3E;cursor:pointer;margin-left:10px;' title='Delete' onclick='window.confirmDeleteEvent(${ev.id}, ${JSON.stringify(ev.title)})'></i>` : ''}
                </div>
                <div style="font-size:1.1rem;font-weight:400;color:#222;margin-bottom:0.2rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:100%">${ev.description}</div>
                <div style="font-size:1rem;color:#666;margin-bottom:0.2rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:100%">${ev.date} at ${ev.time}</div>
                <div style="font-size:1.1rem;color:#333;margin-bottom:0.2rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:100%">${ev.location}</div>
                ${ev.participant_names && ev.participant_names.length ? `<div style='font-size:0.95em;color:#555;margin-bottom:0.2rem;'><b>Participants:</b> <span style='font-size:0.95em;'>${ev.participant_names.join(", ")}</span></div>` : ''}
                ${ev.notes && ev.notes.trim() ? `<div style=\"font-size:1rem;color:#888;margin-top:0.3rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:100%\">${ev.notes}</div>` : ''}
                <hr style="margin:10px 0;">`;
            } else if (ev.type === 'project') {
                html += `<div class="event-details-row" style="display:flex;align-items:center;">
                    <div style="font-size:1.5rem;font-weight:600;color:#245F3E;margin-bottom:0.3rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:100%;flex:1;">${ev.title}</div>
                    <i class='fa-regular fa-arrow-right' style='font-size:1.3rem;color:#245F3E;cursor:pointer;margin-left:10px;' title='Go to event' onclick='window.location.href="/projects/${ev.project_id}/"'></i>
                </div>
                ${ev.project_name ? `<div style='font-size:1.05em;color:#245F3E;margin-bottom:0.2rem;'><b>Project:</b> <span style='font-size:1.05em;'>${ev.project_name}</span></div>` : ''}
                <div style="font-size:1.1rem;font-weight:400;color:#222;margin-bottom:0.2rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:100%">${ev.description}</div>
                <div style="font-size:1rem;color:#666;margin-bottom:0.2rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:100%">${ev.date} at ${ev.time}</div>
                <div style="font-size:1.1rem;color:#333;margin-bottom:0.2rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:100%">${ev.location}</div>
                ${ev.leader ? `<div style='font-size:0.95em;color:#555;margin-bottom:0.2rem;'><b>Leader:</b> <span style='font-size:0.95em;'>${ev.leader}</span></div>` : ''}
                ${ev.provider_names && ev.provider_names.length ? `<div style='font-size:0.95em;color:#555;margin-bottom:0.2rem;'><b>Providers:</b> <span style='font-size:0.95em;'>${ev.provider_names.join(", ")}</span></div>` : ''}
                ${ev.notes && ev.notes.trim() ? `<div style=\"font-size:1rem;color:#888;margin-top:0.3rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:100%\">${ev.notes}</div>` : ''}
                <hr style="margin:10px 0;">`;
            }
        });
        document.getElementById('event-details-title').textContent = eventArr.length === 1 ? '' : `Events on ${dateStr}`;
        document.getElementById('event-details-info').innerHTML = html;
    }

    // Delete event logic
    window.confirmDeleteEvent = function(eventId, eventTitle) {
        // Hide all other modals
        document.getElementById('event-details-modal').style.display = 'none';
        document.getElementById('edit-event-modal').style.display = 'none';
        // Show only the delete modal
        document.getElementById('delete-confirm-modal').style.display = 'flex';
        document.getElementById('delete-confirm-message').textContent = `Are you sure you want to delete "${eventTitle}"? This action cannot be undone.`;
        pendingDeleteEventId = eventId;
        pendingDeleteEventTitle = eventTitle;
    };

    document.getElementById('cancel-delete-modal').onclick = function() {
        document.getElementById('delete-confirm-modal').style.display = 'none';
    };
    document.getElementById('delete-confirm-modal').onclick = function(e) {
        if (e.target === this) {
            this.style.display = 'none';
        }
    };
    document.getElementById('confirm-delete-btn').onclick = function() {
        if (pendingDeleteEventId) {
            deleteEvent(pendingDeleteEventId);
        }
        document.getElementById('delete-confirm-modal').style.display = 'none';
    };

    function deleteEvent(eventId) {
        const csrfToken = document.querySelector('input[name="csrfmiddlewaretoken"]').value;
        fetch('/calendar/delete_event/' + eventId + '/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({})
        })
        .then(function(r) { return r.json(); })
        .then(function(resp) {
            if (resp.status === 'success') {
                document.getElementById('event-details-modal').style.display = 'none';
                // Refresh events
                fetch('/calendar/events_json/')
                  .then(function(r) { return r.json(); })
                  .then(function(data) {
                      events = data;
                      renderCalendar(currentYear, currentMonth);
                      fetchEvents();
                  })
                  .catch(function(err) {
                      alert('Could not refresh events: ' + err.message);
                      renderCalendar(currentYear, currentMonth);
                      fetchEvents();
                  });
            } else {
                alert('Error: ' + JSON.stringify(resp.errors || resp));
            }
        })
        .catch(function(err) {
            alert('Network error: ' + err.message);
        });
    }
</script>

<!-- Render Calendar Scripts -->
<script>
    let events = JSON.parse('{{ events_json|default:"{}"|escapejs }}');
    const calendar = document.getElementById('calendar');
    const eventList = document.getElementById('event-list');
    let currentYear = new Date().getFullYear();
    let currentMonth = new Date().getMonth();
    let selectedDate = null;

    // Populate year dropdown (current-10 to current+10)
    const yearSelector = document.getElementById("year-selector");
    for(let y=currentYear-10;y<=currentYear+10;y++){
        const opt=document.createElement("option");
        opt.value=y; opt.textContent=y;
        if(y===currentYear) opt.selected=true;
        yearSelector.appendChild(opt);
}

    // Month click
    document.querySelectorAll('#month-selector li').forEach(li=>{
        li.onclick=()=>{
            currentMonth=parseInt(li.dataset.month);
            renderCalendar(currentYear,currentMonth);
            fetchEvents();
            document.querySelectorAll('#month-selector li').forEach(l=>l.classList.remove('active'));
            li.classList.add('active');
        };
    });

    // Set initial active month
    document.querySelectorAll('#month-selector li')[currentMonth].classList.add('active');

    yearSelector.onchange=()=>{currentYear=parseInt(yearSelector.value); renderCalendar(currentYear,currentMonth); fetchEvents();};

    function renderCalendar(year,month){
        const monthNames=["January","February","March","April","May","June","July","August","September","October","November","December"];
        document.getElementById('month-name').textContent=monthNames[month];
        calendar.innerHTML='';
        const firstDay=new Date(year,month,1).getDay();
        const daysInMonth=new Date(year,month+1,0).getDate();
        for(let i=0;i<firstDay;i++){ calendar.appendChild(document.createElement('div')); }
        for(let d=1;d<=daysInMonth;d++){
            const cell=document.createElement('div');
            const dateStr=`${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
            cell.className='calendar-day';
            cell.textContent=d;
            cell.dataset.date=dateStr;
            if(events[dateStr]){ cell.style.backgroundColor="#7B7B7B"; cell.style.color="white"; }
            calendar.appendChild(cell);
            cell.addEventListener('click', ()=>{
                // If day has events, clicking opens event details modal
                if(events[dateStr] && events[dateStr].length>0){
                    showEventDetails(events[dateStr], dateStr);
                } else {
                    openAddEventModal(dateStr);
                }
            });
        }
    }

    // --- Initial render ---
    renderCalendar(currentYear, currentMonth);
    fetchEvents();
</script>

</body>
</html>
{% endblock %}