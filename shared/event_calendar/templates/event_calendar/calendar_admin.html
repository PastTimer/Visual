{% extends "base_internal.html" %}
{% block content %}
{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Calendar</title>

<link href="https://fonts.googleapis.com/css?family=Inter:400,500,700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer">
<link href="{% static 'shared/calendar/styles.css' %}" rel="stylesheet">
</head>
<body>

<!-- Main Calendar -->
<div id="calendar-wrapper">
    <!-- LEFT -->
    <div id="calendar-sidebar-left">
        <h2>My Calendar</h2>
        <select id="year-selector"></select>
        <ul id="month-selector">
            <li data-month="0">January</li><li data-month="1">February</li>
            <li data-month="2">March</li><li data-month="3">April</li>
            <li data-month="4">May</li><li data-month="5">June</li>
            <li data-month="6">July</li><li data-month="7">August</li>
            <li data-month="8">September</li><li data-month="9">October</li>
            <li data-month="10">November</li><li data-month="11">December</li>
        </ul>
    </div>

    <!-- CENTER -->
    <div id="calendar-container">
        <h2 id="month-name"></h2>
        <div class="weekdays">
            <div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div>
        </div>
        <div id="calendar" class="calendar-grid"></div>
    </div>

    <!-- RIGHT -->
    <div id="calendar-sidebar-right">
    <div style="height:8px;"></div>
    <ul id="event-list"></ul>
    </div>
</div>

<!-- Add Event Modal -->
<div id="add-event-modal" class="event-modal" style="display:none;align-items:center;justify-content:center;">
    <div class="event-modal-content">
        <span class="close" id="close-add-event-modal">&times;</span>
        <h2 id="add-event-modal-title">Add Meeting</h2>
        <form id="add-event-form" method="post" enctype="multipart/form-data" action="/calendar/add_event/">
            {% csrf_token %}
            <div class="form-group">
                <label class="form-label">Title <span class="required">*</span></label>
                <input type="text" name="title" id="add_event_title" required style="flex:1;">
            </div>
            <div class="form-group">
                <label class="form-label">Description <span class="required">*</span></label>
                <textarea name="description" id="add_event_description" rows="2" required style="flex:1;border-radius:8px;border:1px solid #e5e7eb;padding:0.75rem;font-size:1rem;"></textarea>
            </div>
            <div class="form-group">
                <label class="form-label">Date <span class="required">*</span></label>
                <input type="date" name="date" id="add_event_date" required style="flex:1; color: #888; pointer-events: none;" readonly tabindex="-1">
                <label class="form-label" style="margin-left:1rem;">Time <span class="required">*</span></label>
                <input type="time" name="time" id="add_event_time" required style="flex:1;">
            </div>
            <div class="form-group">
                <label class="form-label">Location <span class="required">*</span></label>
                <input type="text" name="location" id="add_event_location" required style="flex:1;">
            </div>
            <div class="form-group" style="flex-direction: column; gap:0.5rem;">
                <label class="form-label">Add to Other's Calendar</label>
                <div id="participants-tag-row" class="tag-row"></div>
                <select id="participants-options-template" style="display:none;" multiple>
                    <option value="">Select Participant</option>
                    {% for user in users %}
                        <option value="{{ user.id }}">{{ user.get_full_name|default:user.username }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="form-group">
                <label class="form-label">Notes (Optional)</label>
                <textarea name="notes" id="add_event_notes" rows="2" style="flex:1;border-radius:8px;border:1px solid #e5e7eb;padding:0.75rem;font-size:1rem;"></textarea>
            </div>
            <div class="form-actions" style="justify-content:flex-end;">
                <button type="button" class="back-btn" id="cancel-add-event-modal">Cancel</button>
                <button type="submit" class="submit-btn">Add Event</button>
            </div>
        </form>
    </div>
</div>

<!-- Edit Event Modal -->
<div id="edit-event-modal" class="event-modal" style="display:none;align-items:center;justify-content:center;">
    <div class="event-modal-content" style="max-width:600px;">
        <span class="close" id="close-edit-event-modal">&times;</span>
        <h2 id="edit-event-modal-title">Edit Event</h2>
        <form id="edit-event-form" method="post" enctype="multipart/form-data" action="/calendar/edit_event/">
            {% csrf_token %}
            <input type="hidden" name="event_id" id="edit_event_id">
            <div class="form-group">
                <label class="form-label">Title <span class="required">*</span></label>
                <input type="text" name="title" id="edit_event_title" required style="flex:1;">
            </div>
            <div class="form-group">
                <label class="form-label">Description <span class="required">*</span></label>
                <textarea name="description" id="edit_event_description" rows="2" required style="flex:1;border-radius:8px;border:1px solid #e5e7eb;padding:0.75rem;font-size:1rem;"></textarea>
            </div>
            <div class="form-group">
                <label class="form-label">Date <span class="required">*</span></label>
                <input type="date" name="date" id="edit_event_date" required style="flex:1; color: #888;">
                <label class="form-label" style="margin-left:1rem;">Time <span class="required">*</span></label>
                <input type="time" name="time" id="edit_event_time" required style="flex:1;">
            </div>
            <div class="form-group">
                <label class="form-label">Location <span class="required">*</span></label>
                <input type="text" name="location" id="edit_event_location" required style="flex:1;">
            </div>
            <div class="form-group" style="flex-direction: column; gap:0.5rem;">
                <label class="form-label">Participants</label>
                <div id="edit-participants-tag-row" class="tag-row"></div>
                <select id="edit-participants-options-template" style="display:none;" multiple>
                    <option value="">Select Participant</option>
                    {% for user in users %}
                        <option value="{{ user.id }}">{{ user.get_full_name|default:user.username }}</option>
                    {% endfor %}
                </select>
                <script id="participants-data" type="application/json"></script>
            </div>
            <div class="form-group">
                <label class="form-label">Notes (Optional)</label>
                <textarea name="notes" id="edit_event_notes" rows="2" style="flex:1;border-radius:8px;border:1px solid #e5e7eb;padding:0.75rem;font-size:1rem;"></textarea>
            </div>
            <div class="form-actions" style="justify-content:flex-end;">
                <button type="button" class="back-btn" id="cancel-edit-event-modal">Cancel</button>
                <button type="submit" class="submit-btn">Save Changes</button>
            </div>
        </form>
    </div>
</div>


<!-- Event Details Modal -->
<div id="event-details-modal" class="event-modal" style="display:none;align-items:center;justify-content:center;">
    <div class="event-modal-content" style="max-width:600px;">
        <span class="close" id="close-event-details-modal">&times;</span>
        <h2 id="event-details-title" style="margin-bottom:10px;"></h2>
        <div id="event-details-info">
            <!-- Details will be injected here -->
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div id="delete-confirm-modal" class="event-modal" style="display:none;align-items:center;justify-content:center;">
    <div style="background:white;padding:2rem 2.5rem;border-radius:16px;box-shadow:0 4px 32px rgba(0,0,0,0.18);max-width:350px;margin:auto;display:flex;flex-direction:column;align-items:center;">
        <div style="font-size:1.25rem;font-weight:600;color:#E53E3E;margin-bottom:1rem;">Confirm Deletion</div>
        <div id="delete-confirm-message" style="font-size:1rem;color:#444;margin-bottom:2rem;text-align:center;">Are you sure you want to delete this event? This action cannot be undone.</div>
        <div style="display:flex;gap:1rem;">
            <button id="cancel-delete-modal" style="background:#e5e7eb;color:#374151;padding:0.75rem 1.5rem;border-radius:8px;font-size:1rem;font-weight:500;border:none;cursor:pointer;">Cancel</button>
            <button id="confirm-delete-btn" style="background:#E53E3E;color:white;padding:0.75rem 1.5rem;border-radius:8px;font-size:1rem;font-weight:500;border:none;cursor:pointer;">Delete</button>
        </div>
    </div>
</div>

<svg>
    <!-- Add Icon -->
    <symbol id="icon-add" viewBox="0 0 16 16">
        <path d="M6.80039 14.4004C6.80039 14.7187 6.92682 15.0239 7.15186 15.2489C7.37691 15.474 7.68213 15.6004 8.00039 15.6004C8.31865 15.6004 8.62388 15.474 8.84892 15.2489C9.07396 15.0239 9.20039 14.7187 9.20039 14.4004V9.20039H14.4004C14.7187 9.20039 15.0239 9.07396 15.2489 8.84892C15.474 8.62388 15.6004 8.31865 15.6004 8.00039C15.6004 7.68213 15.474 7.37691 15.2489 7.15186C15.0239 6.92682 14.7187 6.80039 14.4004 6.80039H9.20039V1.60039C9.20039 1.28213 9.07396 0.976906 8.84892 0.751863C8.62388 0.526819 8.31865 0.400391 8.00039 0.400391C7.68213 0.400391 7.37691 0.526819 7.15186 0.751863C6.92682 0.976906 6.80039 1.28213 6.80039 1.60039V6.80039H1.60039C1.28213 6.80039 0.976906 6.92682 0.751863 7.15186C0.526819 7.37691 0.400391 7.68213 0.400391 8.00039C0.400391 8.31865 0.526819 8.62388 0.751863 8.84892C0.976906 9.07396 1.28213 9.20039 1.60039 9.20039H6.80039V14.4004Z" fill="black"/>
    </symbol>
</svg>

<!-- Participants Tagging -->
<script>
    // Edit modal logic (adapted from project_events.html)
    function openEditEventModal(eventObj) {
        document.getElementById('event-details-modal').style.display = 'none';
        document.getElementById('edit-event-modal').style.display = 'flex';
        document.getElementById('edit_event_id').value = eventObj.id;
        document.getElementById('edit_event_title').value = eventObj.title || '';
        document.getElementById('edit_event_description').value = eventObj.description || '';
        document.getElementById('edit_event_date').value = eventObj.date || '';
        document.getElementById('edit_event_time').value = eventObj.time || '';
        document.getElementById('edit_event_location').value = eventObj.location || '';
        document.getElementById('edit_event_notes').value = eventObj.notes || '';
        // Participants tag UI
        const tagRow = document.getElementById('edit-participants-tag-row');
        while (tagRow.firstChild) tagRow.removeChild(tagRow.firstChild);
        // Set JSON data for participants
        document.getElementById('participants-data').textContent = JSON.stringify(eventObj.participants || []);
        renderParticipantTags();
    }

    function renderParticipantTags() {
        const tagRow = document.getElementById('edit-participants-tag-row');
        const optionsTemplate = document.getElementById('edit-participants-options-template');
        let selectedParticipants = [];
        try {
            selectedParticipants = JSON.parse(document.getElementById('participants-data').textContent);
        } catch (e) {
            selectedParticipants = [];
        }
        tagRow.innerHTML = '';
        selectedParticipants.forEach(id => {
            const opt = Array.from(optionsTemplate.options).find(o => String(o.value) === String(id));
            if (opt) {
                const tag = document.createElement('span');
                tag.className = 'tag-box';
                tag.textContent = opt.textContent;
                const removeBtn = document.createElement('button');
                removeBtn.type = 'button';
                removeBtn.className = 'tag-remove';
                removeBtn.innerHTML = '&times;';
                removeBtn.onclick = function() {
                    selectedParticipants = selectedParticipants.filter(pid => pid !== id);
                    document.getElementById('participants-data').textContent = JSON.stringify(selectedParticipants);
                    renderParticipantTags();
                };
                tag.appendChild(removeBtn);
                tagRow.appendChild(tag);
            }
        });
        // Add button logic
        const addBtn = document.createElement('button');
        addBtn.type = 'button';
        addBtn.innerHTML = '<svg width="16" height="16"><use href="#icon-add" /></svg>';
        addBtn.className = 'tag-add-btn';
        addBtn.onclick = function(e) {
            const selectDropdown = document.createElement('select');
            selectDropdown.multiple = false;
            selectDropdown.style.position = 'absolute';
            selectDropdown.style.zIndex = 9999;
            selectDropdown.style.display = 'block';
            selectDropdown.style.left = (addBtn.getBoundingClientRect().left + window.scrollX) + 'px';
            selectDropdown.style.top = (addBtn.getBoundingClientRect().bottom + window.scrollY) + 'px';
            Array.from(optionsTemplate.options).forEach(opt => {
                if (!opt.value || selectedParticipants.includes(opt.value)) return;
                const option = document.createElement('option');
                option.value = opt.value;
                option.textContent = opt.textContent;
                selectDropdown.appendChild(option);
            });
            selectDropdown.onchange = function() {
                const selectedId = selectDropdown.value;
                if (selectedId && !selectedParticipants.includes(selectedId)) {
                    selectedParticipants.push(selectedId);
                    document.getElementById('participants-data').textContent = JSON.stringify(selectedParticipants);
                    renderParticipantTags();
                }
                selectDropdown.value = '';
                selectDropdown.style.display = 'none';
            };
            document.body.appendChild(selectDropdown);
            selectDropdown.focus();
            document.addEventListener('mousedown', function handler(e) {
                if (!selectDropdown.contains(e.target) && e.target.className !== 'tag-add-btn') {
                    selectDropdown.style.display = 'none';
                    selectDropdown.remove();
                    document.removeEventListener('mousedown', handler);
                }
            });
        };
        tagRow.appendChild(addBtn);
        selectedParticipants.forEach(id => {
            const hidden = document.createElement('input');
            hidden.type = 'hidden';
            hidden.name = 'participants[]';
            hidden.value = id;
            tagRow.appendChild(hidden);
        });
    }
    document.getElementById('close-edit-event-modal').onclick = function() {
        document.getElementById('edit-event-modal').style.display = 'none';
    };
    document.getElementById('cancel-edit-event-modal').onclick = function() {
        document.getElementById('edit-event-modal').style.display = 'none';
    };
    document.getElementById('edit-event-modal').onclick = function(e) {
        if (e.target === this) {
            this.style.display = 'none';
        }
    };
    // Handle edit event form submit
    editEventForm.onsubmit = function(e) {
        e.preventDefault();
        const event_id = document.getElementById('edit_event_id').value;
        const title = document.getElementById('edit_event_title').value.trim();
        const description = document.getElementById('edit_event_description').value.trim();
        const date = document.getElementById('edit_event_date').value;
        const time = document.getElementById('edit_event_time').value;
        const location = document.getElementById('edit_event_location').value.trim();
        const participants = Array.from(document.querySelectorAll('#edit-participants-tag-row input[name="participants[]"]')).map(input => input.value);
        const notes = document.getElementById('edit_event_notes').value.trim();
        if (!event_id || !title || !description || !date || !time || !location) {
            alert('Please fill in all required fields.');
            return;
        }
        const csrfToken = document.querySelector('input[name="csrfmiddlewaretoken"]').value;
        
        // MODIFIED: Use new RESTful URL and PUT method
        fetch('/calendar/events/' + event_id + '/', {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({
                event_id, title, description, date, time, location, participants, notes
            })
        }).then(r => r.json()).then(resp => {
            if (resp.status === 'success') {
                editEventModal.style.display = 'none';
                // MODIFIED: Fetch from new events endpoint
                fetch('/calendar/events/')
                  .then(r => r.json())
                  .then(data => {
                      events = data;
                      renderCalendar(currentYear, currentMonth);
                      fetchEvents();
                  })
                  .catch(err => {
                      alert('Could not refresh events: ' + err.message);
                      renderCalendar(currentYear, currentMonth);
                      fetchEvents();
                  });
            } else {
                alert('Error: ' + JSON.stringify(resp.errors || resp));
            }
        }).catch(err => alert('Network error: ' + err.message));
    };
    
    // Placeholder for fetchEvents function
    function fetchEvents() {
        // Display events for the selected month in the right sidebar with categories
        const eventList = document.getElementById('event-list');
        eventList.innerHTML = '';
        const todayStr = `${currentYear}-${String(currentMonth+1).padStart(2,'0')}-${String(new Date().getDate()).padStart(2,'0')}`;
        let todayEvents = [], meetings = [], projects = [], done = [];
        const today = new Date();
        for (const dateStr in events) {
            if (events.hasOwnProperty(dateStr)) {
                const dateObj = new Date(dateStr);
                if (dateObj.getFullYear() === currentYear && dateObj.getMonth() === currentMonth) {
                    events[dateStr].forEach(ev => {
                        const isPast = dateObj < today;
                        if (isPast) {
                            done.push({...ev, dateStr});
                        } else if (dateStr === todayStr) {
                            todayEvents.push({...ev, dateStr});
                        } else if (ev.type === 'meeting') {
                            meetings.push({...ev, dateStr});
                        } else if (ev.type === 'project') {
                            projects.push({...ev, dateStr});
                        }
                    });
                }
            }
        }
        // Helper to render items
        function renderItems(arr, type) {
            arr.forEach(ev => {
                const li = document.createElement('li');
                li.className = 'sidebar-event-item';
                li.style.cursor = 'pointer';
                li.style.color = '#fff';
                let titleColor = (ev.type === 'meeting') ? '#3A7CA5' : (ev.type === 'project') ? '#245F3E' : '#fff';
                li.innerHTML = `<span style='font-weight:600;font-size:1.1em;color:${titleColor};'>${ev.title}</span><br><span style='font-size:0.95em;color:#bbb;'>${ev.dateStr}</span>`;
                li.onclick = function(e) {
                    e.stopPropagation();
                    showEventDetails([ev], ev.dateStr);
                };
                eventList.appendChild(li);
            });
        }
        // Today
        if (todayEvents.length) {
            const h = document.createElement('h4');
            h.textContent = 'Today';
            h.style.color = '';
            eventList.appendChild(h);
            renderItems(todayEvents);
        }
        // Meetings
        if (meetings.length) {
            const h = document.createElement('h4');
            h.textContent = 'Meetings';
            h.style.color = '';
            eventList.appendChild(h);
            renderItems(meetings, 'meeting');
        }
        // Events (Projects)
        if (projects.length) {
            const h = document.createElement('h4');
            h.textContent = 'Events';
            h.style.color = '';
            eventList.appendChild(h);
            renderItems(projects, 'project');
        }
        // Done
        if (done.length) {
            const h = document.createElement('h4');
            h.textContent = 'Done';
            h.style.color = '#bbb';
            eventList.appendChild(h);
            done.forEach(ev => {
                const li = document.createElement('li');
                li.style.color = '#bbb';
                li.style.textDecoration = 'line-through';
                li.style.opacity = '0.7';
                let titleColor = (ev.type === 'meeting') ? '#3A7CA5' : (ev.type === 'project') ? '#245F3E' : '#bbb';
                li.innerHTML = `<span style='font-weight:600;font-size:1.1em;color:${titleColor};'>${ev.title}</span><br><span style='font-size:0.95em;color:#bbb;'>${ev.dateStr}</span>`;
                eventList.appendChild(li);
            });
        }
        if (!todayEvents.length && !meetings.length && !projects.length && !done.length) {
            eventList.innerHTML = '<li>No events this month.</li>';
        }
    }
    // Tag UI logic for participants (similar to providers in add_project)
    function setupTagUI(rowId, templateId, inputName, single=false) {
        var tagRow = document.getElementById(rowId);
        var templateOptions = Array.from(document.getElementById(templateId).options);
        var selected = [];
        var excludeIds = [];
        var selectDropdown = document.createElement('select');
        selectDropdown.multiple = !single;
        selectDropdown.style.position = 'absolute';
        selectDropdown.style.zIndex = 9999;
        selectDropdown.style.display = 'none';
        function renderTags() {
            tagRow.innerHTML = '';
            selected.forEach(cid => {
                var opt = templateOptions.find(o => o.value == cid);
                if (opt) {
                    var tag = document.createElement('span');
                    tag.className = 'tag-box';
                    tag.textContent = opt.textContent;
                    var removeBtn = document.createElement('button');
                    removeBtn.type = 'button';
                    removeBtn.innerHTML = '<span class="tag-remove">&times;</span>';
                    removeBtn.className = 'tag-remove';
                    removeBtn.onclick = function() {
                        selected = selected.filter(id => id != cid);
                        renderTags();
                    };
                    tag.appendChild(removeBtn);
                    tagRow.appendChild(tag);
                }
            });
            var addBtn = document.createElement('button');
            addBtn.type = 'button';
            addBtn.innerHTML = '<svg width="16" height="16"><use href="#icon-add" /></svg>';
            addBtn.className = 'tag-add-btn';
            addBtn.onclick = function(e) {
                selectDropdown.innerHTML = '';
                var template = document.getElementById(templateId);
                Array.from(template.options).forEach(opt => {
                    if (!opt.value || selected.includes(opt.value) || excludeIds.includes(opt.value)) return;
                    var option = document.createElement('option');
                    option.value = opt.value;
                    option.textContent = opt.textContent;
                    selectDropdown.appendChild(option);
                });
                selectDropdown.style.display = 'block';
                selectDropdown.style.position = 'absolute';
                selectDropdown.style.left = (addBtn.getBoundingClientRect().left + window.scrollX) + 'px';
                selectDropdown.style.top = (addBtn.getBoundingClientRect().bottom + window.scrollY) + 'px';
                document.body.appendChild(selectDropdown);
                selectDropdown.focus();
            };
            tagRow.appendChild(addBtn);
            selected.forEach(cid => {
                var hidden = document.createElement('input');
                hidden.type = 'hidden';
                hidden.name = inputName + (single ? '' : '[]');
                hidden.value = cid;
                tagRow.appendChild(hidden);
            });
        }
        selectDropdown.onchange = function() {
            var selectedId = selectDropdown.value;
            if (selectedId && !selected.includes(selectedId)) {
                if (single) {
                    selected = [selectedId];
                } else {
                    selected.push(selectedId);
                }
                renderTags();
            }
            selectDropdown.value = '';
            selectDropdown.style.display = 'none';
        };
        document.addEventListener('mousedown', function(e) {
            if (selectDropdown && !selectDropdown.contains(e.target) && e.target.className !== 'add-tag-btn') {
                selectDropdown.style.display = 'none';
            }
        });
        tagRow.appendChild(selectDropdown);
        renderTags();
        function setSelected(ids) {
            selected = Array.isArray(ids) ? ids.slice() : [];
            renderTags();
        }
        return {
            getSelected: () => selected.slice(),
            setExclude: (ids) => { excludeIds = ids; renderTags(); },
            setSelected,
        };
    }
    document.addEventListener('DOMContentLoaded', function() {
        setupTagUI('participants-tag-row', 'participants-options-template', 'participants');
    });
</script>

<!-- Add Event Modal -->
<script>
    // --- Add Event Modal Logic ---
    const addEventModal = document.getElementById('add-event-modal');
    const closeAddEventModal = document.getElementById('close-add-event-modal');
    const cancelAddEventModal = document.getElementById('cancel-add-event-modal');
    const addEventForm = document.getElementById('add-event-form');
    const addEventDateInput = document.getElementById('add_event_date');

    function openAddEventModal(dateStr) {
        // Reset all form fields
        document.getElementById('add_event_title').value = '';
        document.getElementById('add_event_description').value = '';
        document.getElementById('add_event_time').value = '';
        document.getElementById('add_event_location').value = '';
        document.getElementById('add_event_notes').value = '';
        // Remove all participant tags
        const tagRow = document.getElementById('participants-tag-row');
        while (tagRow.firstChild) tagRow.removeChild(tagRow.firstChild);
        // Re-initialize tag UI
        setupTagUI('participants-tag-row', 'participants-options-template', 'participants');
        addEventDateInput.value = dateStr;
        addEventModal.style.display = 'flex';
    }

    closeAddEventModal.onclick = function() { addEventModal.style.display = 'none'; };
    cancelAddEventModal.onclick = function() { addEventModal.style.display = 'none'; };
    addEventModal.onclick = function(e) { if (e.target === addEventModal) addEventModal.style.display = 'none'; };

    // Intercept form submit for AJAX
    addEventForm.onsubmit = function(e) {
        e.preventDefault();
        const title = document.getElementById('add_event_title').value.trim();
        const description = document.getElementById('add_event_description').value.trim();
        const date = document.getElementById('add_event_date').value;
        const time = document.getElementById('add_event_time').value;
        const location = document.getElementById('add_event_location').value.trim();
        const participants = Array.from(document.querySelectorAll('#participants-tag-row input[name="participants[]"]')).map(input => input.value);
        const notes = document.getElementById('add_event_notes').value.trim();
        if (!title || !description || !date || !time || !location) {
            alert('Please fill in all required fields.');
            return;
        }
        const csrfToken = document.querySelector('input[name="csrfmiddlewaretoken"]').value;
        
        // MODIFIED: Use new RESTful URL
        fetch('/calendar/events/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({
                title, description, date, time, location, participants, notes
            })
        })
        .then(function(r) { return r.json(); })
        .then(function(resp) {
            if (resp.status === 'success') {
                addEventModal.style.display = 'none';
                
                // MODIFIED: Fetch from new events endpoint (This fixes the bug)
                fetch('/calendar/events/')
                  .then(function(r) { return r.json(); })
                  .then(function(data) {
                      events = data;
                      renderCalendar(currentYear, currentMonth); // update calendar grid
                      fetchEvents(); // update sidebar event list
                  })
                  .catch(function(err) {
                      alert('Could not refresh events: ' + err.message);
                      renderCalendar(currentYear, currentMonth);
                      fetchEvents();
                  });
            } else {
                alert('Error: ' + JSON.stringify(resp.errors || resp));
            }
        })
        .catch(function(err) {
            alert('Network error: ' + err.message);
        });
    };

    // Hook up calendar day click to open modal
    function renderCalendar(year, month) {
        const monthNames=["January","February","March","April","May","June","July","August","September","October","November","December"];
        document.getElementById('month-name').textContent=monthNames[month];
        calendar.innerHTML='';
        const firstDay=new Date(year,month,1).getDay();
        const daysInMonth=new Date(year,month+1,0).getDate();
        for(let i=0;i<firstDay;i++){ calendar.appendChild(document.createElement('div')); }
        for(let d=1;d<=daysInMonth;d++){
            const cell=document.createElement('div');
            const dateStr=`${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
            cell.className='calendar-day';
            cell.textContent=d;
            cell.dataset.date=dateStr;
            if(events[dateStr]){
                let hasMeeting = events[dateStr].some(ev => ev.type === 'meeting');
                let hasProject = events[dateStr].some(ev => ev.type === 'project');
                // Determine if all events are done (past date)
                const today = new Date();
                const cellDate = new Date(year, month, d);
                let isPast = cellDate < today;
                if (isPast) {
                    // Faded blue/green for done
                    if (hasMeeting && hasProject) {
                        cell.classList.add('gradient-faded');
                    } else if (hasMeeting) {
                        cell.classList.add('meeting-faded');
                    } else if (hasProject) {
                        cell.classList.add('project-faded');
                    }
                    cell.style.color = '#eee';
                } else {
                    if (hasMeeting && hasProject) {
                        cell.classList.add('gradient');
                        cell.style.color = 'white';
                    } else if (hasMeeting) {
                        cell.classList.add('meeting');
                        cell.style.color = 'white';
                    } else if (hasProject) {
                        cell.classList.add('project');
                        cell.style.color = 'white';
                    }
                }
                cell.style.cursor = "pointer";
                cell.onclick = function() {
                    showEventDetails(events[dateStr], dateStr);
                };
            } else {
                cell.onclick = function() {
                    openAddEventModal(dateStr);
                };
            }
            // Highlight current day
            const today = new Date();
            if (year === today.getFullYear() && month === today.getMonth() && d === today.getDate()) {
                cell.style.border = '2px solid #FFE066';
                cell.style.boxShadow = '0 0 0 2px #FFE066';
            }
            calendar.appendChild(cell);
        }
    }

    // Event Details Modal Logic
    const eventDetailsModal = document.getElementById('event-details-modal');
    const closeEventDetailsModal = document.getElementById('close-event-details-modal');
    closeEventDetailsModal.onclick = function() { eventDetailsModal.style.display = 'none'; };
    eventDetailsModal.onclick = function(e) { if (e.target === eventDetailsModal) eventDetailsModal.style.display = 'none'; };

    function showEventDetails(eventArr, dateStr) {
        eventDetailsModal.style.display = 'flex';
        let html = '';
        const currentUserId = "{{ request.user.id|default:'' }}";
        const currentUserRole = "{{ request.user.role|default:''|escapejs }}";
        eventArr.forEach(ev => {
            if (ev.type === 'meeting') {
                let canEdit = false;
                if (currentUserId !== "" && (ev.created_by == currentUserId || ["DIRECTOR","UESO","VP"].includes(currentUserRole))) {
                    canEdit = true;
                }
                html += `<div class="event-details-row" style="display:flex;align-items:center;">
                    <div style="font-size:1.5rem;font-weight:600;color:#3A7CA5;margin-bottom:0.3rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:100%;flex:1;">${ev.title}</div>
                    ${canEdit ? `<i class='fa-solid fa-pen-to-square' style='font-size:1.3rem;color:#3A7CA5;cursor:pointer;margin-left:10px;' title='Edit' onclick='window.openEditEventModal(${JSON.stringify(ev)})'></i>` : ''}
                    ${canEdit ? `<i class='fa-solid fa-trash' style='font-size:1.3rem;color:#E53E3E;cursor:pointer;margin-left:10px;' title='Delete' onclick='window.confirmDeleteEvent(${ev.id}, ${JSON.stringify(ev.title)})'></i>` : ''}
                </div>
                <div style="font-size:1.1rem;font-weight:400;color:#222;margin-bottom:0.2rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:100%">${ev.description}</div>
                <div style="font-size:1rem;color:#666;margin-bottom:0.2rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:100%">${ev.date} at ${ev.time}</div>
                <div style="font-size:1.1rem;color:#333;margin-bottom:0.2rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:100%">${ev.location}</div>
                ${ev.participant_names && ev.participant_names.length ? `<div style='font-size:0.95em;color:#555;margin-bottom:0.2rem;'><b>Participants:</b> <span style='font-size:0.95em;'>${ev.participant_names.join(", ")}</span></div>` : ''}
                ${ev.notes && ev.notes.trim() ? `<div style=\"font-size:1rem;color:#888;margin-top:0.3rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:100%\">${ev.notes}</div>` : ''}
                <hr style="margin:10px 0;">`;
            } else if (ev.type === 'project') {
                html += `<div class="event-details-row" style="display:flex;align-items:center;">
                    <div style="font-size:1.5rem;font-weight:600;color:#245F3E;margin-bottom:0.3rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:100%;flex:1;">${ev.title}</div>
                    <span style='font-size:1.1rem;color:#245F3E;cursor:pointer;margin-left:10px;' title='Go to event' onclick='window.location.href="/projects/${ev.project_id}/"'>Go To Project <i class="fa-solid fa-arrow-right"></i></span>
                </div>
                ${ev.project_name ? `<div style='font-size:1.05em;color:#245F3E;margin-bottom:0.2rem;'><b>Project:</b> <span style='font-size:1.05em;'>${ev.project_name}</span></div>` : ''}
                <div style="font-size:1.1rem;font-weight:400;color:#222;margin-bottom:0.2rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:100%">${ev.description}</div>
                <div style="font-size:1rem;color:#666;margin-bottom:0.2rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:100%">${ev.date} at ${ev.time}</div>
                <div style="font-size:1.1rem;color:#333;margin-bottom:0.2rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:100%">${ev.location}</div>
                ${ev.leader ? `<div style='font-size:0.95em;color:#555;margin-bottom:0.2rem;'><b>Leader:</b> <span style='font-size:0.95em;'>${ev.leader}</span></div>` : ''}
                ${ev.provider_names && ev.provider_names.length ? `<div style='font-size:0.95em;color:#555;margin-bottom:0.2rem;'><b>Providers:</b> <span style='font-size:0.95em;'>${ev.provider_names.join(", ")}</span></div>` : ''}
                ${ev.notes && ev.notes.trim() ? `<div style=\"font-size:1rem;color:#888;margin-top:0.3rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:100%\">${ev.notes}</div>` : ''}
                <hr style="margin:10px 0;">`;
            }
        });
    // Add button below <hr> and center it
    html += `<div style='width:100%;text-align:center;margin-top:18px;'><button id='add-another-event-btn' style='background:#245F3E;color:#fff;border:none;border-radius:24px;padding:12px 32px;font-size:1.1rem;box-shadow:0 2px 8px rgba(0,0,0,0.08);cursor:pointer;'>Add Meeting</button></div>`;
        document.getElementById('event-details-title').textContent = eventArr.length === 1 ? '' : `Events on ${dateStr}`;
        document.getElementById('event-details-info').innerHTML = html;
        // Add event handler for button
        setTimeout(function() {
            const btn = document.getElementById('add-another-event-btn');
            if (btn) {
                btn.onclick = function(e) {
                    e.stopPropagation();
                    eventDetailsModal.style.display = 'none';
                    openAddEventModal(dateStr);
                };
            }
        }, 0);
    }

    // Delete event logic
    window.confirmDeleteEvent = function(eventId, eventTitle) {
        // Hide all other modals
        document.getElementById('event-details-modal').style.display = 'none';
        document.getElementById('edit-event-modal').style.display = 'none';
        // Show only the delete modal
        document.getElementById('delete-confirm-modal').style.display = 'flex';
        document.getElementById('delete-confirm-message').textContent = `Are you sure you want to delete "${eventTitle}"? This action cannot be undone.`;
        pendingDeleteEventId = eventId;
        pendingDeleteEventTitle = eventTitle;
    };

    document.getElementById('cancel-delete-modal').onclick = function() {
        document.getElementById('delete-confirm-modal').style.display = 'none';
    };
    document.getElementById('delete-confirm-modal').onclick = function(e) {
        if (e.target === this) {
            this.style.display = 'none';
        }
    };
    document.getElementById('confirm-delete-btn').onclick = function() {
        if (pendingDeleteEventId) {
            deleteEvent(pendingDeleteEventId);
        }
        document.getElementById('delete-confirm-modal').style.display = 'none';
    };

    function deleteEvent(eventId) {
        const csrfToken = document.querySelector('input[name="csrfmiddlewaretoken"]').value;
        
        // MODIFIED: Use new RESTful URL and DELETE method
        fetch('/calendar/events/' + eventId + '/', {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({})
        })
        .then(function(r) { return r.json(); })
        .then(function(resp) {
            if (resp.status === 'success') {
                document.getElementById('event-details-modal').style.display = 'none';
                
                // MODIFIED: Fetch from new events endpoint
                fetch('/calendar/events/')
                  .then(function(r) { return r.json(); })
                  .then(function(data) {
                      events = data;
                      renderCalendar(currentYear, currentMonth);
                      fetchEvents();
                  })
                  .catch(function(err) {
                      alert('Could not refresh events: ' + err.message);
                      renderCalendar(currentYear, currentMonth);
                      fetchEvents();
                  });
            } else {
                alert('Error: ' + JSON.stringify(resp.errors || resp));
            }
        })
        .catch(function(err) {
            alert('Network error: ' + err.message);
        });
    }
</script>

<!-- Render Calendar Scripts -->
<script>
    let events = {};
    const calendar = document.getElementById('calendar');
    const eventList = document.getElementById('event-list');
    
    // Check if there's an initial date from query parameter
    {% if initial_date %}
    const initialDate = new Date('{{ initial_date }}');
    let currentYear = initialDate.getFullYear();
    let currentMonth = initialDate.getMonth();
    {% else %}
    let currentYear = new Date().getFullYear();
    let currentMonth = new Date().getMonth();
    {% endif %}
    
    let selectedDate = null;

    // Populate year dropdown (current-10 to current+10)
    const yearSelector = document.getElementById("year-selector");
    for(let y=currentYear-10;y<=currentYear+10;y++){
        const opt=document.createElement("option");
        opt.value=y; opt.textContent=y;
        if(y===currentYear) opt.selected=true;
        yearSelector.appendChild(opt);
    }

    // Month click
    document.querySelectorAll('#month-selector li').forEach(li=>{
        li.onclick=()=>{
            currentMonth=parseInt(li.dataset.month);
            renderCalendar(currentYear,currentMonth);
            fetchEvents();
            document.querySelectorAll('#month-selector li').forEach(l=>l.classList.remove('active'));
            li.classList.add('active');
        };
    });

    // Set initial active month
    document.querySelectorAll('#month-selector li')[currentMonth].classList.add('active');

    // Fetch events on initial load to ensure role-restricted view
    window.addEventListener('DOMContentLoaded', function() {
        // MODIFIED: Fetch from new events endpoint
        fetch('/calendar/events/')
            .then(r => r.json())
            .then(data => {
                events = data;
                renderCalendar(currentYear, currentMonth);
                fetchEvents();
                
                // Highlight date if coming from notification
                {% if initial_date %}
                highlightDate('{{ initial_date }}');
                {% endif %}
            })
            .catch(err => {
                alert('Could not load events: ' + err.message);
                renderCalendar(currentYear, currentMonth);
                fetchEvents();
            });
    });

    yearSelector.onchange=()=>{currentYear=parseInt(yearSelector.value); renderCalendar(currentYear,currentMonth); fetchEvents();};

    function renderCalendar(year,month){
        const monthNames=["January","February","March","April","May","June","July","August","September","October","November","December"];
        document.getElementById('month-name').textContent=monthNames[month];
        calendar.innerHTML='';
        const firstDay=new Date(year,month,1).getDay();
        const daysInMonth=new Date(year,month+1,0).getDate();
        for(let i=0;i<firstDay;i++){ calendar.appendChild(document.createElement('div')); }
        for(let d=1;d<=daysInMonth;d++){
            const cell=document.createElement('div');
            const dateStr=`${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
            cell.className='calendar-day';
            cell.textContent=d;
            cell.dataset.date=dateStr;
            if(events[dateStr]){
                let hasMeeting = events[dateStr].some(ev => ev.type === 'meeting');
                let hasProject = events[dateStr].some(ev => ev.type === 'project');
                // Determine if all events are done (past date)
                const today = new Date();
                const cellDate = new Date(year, month, d);
                let isPast = cellDate < new Date(today.getFullYear(), today.getMonth(), today.getDate());
                if (isPast) {
                    // Faded blue/green for done
                    if (hasMeeting && hasProject) {
                        cell.style.background = 'linear-gradient(90deg, #A9C6DD 50%, #B6D3C2 50%)';
                    } else if (hasMeeting) {
                        cell.style.backgroundColor = '#A9C6DD';
                    } else if (hasProject) {
                        cell.style.backgroundColor = '#B6D3C2';
                    }
                    cell.style.color = '#eee';
                } else {
                    if (hasMeeting && hasProject) {
                        cell.style.background = 'linear-gradient(90deg, #3A7CA5 50%, #245F3E 50%)';
                        cell.style.color = 'white';
                    } else if (hasMeeting) {
                        cell.style.backgroundColor = '#3A7CA5';
                        cell.style.color = 'white';
                    } else if (hasProject) {
                        cell.style.backgroundColor = '#245F3E';
                        cell.style.color = 'white';
                    }
                }
                cell.style.cursor = "pointer";
                cell.onclick = function() {
                    showEventDetails(events[dateStr], dateStr);
                };
            } else {
                cell.onclick = function() {
                    openAddEventModal(dateStr);
                };
            }
            // Highlight current day
            const today = new Date();
            if (year === today.getFullYear() && month === today.getMonth() && d === today.getDate()) {
                cell.style.border = '2px solid #FFE066';
                cell.style.boxShadow = '0 0 0 2px #FFE066';
            }
            calendar.appendChild(cell);
        }
    }

    // --- Initial render ---
    renderCalendar(currentYear, currentMonth);
    fetchEvents();
    
    // Function to highlight a specific date from notification
    function highlightDate(dateStr) {
        setTimeout(() => {
            const cell = document.querySelector(`.calendar-day[data-date="${dateStr}"]`);
            if (cell) {
                // Scroll to the calendar if needed
                cell.scrollIntoView({ behavior: 'smooth', block: 'center' });
                
                // Add a prominent highlight
                cell.style.border = '3px solid rgba(0, 0, 0, 0.2)';
                cell.style.boxShadow = '0 0 10px rgba(0, 0, 0, 0.5)';
                cell.style.transform = 'scale(1.1)';
                cell.style.zIndex = '10';
                cell.style.position = 'relative';
                
                // Click the date to show events
                cell.click();
                
                // Remove the extra highlight after 3 seconds (keep the events open)
                setTimeout(() => {
                    cell.style.transform = '';
                    cell.style.zIndex = '';
                    cell.style.position = '';
                }, 3000);
            }
        }, 500); // Wait for calendar to render
    }
</script>

</body>
</html>
{% endblock %}