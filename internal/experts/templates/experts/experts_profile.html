{% extends "base_internal.html" %}
{% load static %}

{% block content %}
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <style>
        body {
            font-family: Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            background-color: #e9e9e9;
        }

        main {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: stretch;
            gap: 3rem;
        }

        header {
            background-color: #245F3E;
            position: relative;
            top: 0;
            width: 100%;
            padding: 0;
            height: 4rem;
        }

        footer {
            background-color: #245F3E;
            position: relative;
            bottom: 0;
            width: 100%;
            height: 20rem;
        }

        main > section {
            display: flex;
            flex-direction: row;
            justify-content: center;
            align-items: flex-start;
            width: 100%;
            flex-wrap: wrap;
            background-color: #fbfbfb;
            box-shadow: 0 6px 0.5rem rgba(0, 0, 0, 0.2);
        }

        section > div {
            margin: 3rem;
            height: 100%;
            display: block;
            max-width: none;
        }

        .propic img {
            width: 15rem;
            height: 15rem;
            object-fit: cover;
            border-radius: 50%;
            box-shadow: 0 2px 1rem rgba(0, 0, 0, 0.2);
        }

        section > div > h1 {
            font-size: 4rem;
            font-weight: 400;
            margin-bottom: 1rem;
        }

        section > div > h5 {
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 0.35rem;
        }

        section > div > p {
            font-size: 1rem;
            font-weight: 400;
            margin: 0 0 1rem 0;
            line-height: 1.25;
        }

        .personal-info {
            display: block;
            flex-basis: 20rem;
            flex-grow: 1;
            margin: 3rem 1rem;
        }

        .personal-info h2 {
            font-size: 2rem;
            font-weight: 300;
        }

        .personal-info h4 {
            font-size: 1rem;
            font-weight: 400;
            margin-top: -1rem;
            margin-bottom: 1rem;
        }

        .personal-info img {
            border-radius: 50%;
            max-height: 5rem;
        }

        .expertise {
            margin: 3rem 1rem;
            flex-basis: 17rem;
            flex-grow: 1;
        }

        .contact {
            margin: 3rem 1rem;
            flex-basis: 17rem;
            flex-grow: 1;
        }

        .bio {
            background-color: whitesmoke;
            flex-basis: 20rem;
            flex-grow: 1;
            padding: 0.5rem 2.5rem;
            margin: 1rem 0.75rem;
        }

        .lower {
            background-color: #e9e9e9;
        }

        .lower-header {
            border-bottom: 1px solid #ccc;
            margin: 0 -2.5rem 0 -2.5rem;
            padding: 0 2.5rem;
            display: flex;
            flex-direction: row;
            justify-content: space-between;
        }

        .lower-header h1 {
            font-size: 1.5rem;
            font-weight: 500;
        }

        .project {
            background-color: whitesmoke;
            flex-basis: 35rem;
            flex-grow: 2;
            padding: 0.5rem 2.5rem;
            margin: 1rem 0.75rem;
        }

        .dropdown {
            position: relative;
            width: 9.5rem;
        }

        .dropdown-btn {
            margin: 0.75rem;
            border: 0.08rem solid whitesmoke;
            width: 100%;
            padding: 0.5rem;
            border-radius: 0.75rem;
            background: none;
            text-align: center;
            cursor: pointer;
            font-family: Helvetica, Arial, sans-serif;
            font-weight: 400;
            font-size: 1rem;
        }

        .dropdown-btn:hover {
            border: 0.08rem solid #000000;
        }

        .dropdown-menu {
            position: absolute;
            top: 100%;
            left: 0;
            margin: 0;
            right: 0;
            width: 100%;
            background: white;
            border: 0.08rem solid #ccc;
            border-radius: 0.75rem;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            z-index: 10;
            overflow: hidden;
        }

        .dropdown-item {
            padding: 0.75rem;
            cursor: pointer;
            transition: background 0.2s;
            font-family: Helvetica, Arial, sans-serif;
            font-weight: 400;
            text-align: center;
            border-bottom: 1px solid rgb(196, 196, 196);
        }

        .dropdown-item:hover {
            background-color: #000000;
            color: white;
        }

        .hidden {
            display: none;
        }

        .sort-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            color: #333;
            margin-left: 0.5rem;
        }

        .project-card {
            display: grid;
            grid-template-rows: 1fr 1fr;
            gap: 0;
            margin: -0.5rem -2.5rem;
        }

        .project-card > div {
            border-bottom: 1px rgb(122, 122, 122) solid;
            padding: 1rem 3rem;
            margin-bottom: 0;
        }

        .project-card h5 {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 0.5rem;
            font-weight: 300;
        }

        .title {
            font-size: 1.5rem;
            font-weight: 500;
            margin: 0.25rem 0 1rem 0;
            color: #222;
            text-decoration: none;
        }

        .title:hover {
            color: #007bff;
            text-decoration: none;
        }

        .project-authors {
            display: flex;
            flex-direction: row;
            align-items: center;
            gap: 1rem;
            margin: 1rem 0;
        }

        .project-authors content {
            display: flex;
            flex-direction: row;
            align-items: center;
            gap: 0.75rem;
        }

        .project-authors img {
            width: 2.5rem;
            height: 2.5rem;
            border-radius: 50%;
            object-fit: cover;
            border: 0.08rem solid #ccc;
        }

        .project-authors a {
            font-size: 0.9rem;
            color: #000000;
            text-decoration: none;
        }

        .project-authors a:hover {
            color: #007bff;
        }

        .view {
            display: inline-block;
            margin-top: 0.75rem;
            font-size: 0.9rem;
            color: #007bff;
            text-decoration: none;
        }

        .view:hover {
            text-decoration: underline;
        }

        .project-tags {
            margin: 1rem 0;
        }

        .campus {
            background-color: #ff9f10;
            color: rgb(55, 39, 0);
            border: 0.08rem solid #ff9f10;
            font-weight: 600;
            padding: 0.35rem 0.6rem;
            margin-right: 0.5rem;
            cursor: pointer;
        }

        .agenda {
            background: linear-gradient(90deg, white, #00ff6e3d);
            color: #313131;
            border: 0.08rem solid #313131;
            font-weight: 500;
            padding: 0.35rem 0.6rem;
            margin-right: 0.5rem;
            cursor: pointer;
        }

        .status {
            background-color: whitesmoke;
            color: #1CB889;
            border: 0.08rem solid #1CB889;
            font-weight: 500;
            padding: 0.35rem 0.6rem;
            margin-right: 0.5rem;
            cursor: pointer;
        }

        @media (max-width: 600px) {
            .personal-info, .expertise, .contact, .bio, .project {
                flex-basis: 100%;
                margin-left: 0.5rem;
                margin-right: 0.5rem;
            }
            section:first-child {
                justify-content: center;
            }
        }
    </style>
    <main> 
        <section>
            <div class="propic">
                {% if expert.profile_picture %}
                <img src="{{ expert.profile_picture.url }}" class="propic" alt="{{ expert.get_full_name|default:'Profile Picture' }}">
                {% else %}
                <img src="{% static 'users/default_profile.png' %}" class="propic" alt="profile picture placeholder">
                {% endif %}
            </div>
            <div class="personal-info">
                <h2>{{ expert.get_full_name|default:"Expert Name N/A" }}</h2>
                <h4><i class="fas fa-map-marker-alt" style="color:red; margin-right:0.5rem;"></i> {{ expert.get_campus_display|default:"Campus N/A" }}</h4>
                {% if expert.college and expert.college.logo %}
                <img src="{{ expert.college.logo.url }}" alt="{{ expert.college.name }} logo">
                {% else %}
                <img src="{% static 'college/psu.png' %}" alt="college placeholder">
                {% endif %}
            </div>
            <div class="expertise">
                <h5>Field of Expertise:</h5>
                <p>{{ expert.expertise|default:"Not specified" }}</p>
                <h5>Highest Education:</h5>
                <p>{{ expert.degree|default:"No Degree Listed" }}</p>
            </div>
            <div class="contact">
                <h5>Email:</h5>
                <p>{{ expert.email|default:"Not available" }}</p>
                {% if expert.contact_no %}
                <h5>Contact Number:</h5>
                <p>{{ expert.contact_no }}</p>
                {% endif %}
            </div>
        </section>
        <section class="lower">
            <div class="bio">
                <div class="lower-header">
                    <h1>Bio</h1>
                </div>
                <p style="margin-top: 1rem;">{{ expert.bio|default:"No biographical information available for this expert." }}</p>
            </div>
            <div class="project">
                <div class="lower-header"> 
                    <div>
                        <h1>Projects ({{ expert.led_projects.count|add:expert.member_projects.count }})</h1>
                    </div>
                    <div style="display: flex; flex-shrink: 3;">
                        <button class="sort-btn">
                            <i class="fas fa-arrow-up"></i>
                        </button>
                        <div class="dropdown">
                            <button class="dropdown-btn">Sort by ▾</button>
                            <div class="dropdown-menu hidden">
                                <div class="dropdown-item">Name</div>
                                <div class="dropdown-item">Date Completed</div>
                                <div class="dropdown-item">Last Updated</div>
                                <div class="dropdown-item">Q4</div>
                            </div>
                        </div> 
                    </div>
                </div>
                <div class="project-card"> 
                    
                    {# Loop 1: Projects where the expert is the Leader #}
                    {% for project in expert.led_projects.all %}
                    <div>
                        <h5>{{ project.start_date|date:"F Y" }} (Leader)</h5>
                        {# CORRECTED: Using pk=project.id for NoReverseMatch fix #}
                        <a href="{% url 'project_profile' pk=project.id %}" class="title">{{ project.title|default:"Project Title N/A" }}</a>
                        
                        <section class="project-tags">
                            <button class="campus">{{ project.primary_location|default:"Location N/A" }}</button>
                            <button class="agenda">{{ project.agenda.name|default:"Agenda N/A" }}</button>
                            <button class="status">{{ project.get_status_display|default:"Status N/A" }}</button>
                        </section>
                        
                        <section class="project-authors"> 
                            {# Project Leader #}
                            {% with leader=project.project_leader %}
                                <content>
                                    <img src="{% if leader.profile_picture %}{{ leader.profile_picture.url }}{% else %}{% static 'users/default_profile.png' %}{% endif %}" alt="{{ leader.get_full_name }}">
                                    <a href="{% url 'expert_profile' user_id=leader.id %}">{{ leader.get_full_name|default:'Leader N/A' }}</a> 
                                </content>
                            {% endwith %}
                            {# Other Providers #}
                            {% for provider in project.providers.all|slice:":2" %}
                                <content>
                                    <img src="{% if provider.profile_picture %}{{ provider.profile_picture.url }}{% else %}{% static 'users/default_profile.png' %}{% endif %}" alt="{{ provider.get_full_name }}">
                                    <a href="{% url 'expert_profile' user_id=provider.id %}">{{ provider.get_full_name|default:'Provider N/A' }}</a> 
                                </content>
                            {% endfor %}
                            {% if project.providers.count > 2 %}
                                <p>...and {{ project.providers.count|add:-2 }} others</p>
                            {% endif %}
                        </section>

                        {# CORRECTED: Using pk=project.id for NoReverseMatch fix #}
                        <a href="{% url 'project_profile' pk=project.id %}" class="view">View Project Details</a> 
                    </div> 
                    {% endfor %}

                    {# Loop 2: Projects where the expert is a Provider, EXCLUDING projects where they are the leader #}
                    {% for project in expert.member_projects.all %}
                        {% if project.project_leader != expert %}
                        <div>
                            <h5>{{ project.start_date|date:"F Y" }} (Provider)</h5>
                            {# CORRECTED: Using pk=project.id for NoReverseMatch fix #}
                            <a href="{% url 'project_profile' pk=project.id %}" class="title">{{ project.title|default:"Project Title N/A" }}</a>
                            
                            <section class="project-tags">
                                <button class="campus">{{ project.primary_location|default:"Location N/A" }}</button>
                                <button class="agenda">{{ project.agenda.name|default:"Agenda N/A" }}</button>
                                <button class="status">{{ project.get_status_display|default:"Status N/A" }}</button>
                            </section>
                            
                            <section class="project-authors"> 
                                {# Project Leader #}
                                {% with leader=project.project_leader %}
                                    <content>
                                        <img src="{% if leader.profile_picture %}{{ leader.profile_picture.url }}{% else %}{% static 'users/default_profile.png' %}{% endif %}" alt="{{ leader.get_full_name }}">
                                        <a href="{% url 'expert_profile' user_id=leader.id %}">{{ leader.get_full_name|default:'Leader N/A' }}</a> 
                                    </content>
                                {% endwith %}

                                {# Other Providers (excluding the leader) #}
                                {% for provider in project.providers.all %}
                                    {% if provider != expert and provider != project.project_leader %}
                                        <content>
                                            <img src="{% if provider.profile_picture %}{{ provider.profile_picture.url }}{% else %}{% static 'users/default_profile.png' %}{% endif %}" alt="{{ provider.get_full_name }}">
                                            <a href="{% url 'expert_profile' user_id=provider.id %}">{{ provider.get_full_name|default:'Provider N/A' }}</a> 
                                        </content>
                                    {% endif %}
                                {% endfor %}
                            </section>

                            {# CORRECTED: Using pk=project.id for NoReverseMatch fix #}
                            <a href="{% url 'project_profile' pk=project.id %}" class="view">View Project Details</a> 
                        </div>
                        {% endif %}
                    {% endfor %}
                    
                    {# Display no projects message if both loops combined yielded no results #}
                    {% if not expert.led_projects.all and not expert.member_projects.all %}
                        <div>
                            <p style="padding: 1rem 0; text-align: center; color: #666;">This expert is not currently listed as a leader or provider on any projects.</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </section>
    </main>
    <footer>
        <p>test</p>
    </footer> 
    <script> 
        // Select all dropdown buttons
        document.querySelectorAll('.dropdown-btn').forEach(btn => {
            btn.addEventListener('click', e => {
                e.stopPropagation(); // stop document click
                const menu = btn.nextElementSibling;
                // Close other open menus
                document.querySelectorAll('.dropdown-menu').forEach(m => {
                    if (m !== menu) m.classList.add('hidden');
                });
                menu.classList.toggle('hidden');
            });
        });
        // Dropdown item click
        document.querySelectorAll('.dropdown-item').forEach(item => {
            item.addEventListener('click', e => {
                e.stopPropagation();
                const menu = item.parentElement;
                const btn = menu.previousElementSibling;
                btn.textContent = e.target.textContent;
                menu.classList.add('hidden');
            });
        });
        // Click outside closes all menus
        document.addEventListener('click', () => {
            document.querySelectorAll('.dropdown-menu').forEach(menu => {
                menu.classList.add('hidden');
            });
        });     
    </script>
{% endblock content %}