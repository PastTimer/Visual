{% extends "base_internal.html" %}
{% block content %}
{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Expert Profile</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer">
<link href="{% static 'internal/experts/prof.css' %}" rel="stylesheet">
</head> 
<body>
	<!-- Main Content -->
	<div class="main-container">
		<!-- Content Area -->
		<div class="content-area">
			<!-- Profile Header -->
			<div class="profile-header">
				<div class="profile-main">
					<div class="profile-left">
						<div class="profile-image">
							{% if expert.profile_picture %}
							<img src="{{ expert.profile_picture.url }}" alt="{{ expert.get_full_name }}">
							{% else %}
							<div style="width:100%; height:100%; display:flex; align-items:center; justify-content:center; background:#e9ecef; color:#6c757d; font-size:48px; font-weight:600;">
								{{ expert.given_name.0 }}{{ expert.last_name.0 }}
							</div>
							{% endif %}
						</div>
					</div>
					<div class="profile-middle">
						<h1 class="profile-name">{{ expert.get_full_name }}</h1>
						<div class="profile-location">
							<span class="location-icon"><i class="fa-solid fa-location-dot"></i></span>
							<span>{{ campus_display }}</span>
						</div>
						<div class="university-logo">
							{% if college_logo %}
							<img src="{{ college_logo }}" alt="{{ college_name }}">
							{% else %}
							<div style="width:100%; height:100%; display:flex; align-items:center; justify-content:center; background:#f8f9fa; color:#6c757d; font-size:24px; font-weight:600;">
								{{ college_name.0|default:"?" }}
							</div>
							{% endif %}
						</div>
					</div>
					<div class="profile-info">
						<div class="expertise-section">
							<div class="expertise-item">
								<span class="expertise-label">Field of Expertise:</span>
								<span class="expertise-value">{{ expert.expertise|default:"Not specified" }}</span>
							</div>
							<div class="expertise-item">
								<span class="expertise-label">{{ expert.degree|default:"Degree Not Listed" }}</span>
								<span class="expertise-value">{{ college_name }}</span>
							</div>
							<div class="expertise-item">
								<span class="expertise-label">Contact:</span>
								<span class="expertise-value">{{ expert.email }}</span>
							</div>
						</div>
					</div>
				</div>
			</div>

			<!-- Content Cards -->
			<div class="content-cards">
				<!-- Bio Card -->
				<div class="content-card">
					<div class="card-header">
						<h2 class="card-title">Bio</h2>
					</div>
					<div class="bio-content">
						<div style="margin-bottom: 20px;">
							{{ expert.bio|linebreaksbr|default:"This expert has not provided a bio." }}
						</div>
					</div>
				</div>

				<!-- Projects Card -->
				<div class="content-card">
					<div class="card-header">
						<h2 class="card-title">Projects ({{ projects.count }})</h2>
						<div class="sort-controls">
							<span class="sort-icon">â˜°</span>
							<div class="sort-dropdown">
								<select id="sortProjects" style="padding: 4px 8px; border: 1px solid #ddd; border-radius: 4px; cursor: pointer;">
									<option value="date-desc">Date (Newest First)</option>
									<option value="date-asc">Date (Oldest First)</option>
									<option value="title-asc">Title (A-Z)</option>
									<option value="title-desc">Title (Z-A)</option>
									<option value="status">Status</option>
								</select>
							</div>
						</div>
					</div>
					<div class="projects-list" id="projectsList">
						{% for project in projects %}
						<!-- Project Item -->
						<div class="project-item">
							<div class="project-date">{{ project.start_date|date:"F Y" }}</div>
							<h3 class="project-title">{{ project.title }}</h3>
							<div class="project-tags">
								<span class="project-tag tag-orange">{{ project.project_leader.get_campus_display|default:"N/A" }}</span>
								{% if project.agenda %}
								<span class="project-tag tag-green">{{ project.agenda.name }}</span>
								{% endif %}
								{% if project.status == 'COMPLETED' %}
								<span class="project-tag tag-completed">Completed</span>
								{% elif project.status == 'IN_PROGRESS' %}
								<span class="project-tag tag-ongoing">Ongoing</span>
								{% elif project.status == 'NOT_STARTED' %}
								<span class="project-tag" style="background-color: #6c757d; color: white;">Not Started</span>
								{% elif project.status == 'ON_HOLD' %}
								<span class="project-tag" style="background-color: #ffc107; color: white;">On Hold</span>
								{% elif project.status == 'CANCELLED' %}
								<span class="project-tag" style="background-color: #dc3545; color: white;">Cancelled</span>
								{% endif %}
							</div>
							<div class="project-contributors">
								{% if project.project_leader %}
								<div class="contributor-avatar">{{ project.project_leader.given_name.0 }}{{ project.project_leader.last_name.0 }}</div>
								<a href="{% url 'expert_profile' project.project_leader.id %}" class="contributor-name">{{ project.project_leader.get_full_name }}</a>
								{% endif %}
								{% for provider in project.providers.all|slice:":3" %}
								<div class="contributor-avatar">{{ provider.given_name.0 }}{{ provider.last_name.0 }}</div>
								<a href="{% url 'expert_profile' provider.id %}" class="contributor-name">{{ provider.get_full_name }}</a>
								{% endfor %}
								{% if project.providers.count > 3 %}
								<span class="contributor-name">+{{ project.providers.count|add:"-3" }} more</span>
								{% endif %}
							</div>
							<a href="{% url 'project_profile' project.id %}" class="project-action">View</a>
						</div>
						{% empty %}
						<div style="text-align: center; padding: 40px; color: #666;">
							No projects found for this expert.
						</div>
						{% endfor %}
					</div>
				</div>
			</div>
		</div>
	</div>

<script>
// Project sorting functionality
const projectsData = [
	{% for project in projects %}
	{
		id: {{ project.id }},
		title: "{{ project.title|escapejs }}",
		date: "{{ project.start_date|date:'Y-m-d' }}",
		dateDisplay: "{{ project.start_date|date:'F Y' }}",
		status: "{{ project.status }}",
		statusDisplay: "{% if project.status == 'COMPLETED' %}Completed{% elif project.status == 'IN_PROGRESS' %}Ongoing{% elif project.status == 'NOT_STARTED' %}Not Started{% elif project.status == 'ON_HOLD' %}On Hold{% elif project.status == 'CANCELLED' %}Cancelled{% endif %}",
		leaderCampus: "{{ project.project_leader.get_campus_display|default:'N/A'|escapejs }}",
		agenda: "{{ project.agenda.name|default:''|escapejs }}",
		leaderName: "{{ project.project_leader.get_full_name|escapejs }}",
		leaderInitials: "{{ project.project_leader.given_name.0 }}{{ project.project_leader.last_name.0 }}",
		providers: [
			{% for provider in project.providers.all %}
			{
				name: "{{ provider.get_full_name|escapejs }}",
				initials: "{{ provider.given_name.0 }}{{ provider.last_name.0 }}"
			}{% if not forloop.last %},{% endif %}
			{% endfor %}
		],
		providersCount: {{ project.providers.count }}
	}{% if not forloop.last %},{% endif %}
	{% endfor %}
];

function renderProjects(projects) {
	const container = document.getElementById('projectsList');
	if (projects.length === 0) {
		container.innerHTML = '<div style="text-align: center; padding: 40px; color: #666;">No projects found for this expert.</div>';
		return;
	}
	
	container.innerHTML = projects.map(project => {
		let statusTag = '';
		if (project.status === 'COMPLETED') {
			statusTag = '<span class="project-tag tag-completed">Completed</span>';
		} else if (project.status === 'IN_PROGRESS') {
			statusTag = '<span class="project-tag tag-ongoing">Ongoing</span>';
		} else if (project.status === 'NOT_STARTED') {
			statusTag = '<span class="project-tag" style="background-color: #6c757d; color: white;">Not Started</span>';
		} else if (project.status === 'ON_HOLD') {
			statusTag = '<span class="project-tag" style="background-color: #ffc107; color: white;">On Hold</span>';
		} else if (project.status === 'CANCELLED') {
			statusTag = '<span class="project-tag" style="background-color: #dc3545; color: white;">Cancelled</span>';
		}
		
		const providersList = project.providers.slice(0, 3).map(p => 
			`<div class="contributor-avatar">${p.initials}</div><span class="contributor-name">${p.name}</span>`
		).join('');
		
		const moreProviders = project.providersCount > 3 ? 
			`<span class="contributor-name">+${project.providersCount - 3} more</span>` : '';
		
		return `
			<div class="project-item">
				<div class="project-date">${project.dateDisplay}</div>
				<h3 class="project-title">${project.title}</h3>
				<div class="project-tags">
					<span class="project-tag tag-orange">${project.leaderCampus}</span>
					${project.agenda ? `<span class="project-tag tag-green">${project.agenda}</span>` : ''}
					${statusTag}
				</div>
				<div class="project-contributors">
					<div class="contributor-avatar">${project.leaderInitials}</div>
					<span class="contributor-name">${project.leaderName}</span>
					${providersList}
					${moreProviders}
				</div>
				<a href="/projects/${project.id}/" class="project-action">View</a>
			</div>
		`;
	}).join('');
}

document.getElementById('sortProjects').addEventListener('change', function(e) {
	const sortBy = e.target.value;
	let sorted = [...projectsData];
	
	switch(sortBy) {
		case 'date-desc':
			sorted.sort((a, b) => new Date(b.date) - new Date(a.date));
			break;
		case 'date-asc':
			sorted.sort((a, b) => new Date(a.date) - new Date(b.date));
			break;
		case 'title-asc':
			sorted.sort((a, b) => a.title.localeCompare(b.title));
			break;
		case 'title-desc':
			sorted.sort((a, b) => b.title.localeCompare(a.title));
			break;
		case 'status':
			const statusOrder = {'COMPLETED': 1, 'IN_PROGRESS': 2, 'NOT_STARTED': 3, 'ON_HOLD': 4, 'CANCELLED': 5};
			sorted.sort((a, b) => (statusOrder[a.status] || 99) - (statusOrder[b.status] || 99));
			break;
	}
	
	renderProjects(sorted);
});

// Initial render
renderProjects(projectsData);
</script>

</body>
</html>

{% endblock %}