{% extends "base_internal.html" %}
{% block content %}
{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Expert Profile</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer">
<link href="{% static 'internal/experts/prof.css' %}" rel="stylesheet">
</head> 
<body>
    <main> 
        <section>
            <div class="propic">
                {% if expert.profile_picture %}
                <img src="{{ expert.profile_picture.url }}" alt="{{ expert.get_full_name }}">
                {% else %}
                <div class="propic-placeholder">
                    {{ expert.given_name.0 }}
                </div>
                {% endif %}
            </div>
            
            <div class="profile-info-grid">
                <div class="personal-info">
                    <h2>{{ expert.get_full_name }}</h2>
                    <h4><i class="fas fa-map-marker-alt" style="color:red; margin-right:0.5rem;"></i> {{ campus_display }}</h4>
                    {% if college_logo %}
                    <img src="{{ college_logo }}" alt="{{ college_name }}">
                    {% else %}
                    <div class="college-logo-placeholder">
                        {{ college_name.0|default:"?" }}
                    </div>
                    {% endif %}
                </div>
            
                <div class="expertise">
                    <h5>Field of Expertise:</h5>
                    <p>{{ expert.expertise|default:"Not specified" }}</p>
                    <h5>{{ expert.degree|default:"Degree Not Listed" }}</h5>
                    <p>{{ college_name }}</p>
                </div>
                <div class="contact">
                    <h5>Contact:</h5>
                    <p>{{ expert.email }}</p>
                </div>

            </div>
        </section>
        <section class="lower">
            <div class="bio">
                <div class="lower-header">
                    <h1>Bio</h1>
                </div>
                <p style="margin-top: 1rem;">
                    {{ expert.bio|linebreaksbr|default:"This expert has not provided a bio." }}
                </p>
            </div>
            <div class="project">
                <div class="lower-header"> 
                    <div>
                        <h1>Projects</h1>   
                    </div>
                    <div style="display: flex; flex-shrink: 3; align-items: center; gap: 0.5rem;">
                        <span style="font-size: 1.1rem; font-weight: 500; color: #444; width: 6rem;">Sort by:</span>
                        <select id="sortProjects" class="dropdown-btn" style="margin: 0.75rem 0;">
                            <option value="date-desc">Newest First</option>
                            <option value="date-asc">Oldest First</option>
                            <option value="title-asc">Title (A-Z)</option>
                            <option value="title-desc">Title (Z-A)</option>
                            <option value="status">Status</option>
                        </select>
                    </div>
                </div>
                <div class="project-card" id="projectsList"> 
                    </div>
            </div>
        </section>
    </main>

<script>
const projectsData = [
    {% for project in projects %}
    {
        id: {{ project.id }},
        title: "{{ project.title|escapejs }}",
        date: "{{ project.start_date|date:'Y-m-d' }}",
        // CHANGE 2: Changed date format from 'F Y' to 'F j, Y' (e.g., "October 28, 2025")
        dateDisplay: "{{ project.start_date|date:'F j, Y' }}",
        status: "{{ project.status }}",
        statusDisplay: "{% if project.status == 'COMPLETED' %}Completed{% elif project.status == 'IN_PROGRESS' %}Ongoing{% elif project.status == 'NOT_STARTED' %}Not Started{% elif project.status == 'ON_HOLD' %}On Hold{% elif project.status == 'CANCELLED' %}Cancelled{% endif %}",
        leaderCampus: "{{ project.project_leader.get_campus_display|default:'N/A'|escapejs }}",
        agenda: "{{ project.agenda.name|default:''|escapejs }}",
        leader: {
            id: {{ project.project_leader.id|default:0 }},
            name: "{{ project.project_leader.get_full_name|escapejs }}",
            // FIX 3: Corrected initials
            initials: "{{ project.project_leader.given_name.0 }}"
        },
        providers: [
            {% for provider in project.providers.all %}
            {
                id: {{ provider.id }},
                name: "{{ provider.get_full_name|escapejs }}",
                // FIX 3: Corrected initials
                initials: "{{ provider.given_name.0 }}"
            }{% if not forloop.last %},{% endif %}
            {% endfor %}
        ],
        providersCount: {{ project.providers.count }}
    }{% if not forloop.last %},{% endif %}
    {% endfor %}
];


function renderProjects(projects) {
    const container = document.getElementById('projectsList');
    if (projects.length === 0) {
        container.innerHTML = '<div style="padding: 1rem 3rem; color: #666; margin-top: 1rem;">No projects found for this expert.</div>';
        return;
    }
    
    container.innerHTML = projects.map(project => {
        // --- Status Tag Logic ---
        let statusTag = '';
        if (project.status === 'COMPLETED') {
            statusTag = '<button class="status" style="color: #1CB889; border-color: #1CB889;">Completed</button>';
        } else if (project.status === 'IN_PROGRESS') {
            statusTag = '<button class="status" style="color: #007bff; border-color: #007bff;">Ongoing</button>';
        } else if (project.status === 'NOT_STARTED') {
            statusTag = '<button class="status" style="color: #6c757d; border-color: #6c757d;">Not Started</button>';
        } else if (project.status === 'ON_HOLD') {
            statusTag = '<button class="status" style="color: #ffc107; border-color: #ffc107;">On Hold</button>';
        } else if (project.status === 'CANCELLED') {
            statusTag = '<button class="status" style="color: #dc3545; border-color: #dc3545;">Cancelled</button>';
        } else {
            statusTag = `<button class="status" style="color: #6c757d; border-color: #6c757d;">${project.status}</button>`;
        }

        // --- Authors/Providers Logic (Show leader + 2 providers) ---
        let authorsHTML = '';
        if (project.leader) {
            authorsHTML += `
            <content>
                <div class="avatar-placeholder">${project.leader.initials}</div>
                <a href="/experts/profile/${project.leader.id}/">${project.leader.name}</a> 
            </content>
            `;
        }
        
        const providersList = project.providers.slice(0, 2).map(p => 
            `<content>
                <div class="avatar-placeholder">${p.initials}</div>
                <a href="/experts/profile/${p.id}/">${p.name}</a> 
            </content>`
        ).join('');
        authorsHTML += providersList;
        
        const moreProviders = project.providersCount > 2 ? 
            `<content style="align-items: center;"><a href="/projects/${project.id}/">+${project.providersCount - 2} more</a></content>` : '';
        authorsHTML += moreProviders;

        // --- Final HTML for the card ---
        return `
            <div>
                <h5>${project.dateDisplay}</h5>
                <a href="/projects/${project.id}/" class="title">${project.title}</a>
                <section class="project-tags">
                    <button class="campus">${project.leaderCampus}</button>
                    ${project.agenda ? `<button class="agenda">${project.agenda}</button>` : ''}
                    ${statusTag}
                </section>
                <section class="project-authors"> 
                    ${authorsHTML}
                </section>
                <a href="/projects/${project.id}/" class="view">View</a> 
            </div>
        `;
    }).join('');
}

// Original sort event listener
document.getElementById('sortProjects').addEventListener('change', function(e) {
    const sortBy = e.target.value;
    let sorted = [...projectsData];
    
    switch(sortBy) {
        case 'date-desc':
            sorted.sort((a, b) => new Date(b.date) - new Date(a.date));
            break;
        case 'date-asc':
            sorted.sort((a, b) => new Date(a.date) - new Date(b.date));
            break;
        case 'title-asc':
            sorted.sort((a, b) => a.title.localeCompare(b.title));
            break;
        case 'title-desc':
            sorted.sort((a, b) => b.title.localeCompare(a.title));
            break;
        case 'status':
            const statusOrder = {'COMPLETED': 1, 'IN_PROGRESS': 2, 'NOT_STARTED': 3, 'ON_HOLD': 4, 'CANCELLED': 5};
            sorted.sort((a, b) => (statusOrder[a.status] || 99) - (statusOrder[b.status] || 99));
            break;
    }
    
    renderProjects(sorted);
});

// Initial render
renderProjects(projectsData);
</script>

</body>
</html>

{% endblock %}