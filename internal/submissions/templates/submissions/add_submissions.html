{% extends "base_internal.html" %}
{% block content %}
{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Add Agenda</title>

<link href="https://fonts.googleapis.com/css2?family=Instrument+Sans:700&family=Inter:wght@400;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer">
<link href="{% static 'shared/projects/styles.css' %}" rel="stylesheet">
</head>
<body>
    <div class="main-container">
        <div class="user-details-title">
            <h2>Add Submission</h2> 
            <p>Input all fields correctly and assign new submission.</p>
        </div>
        {% if success %}
            <div class="success-message">Submission added successfully!</div>
        {% endif %}
        <form class="submission-form" method="post" enctype="multipart/form-data">
            {% csrf_token %}

            <div class="user-details-section"> 
                <div class="user-details-category">  
                    <i class="fa-regular fa-address-card subtitle-icon"></i>
                    Details
                </div>
                <div class="form-group">
                    <label class="user-details-label" for="id_project">Project: <span class="required">*</span></label>
                    <select class="user-details-value" name="project" id="id_project" required>
                        <option value="">Select Project</option>
                        {% for project in projects %}
                            <option value="{{ project.id }}">{{ project.title }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="form-group">
                    <label class="user-details-label">Choose Form/s: <span class="required">*</span></label>
                    <div id="downloadable-tag-row" class="item-row"></div>
                    <select id="downloadable-options-template" class="user-details-value" style="display:none;">
                        <option value="">Select Downloadable</option>
                        {% for downloadable in downloadables %}
                            <option value="{{ downloadable.id }}">{{ downloadable.name }}</option>
                        {% endfor %}
                    </select>
                </div>  
                
                <div class="form-group">
                    <label class="user-details-label" for="id_deadline">Deadline: <span class="required">*</span></label>
                    <input class="user-details-value" type="datetime-local" name="deadline" id="id_deadline">
                </div>

                <div class="form-group">
                    <label class="user-details-label" for="id_notes">Notes:</label>
                    <textarea class="form-input user-details-value" name="notes" id="id_notes"></textarea>
                </div> 
            </div>

            <div class="form-actions">
                <a href="{% url 'submissions_admin' %}" class="back btn">Cancel</a>
                <button type="submit" class="save btn">Add Requirement</button>
            </div>
        </form>
    </div>

<!-- SVG Sprite Section -->
<svg style="display:none;" xmlns="http://www.w3.org/2000/svg">
    <symbol id="icon-add" viewBox="0 0 16 16">
        <path d="M6.80039 14.4004C6.80039 14.7187 6.92682 15.0239 7.15186 15.2489C7.37691 15.474 7.68213 15.6004 8.00039 15.6004C8.31865 15.6004 8.62388 15.474 8.84892 15.2489C9.07396 15.0239 9.20039 14.7187 9.20039 14.4004V9.20039H14.4004C14.7187 9.20039 15.0239 9.07396 15.2489 8.84892C15.474 8.62388 15.6004 8.31865 15.6004 8.00039C15.6004 7.68213 15.474 7.37691 15.2489 7.15186C15.0239 6.92682 14.7187 6.80039 14.4004 6.80039H9.20039V1.60039C9.20039 1.28213 9.07396 0.976906 8.84892 0.751863C8.62388 0.526819 8.31865 0.400391 8.00039 0.400391C7.68213 0.400391 7.37691 0.526819 7.15186 0.751863C6.92682 0.976906 6.80039 1.28213 6.80039 1.60039V6.80039H1.60039C1.28213 6.80039 0.976906 6.92682 0.751863 7.15186C0.526819 7.37691 0.400391 7.68213 0.400391 8.00039C0.400391 8.31865 0.526819 8.62388 0.751863 8.84892C0.976906 9.07396 1.28213 9.20039 1.60039 9.20039H6.80039V14.4004Z" fill="black"/>
    </symbol>
</svg>

<script>
    // Form Validation for Required Fields (Submission Requirement)
    document.querySelector('.submission-form').addEventListener('submit', function(e) {
        let valid = true;
        // Remove Previous Error States
        let projectError = document.getElementById('project-error');
        let downloadableError = document.getElementById('downloadable-error');
        let deadlineError = document.getElementById('deadline-error');
        if (projectError) projectError.remove();
        if (downloadableError) downloadableError.remove();
        if (deadlineError) deadlineError.remove();

        // Validate Projects
        const selectedProjects = Array.from(document.querySelectorAll('input[name="projects"]')).map(i => i.value);
        if (selectedProjects.length === 0) {
            valid = false;
            const tagRow = document.getElementById('project-tag-row');
            const err = document.createElement('div');
            err.id = 'project-error';
            err.textContent = 'At least one project must be selected.';
            err.style.color = '#E53E3E';
            err.style.fontSize = '0.95rem';
            tagRow.appendChild(err);
        }
        // Validate Downloadables
        const selectedDownloadables = Array.from(document.querySelectorAll('input[name="downloadables"]')).map(i => i.value);
        if (selectedDownloadables.length === 0) {
            valid = false;
            const tagRow = document.getElementById('downloadable-tag-row');
            const err = document.createElement('div');
            err.id = 'downloadable-error';
            err.textContent = 'At least one form must be selected.';
            err.style.color = '#E53E3E';
            err.style.fontSize = '0.95rem';
            tagRow.appendChild(err);
        }
        // Validate Deadline
        const deadlineInput = document.getElementById('id_deadline');
        deadlineInput.classList.remove('error-input');
        if (!deadlineInput.value) {
            valid = false;
            deadlineInput.classList.add('error-input');
            const err = document.createElement('div');
            err.id = 'deadline-error';
            err.textContent = 'Deadline is required.';
            err.style.color = '#E53E3E';
            err.style.fontSize = '0.95rem';
            err.style.marginTop = '0.85rem';
            deadlineInput.parentNode.appendChild(err);
        }
        if (!valid) {
            e.preventDefault();
        }
    });

    // Tag UI for Downloadables only
    function setupTagUI(rowId, templateId, inputName) {
        var tagRow = document.getElementById(rowId);
        var templateOptions = Array.from(document.getElementById(templateId).options);
        var selected = [];
        var selectDropdown = document.createElement('select');
        selectDropdown.id = 'item-select-dropdown';
        selectDropdown.className = 'item-select-modal';
        selectDropdown.style.display = 'none';
        selectDropdown.style.position = 'absolute';
        selectDropdown.style.zIndex = 9999;
        function renderTags() {
            tagRow.innerHTML = '';
            selected.forEach(cid => {
                var opt = templateOptions.find(o => o.value == cid);
                if (opt) {
                    var tag = document.createElement('span');
                    tag.className = 'item-tag';
                    var removeBtn = document.createElement('button');
                    removeBtn.type = 'button';
                    removeBtn.className = 'remove-x';
                    removeBtn.innerHTML = '&times;';
                    removeBtn.onclick = function() {
                        selected = selected.filter(id => id != cid);
                        renderTags();
                    };
                    tag.appendChild(removeBtn);
                    tag.appendChild(document.createTextNode(opt.textContent));
                    tagRow.appendChild(tag);
                }
            });
            var addBtn = document.createElement('button');
            addBtn.type = 'button';
            addBtn.className = 'add-item-btn';
            addBtn.innerHTML = `<svg width="16" height="16"><use href="#icon-add" /></svg>`;
            addBtn.onclick = function(e) {
                e.preventDefault();
                const btnRect = addBtn.getBoundingClientRect();
                selectDropdown.style.display = 'block';
                selectDropdown.style.position = 'fixed';
                selectDropdown.style.left = (btnRect.left) + 'px';
                selectDropdown.style.top = (btnRect.bottom + 4) + 'px';
                selectDropdown.innerHTML = '';
                templateOptions.forEach(opt => {
                    if (!opt.value || !selected.includes(opt.value)) {
                        selectDropdown.appendChild(opt.cloneNode(true));
                    }
                });
                selectDropdown.focus();
            };
            tagRow.appendChild(addBtn);
            if (!document.body.contains(selectDropdown)) {
                document.body.appendChild(selectDropdown);
            }
            selected.forEach(cid => {
                var hidden = document.createElement('input');
                hidden.type = 'hidden';
                hidden.name = inputName;
                hidden.value = cid;
                tagRow.appendChild(hidden);
            });
        }
        selectDropdown.onchange = function() {
            var selectedId = selectDropdown.value;
            if (selectedId && !selected.includes(selectedId)) {
                selected.push(selectedId);
                renderTags();
            }
            selectDropdown.value = '';
            selectDropdown.style.display = 'none';
        };
        document.addEventListener('mousedown', function(e) {
            if (selectDropdown && !selectDropdown.contains(e.target) && e.target.className !== 'add-item-btn') {
                selectDropdown.style.display = 'none';
            }
        });
        renderTags();
    }
    document.addEventListener('DOMContentLoaded', function() {
        setupTagUI('downloadable-tag-row', 'downloadable-options-template', 'downloadables');
    });
</script>

</body>
</html>

{% endblock %}