{% extends "base_internal.html" %}
{% block content %}

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Add Agenda</title>

<link href="https://fonts.googleapis.com/css2?family=Instrument+Sans:700&family=Inter:wght@400;700&display=swap" rel="stylesheet">

<style>
    .required {
        color: #E53E3E;
    }

    .success-message {
		color: green; 
		margin-bottom: 1rem;
	}
    
    .error-input {
        border-color: #E53E3E !important;
        background: #FFF5F5 !important;
    }

    body {
        background: #F9F9F9;
        margin: 0;
        font-family: 'Inter', Arial, sans-serif;
    }

    .main-container {
        margin: 60px;
        display: flex;
        flex-direction: column;
        gap: 30px;
    }

	.form-title {
		font-family: 'Inter', Arial, sans-serif;
        font-weight: 400;
        font-size: 32px;
		margin: 0;
		color: #000000;
	}

	.form-group {
		margin-bottom: 1.5rem;
		display: flex;
		align-items: flex-start;
		gap: 1rem;
	}

	.form-label {
		font-weight: 600;
		color: #374151;
		padding-top: 0.75rem;
		font-size: 0.95rem;
	}

	.form-input {
		flex: 1;
		padding: 0.75rem 1rem;
		border: 1px solid #E5E7EB;
		border-radius: 8px;
		font-size: 1rem;
		font-family: 'Inter', sans-serif;
		background: #F9F9F9;
		transition: all 0.2s ease;
	}

	.form-input:focus {
		outline: none;
		border-color: #0A6C44;
		background: white;
		box-shadow: 0 0 0 3px rgba(10, 108, 68, 0.1);
	}

	.form-textarea {
		min-height: 120px;
		resize: vertical;
	}

	.form-actions {
		display: flex;
		gap: 1rem;
		justify-content: flex-end;
		margin-top: 2rem;
		padding-top: 1.5rem;
		border-top: 1px solid #E5E7EB;
	}

	.btn {
		padding: 0.75rem 1.5rem;
		border: none;
		border-radius: 8px;
		font-size: 1rem;
		font-weight: 600;
		cursor: pointer;
		transition: all 0.2s ease;
		font-family: 'Inter', sans-serif;
	}

	.btn-preview {
		background: #6B7280;
		color: white;
	}

	.btn-preview:hover {
		background: #4B5563;
		transform: translateY(-1px);
	}

	.btn-submit {
		background: #0A6C44;
		color: white;
	}

	.btn-submit:hover {
		background: #1f7c57;
		transform: translateY(-1px);
	}

	.btn-submit:disabled {
		background: #E5E7EB;
		color: #4B5563;
		cursor: not-allowed;
		transform: none;
	}

    select {
		appearance: none;
		-webkit-appearance: none;
		-moz-appearance: none;
		padding-right: 2rem;
		background: url("data:image/svg+xml;utf8,<svg width='16' height='11' viewBox='0 0 16 11' fill='none' xmlns='http://www.w3.org/2000/svg'><path d='M7.99976 7.19417L13.9025 1.29147C14.0125 1.17758 14.144 1.08674 14.2895 1.02424C14.435 0.961746 14.5915 0.92885 14.7498 0.927474C14.9082 0.926098 15.0652 0.95627 15.2117 1.01623C15.3583 1.07619 15.4914 1.16473 15.6034 1.27669C15.7153 1.38866 15.8039 1.5218 15.8638 1.66835C15.9238 1.8149 15.954 1.97192 15.9526 2.13026C15.9512 2.28859 15.9183 2.44506 15.8558 2.59055C15.7933 2.73604 15.7025 2.86762 15.5886 2.97762L8.84283 9.72339C8.61921 9.94694 8.31596 10.0725 7.99976 10.0725C7.68356 10.0725 7.38031 9.94694 7.15669 9.72339L0.41092 2.97762C0.297028 2.86762 0.206183 2.73604 0.143687 2.59055C0.0811915 2.44506 0.0482959 2.28859 0.04692 2.13026C0.0455441 1.97192 0.0757155 1.8149 0.135674 1.66835C0.195632 1.5218 0.284176 1.38866 0.39614 1.27669C0.508103 1.16473 0.641244 1.07619 0.787794 1.01623C0.934343 0.95627 1.09137 0.926098 1.2497 0.927474C1.40804 0.92885 1.56451 0.961746 1.71 1.02424C1.85548 1.08674 1.98706 1.17758 2.09706 1.29147L7.99976 7.19417Z' fill='%23374151'/></svg>")
        		no-repeat right 0.75rem center !important;
  		background-size: 13px 8px;
        font-family: 'Inter', Arial, sans-serif;
        font-weight: 400;
    }
</style>

<style>
    .item-tag {
        background: #F8F8F8;
        border: 1px solid #000;
        border-radius: 5px;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.35rem 0.85rem 0.35rem 0.5rem;
        font-size: 0.95rem;
        font-family: 'Inter', Arial, sans-serif;
        vertical-align: middle;
    }
    
    .item-tag .remove-x {
        color: #E53E3E;
        font-weight: bold;
        font-size: 1.1rem;
        margin-left: 3px;
        margin-right: 1px;
        cursor: pointer;
        border: none;
        background: none;
        padding: 0;
    }

    .add-item-btn {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        background: #F0F0F0;
        border: 1px solid rgba(0,0,0,0.16);
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: box-shadow 0.2s;
        font-family: 'Inter', Arial, sans-serif;
    }

    .add-item-btn:hover {
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }

    .item-select-modal {
        display: none;
        position: absolute;
        z-index: 1000;
        background: white;
        border: 1px solid #E5E7EB;
        border-radius: 8px;
        box-shadow: 0 4px 16px rgba(0,0,0,0.08);
        padding: 1rem;
    }

    .item-row {
        display: flex;
        align-items: center;
        flex-wrap: wrap;
        position: relative;
        gap: 10px;
        margin-bottom: 5px;
        margin-top: 5px;
    }

    #item-select-dropdown {
        font-family: 'Inter', Arial, sans-serif;
        font-size: 13px;
        padding: 8px 30px 8px 15px;
        border-radius: 6px;
        appearance: none;
        -webkit-appearance: none;
        -moz-appearance: none;
        background: white url('data:image/svg+xml;utf8,<svg fill="none" height="16" viewBox="0 0 16 16" width="16" xmlns="http://www.w3.org/2000/svg"><path d="M4 6L8 10L12 6" stroke="%23374151" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>') no-repeat right 10px center/16px 16px;
    }
</style>

</head>
<body>
    <div class="main-container">
        <div class="form-header">
            <h1 class="form-title">Add Submission</h1>
        </div>
        {% if success %}
            <div class="success-message">Submission added successfully!</div>
        {% endif %}
        <form class="submission-form" method="post" enctype="multipart/form-data">
            {% csrf_token %}


            <div class="form-group">
                <label class="form-label" for="id_project">Project: <span class="required">*</span></label>
                <select class="form-input" name="project" id="id_project" required>
                    <option value="">Select Project</option>
                    {% for project in projects %}
                        <option value="{{ project.id }}">{{ project.title }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="form-group">
                <label class="form-label">Choose Form/s: <span class="required">*</span></label>
                <div id="downloadable-tag-row" class="item-row"></div>
                <select id="downloadable-options-template" style="display:none;">
                    <option value="">Select Downloadable</option>
                    {% for downloadable in downloadables %}
                        <option value="{{ downloadable.id }}">{{ downloadable.name }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="form-group">
                <label class="form-label" for="id_deadline">Deadline: <span class="required">*</span></label>
                <input class="form-input" type="datetime-local" name="deadline" id="id_deadline">
            </div>

            <div class="form-group">
                <label class="form-label" for="id_notes">Notes:</label>
                <textarea class="form-input form-textarea" name="notes" id="id_notes"></textarea>
            </div>

            <div class="form-actions">
                <a href="{% url 'submissions_admin' %}" class="btn btn-preview" style="text-decoration: none;">Back</a>
                <button type="submit" class="btn btn-submit">Add Requirement</button>
            </div>
        </form>
    </div>

<!-- SVG Sprite Section -->
<svg style="display:none;" xmlns="http://www.w3.org/2000/svg">
    <symbol id="icon-add" viewBox="0 0 16 16">
        <path d="M6.80039 14.4004C6.80039 14.7187 6.92682 15.0239 7.15186 15.2489C7.37691 15.474 7.68213 15.6004 8.00039 15.6004C8.31865 15.6004 8.62388 15.474 8.84892 15.2489C9.07396 15.0239 9.20039 14.7187 9.20039 14.4004V9.20039H14.4004C14.7187 9.20039 15.0239 9.07396 15.2489 8.84892C15.474 8.62388 15.6004 8.31865 15.6004 8.00039C15.6004 7.68213 15.474 7.37691 15.2489 7.15186C15.0239 6.92682 14.7187 6.80039 14.4004 6.80039H9.20039V1.60039C9.20039 1.28213 9.07396 0.976906 8.84892 0.751863C8.62388 0.526819 8.31865 0.400391 8.00039 0.400391C7.68213 0.400391 7.37691 0.526819 7.15186 0.751863C6.92682 0.976906 6.80039 1.28213 6.80039 1.60039V6.80039H1.60039C1.28213 6.80039 0.976906 6.92682 0.751863 7.15186C0.526819 7.37691 0.400391 7.68213 0.400391 8.00039C0.400391 8.31865 0.526819 8.62388 0.751863 8.84892C0.976906 9.07396 1.28213 9.20039 1.60039 9.20039H6.80039V14.4004Z" fill="black"/>
    </symbol>
</svg>

<script>
    // Form Validation for Required Fields (Submission Requirement)
    document.querySelector('.submission-form').addEventListener('submit', function(e) {
        let valid = true;
        // Remove Previous Error States
        let projectError = document.getElementById('project-error');
        let downloadableError = document.getElementById('downloadable-error');
        let deadlineError = document.getElementById('deadline-error');
        if (projectError) projectError.remove();
        if (downloadableError) downloadableError.remove();
        if (deadlineError) deadlineError.remove();

        // Validate Projects
        const selectedProjects = Array.from(document.querySelectorAll('input[name="projects"]')).map(i => i.value);
        if (selectedProjects.length === 0) {
            valid = false;
            const tagRow = document.getElementById('project-tag-row');
            const err = document.createElement('div');
            err.id = 'project-error';
            err.textContent = 'At least one project must be selected.';
            err.style.color = '#E53E3E';
            err.style.fontSize = '0.95rem';
            tagRow.appendChild(err);
        }
        // Validate Downloadables
        const selectedDownloadables = Array.from(document.querySelectorAll('input[name="downloadables"]')).map(i => i.value);
        if (selectedDownloadables.length === 0) {
            valid = false;
            const tagRow = document.getElementById('downloadable-tag-row');
            const err = document.createElement('div');
            err.id = 'downloadable-error';
            err.textContent = 'At least one form must be selected.';
            err.style.color = '#E53E3E';
            err.style.fontSize = '0.95rem';
            tagRow.appendChild(err);
        }
        // Validate Deadline
        const deadlineInput = document.getElementById('id_deadline');
        deadlineInput.classList.remove('error-input');
        if (!deadlineInput.value) {
            valid = false;
            deadlineInput.classList.add('error-input');
            const err = document.createElement('div');
            err.id = 'deadline-error';
            err.textContent = 'Deadline is required.';
            err.style.color = '#E53E3E';
            err.style.fontSize = '0.95rem';
            err.style.marginTop = '0.85rem';
            deadlineInput.parentNode.appendChild(err);
        }
        if (!valid) {
            e.preventDefault();
        }
    });

    // Tag UI for Downloadables only
    function setupTagUI(rowId, templateId, inputName) {
        var tagRow = document.getElementById(rowId);
        var templateOptions = Array.from(document.getElementById(templateId).options);
        var selected = [];
        var selectDropdown = document.createElement('select');
        selectDropdown.id = 'item-select-dropdown';
        selectDropdown.className = 'item-select-modal';
        selectDropdown.style.display = 'none';
        selectDropdown.style.position = 'absolute';
        selectDropdown.style.zIndex = 9999;
        function renderTags() {
            tagRow.innerHTML = '';
            selected.forEach(cid => {
                var opt = templateOptions.find(o => o.value == cid);
                if (opt) {
                    var tag = document.createElement('span');
                    tag.className = 'item-tag';
                    var removeBtn = document.createElement('button');
                    removeBtn.type = 'button';
                    removeBtn.className = 'remove-x';
                    removeBtn.innerHTML = '&times;';
                    removeBtn.onclick = function() {
                        selected = selected.filter(id => id != cid);
                        renderTags();
                    };
                    tag.appendChild(removeBtn);
                    tag.appendChild(document.createTextNode(opt.textContent));
                    tagRow.appendChild(tag);
                }
            });
            var addBtn = document.createElement('button');
            addBtn.type = 'button';
            addBtn.className = 'add-item-btn';
            addBtn.innerHTML = `<svg width="16" height="16"><use href="#icon-add" /></svg>`;
            addBtn.onclick = function(e) {
                e.preventDefault();
                const btnRect = addBtn.getBoundingClientRect();
                selectDropdown.style.display = 'block';
                selectDropdown.style.position = 'fixed';
                selectDropdown.style.left = (btnRect.left) + 'px';
                selectDropdown.style.top = (btnRect.bottom + 4) + 'px';
                selectDropdown.innerHTML = '';
                templateOptions.forEach(opt => {
                    if (!opt.value || !selected.includes(opt.value)) {
                        selectDropdown.appendChild(opt.cloneNode(true));
                    }
                });
                selectDropdown.focus();
            };
            tagRow.appendChild(addBtn);
            if (!document.body.contains(selectDropdown)) {
                document.body.appendChild(selectDropdown);
            }
            selected.forEach(cid => {
                var hidden = document.createElement('input');
                hidden.type = 'hidden';
                hidden.name = inputName;
                hidden.value = cid;
                tagRow.appendChild(hidden);
            });
        }
        selectDropdown.onchange = function() {
            var selectedId = selectDropdown.value;
            if (selectedId && !selected.includes(selectedId)) {
                selected.push(selectedId);
                renderTags();
            }
            selectDropdown.value = '';
            selectDropdown.style.display = 'none';
        };
        document.addEventListener('mousedown', function(e) {
            if (selectDropdown && !selectDropdown.contains(e.target) && e.target.className !== 'add-item-btn') {
                selectDropdown.style.display = 'none';
            }
        });
        renderTags();
    }
    document.addEventListener('DOMContentLoaded', function() {
        setupTagUI('downloadable-tag-row', 'downloadable-options-template', 'downloadables');
    });
</script>

</body>
</html>

{% endblock %}