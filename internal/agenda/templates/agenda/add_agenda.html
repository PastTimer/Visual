{% extends "base_internal.html" %}
{% block content %}

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Add Agenda</title>

<link href="https://fonts.googleapis.com/css2?family=Instrument+Sans:700&family=Inter:wght@400;700&display=swap" rel="stylesheet">

<style>
    .required {
        color: #E53E3E;
    }

    .success-message {
		color: green; 
		margin-bottom: 1rem;
	}
    
    .error-input {
        border-color: #E53E3E !important;
        background: #FFF5F5 !important;
    }

    body {
        background: #F9F9F9;
        margin: 0;
        font-family: 'Inter', Arial, sans-serif;
    }

    .main-container {
        margin: 60px;
        display: flex;
        flex-direction: column;
        gap: 30px;
    }

	.form-title {
		font-family: 'Inter', Arial, sans-serif;
        font-weight: 400;
        font-size: 32px;
		margin: 0;
		color: #000000;
	}

	.form-group {
		margin-bottom: 1.5rem;
		display: flex;
		align-items: flex-start;
		gap: 1rem;
	}

	.form-label {
		font-weight: 600;
		color: #374151;
		padding-top: 0.75rem;
		font-size: 0.95rem;
	}

	.form-input {
		flex: 1;
		padding: 0.75rem 1rem;
		border: 1px solid #E5E7EB;
		border-radius: 8px;
		font-size: 1rem;
		font-family: 'Inter', sans-serif;
		background: #F9F9F9;
		transition: all 0.2s ease;
	}

	.form-input:focus {
		outline: none;
		border-color: #0A6C44;
		background: white;
		box-shadow: 0 0 0 3px rgba(10, 108, 68, 0.1);
	}

	.form-textarea {
		min-height: 120px;
		resize: vertical;
	}

	.form-actions {
		display: flex;
		gap: 1rem;
		justify-content: flex-end;
		margin-top: 2rem;
		padding-top: 1.5rem;
		border-top: 1px solid #E5E7EB;
	}

	.btn {
		padding: 0.75rem 1.5rem;
		border: none;
		border-radius: 8px;
		font-size: 1rem;
		font-weight: 600;
		cursor: pointer;
		transition: all 0.2s ease;
		font-family: 'Inter', sans-serif;
	}

	.btn-preview {
		background: #6B7280;
		color: white;
	}

	.btn-preview:hover {
		background: #4B5563;
		transform: translateY(-1px);
	}

	.btn-submit {
		background: #0A6C44;
		color: white;
	}

	.btn-submit:hover {
		background: #1f7c57;
		transform: translateY(-1px);
	}

	.btn-submit:disabled {
		background: #E5E7EB;
		color: #4B5563;
		cursor: not-allowed;
		transform: none;
	}

    .college-tag {
        background: #F8F8F8;
        border: 1px solid #000;
        border-radius: 5px;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.35rem 0.85rem 0.35rem 0.5rem;
        font-size: 0.95rem;
        font-family: 'Inter', Arial, sans-serif;
        vertical-align: middle;
    }
    
    .college-tag .remove-x {
        color: #E53E3E;
        font-weight: bold;
        font-size: 1.1rem;
        margin-left: 3px;
        margin-right: 1px;
        cursor: pointer;
        border: none;
        background: none;
        padding: 0;
    }

    .add-college-btn {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        background: #F0F0F0;
        border: 1px solid rgba(0,0,0,0.16);
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: box-shadow 0.2s;
        font-family: 'Inter', Arial, sans-serif;
    }

    .add-college-btn:hover {
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }

    .college-select-modal {
        display: none;
        position: absolute;
        z-index: 1000;
        background: white;
        border: 1px solid #E5E7EB;
        border-radius: 8px;
        box-shadow: 0 4px 16px rgba(0,0,0,0.08);
        padding: 1rem;
    }

    .college-row {
        display: flex;
        align-items: center;
        flex-wrap: wrap;
        position: relative;
        gap: 10px;
        margin-bottom: 5px;
        margin-top: 5px;
    }

    #college-select-dropdown {
        font-family: 'Inter', Arial, sans-serif;
        font-size: 13px;
        padding: 8px 16px;
        border-radius: 6px;
        appearance: none;
        -webkit-appearance: none;
        -moz-appearance: none;
        background: white url('data:image/svg+xml;utf8,<svg fill="none" height="16" viewBox="0 0 16 16" width="16" xmlns="http://www.w3.org/2000/svg"><path d="M4 6L8 10L12 6" stroke="%23374151" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>') no-repeat right 18px center/16px 16px;
        padding-right: 5px !important;
    }
</style>

</head>
<body>
    <div class="main-container">
        <div class="form-header">
            <h1 class="form-title">Add Agenda</h1>
        </div>
        
        {% if success %}
            <div class="success-message">Agenda added successfully!</div>
        {% endif %}

        <form class="agenda-form" method="post" enctype="multipart/form-data">
            {% csrf_token %}

            <div class="form-group">
                <label class="form-label" for="id_name">Name: <span class="required">*</span></label>
                <input class="form-input" type="text" name="name" id="id_name" value="{{ form.name.value|default:'' }}">
            </div>

            <div class="form-group">
                <label class="form-label" for="id_description">Description: <span class="required">*</span></label>
                <textarea class="form-input form-textarea" name="description" id="id_description">{{ form.description.value|default:'' }}</textarea>
            </div>

            <div class="form-group">
                <label class="form-label">Concerned Colleges: <span class="required">*</span></label>
                <div id="college-tag-row" class="college-row">
                    <!-- Tags, add button, and hidden inputs will be rendered here by JS -->
                </div>
                <select id="college-options-template" style="display:none;">
                    <option value="">Select College</option>
                    {% for college in form.fields.concerned_colleges.queryset %}
                        <option value="{{ college.id }}">{{ college.name }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="form-actions">
                <a href="{% url 'agenda' %}" class="btn btn-preview" style="text-decoration: none;">Back</a>
                <button type="submit" class="btn btn-submit">Add Agenda</button>
            </div>
        </form>
    </div>

<!-- SVG Sprite Section -->
<svg style="display:none;" xmlns="http://www.w3.org/2000/svg">
    <symbol id="icon-add" viewBox="0 0 16 16">
        <path d="M6.80039 14.4004C6.80039 14.7187 6.92682 15.0239 7.15186 15.2489C7.37691 15.474 7.68213 15.6004 8.00039 15.6004C8.31865 15.6004 8.62388 15.474 8.84892 15.2489C9.07396 15.0239 9.20039 14.7187 9.20039 14.4004V9.20039H14.4004C14.7187 9.20039 15.0239 9.07396 15.2489 8.84892C15.474 8.62388 15.6004 8.31865 15.6004 8.00039C15.6004 7.68213 15.474 7.37691 15.2489 7.15186C15.0239 6.92682 14.7187 6.80039 14.4004 6.80039H9.20039V1.60039C9.20039 1.28213 9.07396 0.976906 8.84892 0.751863C8.62388 0.526819 8.31865 0.400391 8.00039 0.400391C7.68213 0.400391 7.37691 0.526819 7.15186 0.751863C6.92682 0.976906 6.80039 1.28213 6.80039 1.60039V6.80039H1.60039C1.28213 6.80039 0.976906 6.92682 0.751863 7.15186C0.526819 7.37691 0.400391 7.68213 0.400391 8.00039C0.400391 8.31865 0.526819 8.62388 0.751863 8.84892C0.976906 9.07396 1.28213 9.20039 1.60039 9.20039H6.80039V14.4004Z" fill="black"/>
    </symbol>
</svg>

<script>
    // Form Validation for Required Fields (Agenda)
    document.querySelector('.agenda-form').addEventListener('submit', function(e) {
        let valid = true;
        const nameInput = document.getElementById('id_name');
        const descInput = document.getElementById('id_description');

        // Remove Previous Error States
        nameInput.classList.remove('error-input');
        descInput.classList.remove('error-input');
        let nameError = document.getElementById('name-error');
        let descError = document.getElementById('desc-error');
        let collegeError = document.getElementById('college-error');
        if (nameError) nameError.remove();
        if (descError) descError.remove();
        if (collegeError) collegeError.remove();

        if (!nameInput.value.trim()) {
            valid = false;
            nameInput.classList.add('error-input');
            const err = document.createElement('div');
            err.id = 'name-error';
            err.textContent = 'Name is required.';
            err.style.color = '#E53E3E';
            err.style.fontSize = '0.95rem';
            err.style.marginTop = '0.25rem';
            nameInput.parentNode.appendChild(err);
        }
        if (!descInput.value.trim()) {
            valid = false;
            descInput.classList.add('error-input');
            const err = document.createElement('div');
            err.id = 'desc-error';
            err.textContent = 'Description is required.';
            err.style.color = '#E53E3E';
            err.style.fontSize = '0.95rem';
            err.style.marginTop = '0.25rem';
            descInput.parentNode.appendChild(err);
        }

        // Validate At Least One College Selected
        const selectedColleges = Array.from(document.querySelectorAll('input[name="concerned_colleges"]')).map(i => i.value);
        if (selectedColleges.length === 0) {
            valid = false;
            const tagRow = document.getElementById('college-tag-row');
            const err = document.createElement('div');
            err.id = 'college-error';
            err.textContent = 'At least one college must be selected.';
            err.style.color = '#E53E3E';
            err.style.fontSize = '0.95rem';
            tagRow.appendChild(err);
        }

        if (!valid) {
            e.preventDefault();
        }
    });

    // Tag UI for Concerned Colleges
    const collegeTagRow = document.getElementById('college-tag-row');
    const collegeOptionsTemplate = document.getElementById('college-options-template');
    const collegeSelectDropdown = document.createElement('select');
    collegeSelectDropdown.id = 'college-select-dropdown';
    collegeSelectDropdown.style.display = 'none';
    collegeSelectDropdown.style.position = 'absolute';
    collegeSelectDropdown.style.top = '44px';
    collegeSelectDropdown.style.left = '0';
    collegeSelectDropdown.style.fontFamily = "Inter, Arial, sans-serif";
    collegeSelectDropdown.style.fontSize = "13px";
    collegeSelectDropdown.style.padding = "8px 16px";
    collegeSelectDropdown.style.borderRadius = "6px";
    collegeSelectDropdown.style.appearance = "none";
    collegeSelectDropdown.style.background = "white url('data:image/svg+xml;utf8,<svg fill=\"none\" height=\"16\" viewBox=\"0 0 16 16\" width=\"16\" xmlns=\"http://www.w3.org/2000/svg\"><path d=\"M4 6L8 10L12 6\" stroke=\"%23374151\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\"/></svg>') no-repeat right 18px center/16px 16px";
    collegeSelectDropdown.style.paddingRight = "5px";

    Array.from(collegeOptionsTemplate.options).forEach(opt => {
        collegeSelectDropdown.appendChild(opt.cloneNode(true));
    });

    // Get Colleges From Select Options
    const colleges = Array.from(collegeSelectDropdown.options)
        .filter(opt => opt.value)
        .map(opt => ({id: opt.value, name: opt.text}));

    let selectedColleges = [];
    const collegesDataScript = document.getElementById('colleges-data');
    if (collegesDataScript) {
        selectedColleges = JSON.parse(collegesDataScript.textContent);
    }

    // Render Tags Function
    function renderTags() {
        collegeTagRow.innerHTML = '';
        selectedColleges.forEach(id => {
            const college = colleges.find(c => c.id === id);
            if (college) {
                const tag = document.createElement('span');
                tag.className = 'college-tag';
                const removeBtn = document.createElement('button');
                removeBtn.type = 'button';
                removeBtn.className = 'remove-x';
                removeBtn.innerHTML = '&times;';
                removeBtn.onclick = function() {
                    selectedColleges = selectedColleges.filter(cid => cid !== id);
                    renderTags();
                };
                tag.appendChild(removeBtn);
                tag.appendChild(document.createTextNode(college.name));
                collegeTagRow.appendChild(tag);
            }
        });

        const addCollegeBtn = document.createElement('button');
        addCollegeBtn.type = 'button';
        addCollegeBtn.id = 'add-college-btn';
        addCollegeBtn.className = 'add-college-btn';
        addCollegeBtn.style.marginLeft = '8px';
        addCollegeBtn.innerHTML = `<svg width="16" height="16"><use href="#icon-add" /></svg>`;
        addCollegeBtn.onclick = function(e) {
            const btnRect = addCollegeBtn.getBoundingClientRect();
            collegeSelectDropdown.style.display = 'block';
            collegeSelectDropdown.style.position = 'fixed';
            collegeSelectDropdown.style.left = (btnRect.left) + 'px';
            collegeSelectDropdown.style.top = (btnRect.bottom + 4) + 'px';
            collegeSelectDropdown.innerHTML = '';
            const templateOptions = Array.from(document.getElementById('college-options-template').options);
            templateOptions.forEach(opt => {
                if (!opt.value || !selectedColleges.includes(opt.value)) {
                    collegeSelectDropdown.appendChild(opt.cloneNode(true));
                }
            });

            collegeSelectDropdown.focus();
        };
        collegeTagRow.appendChild(addCollegeBtn);
        if (!document.body.contains(collegeSelectDropdown)) {
            document.body.appendChild(collegeSelectDropdown);
        }

        selectedColleges.forEach(cid => {
            const hidden = document.createElement('input');
            hidden.type = 'hidden';
            hidden.name = 'concerned_colleges';
            hidden.value = cid;
            collegeTagRow.appendChild(hidden);
        });
    }

    renderTags();

    collegeSelectDropdown.onchange = function() {
        const selectedId = collegeSelectDropdown.value;
        if (selectedId && !selectedColleges.includes(selectedId)) {
            selectedColleges.push(selectedId);
            renderTags();
        }
        collegeSelectDropdown.value = '';
        collegeSelectDropdown.style.display = 'none';
    };

    document.addEventListener('mousedown', function(e) {
        if (!collegeSelectDropdown.contains(e.target) && e.target.id !== 'add-college-btn') {
            collegeSelectDropdown.style.display = 'none';
        }
    });
</script>

</body>
</html>

{% endblock %}