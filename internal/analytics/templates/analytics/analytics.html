{% extends "base_internal.html" %}
{% block content %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css" integrity="sha512-2SwdPD6INVrV/lHTZbO2nodKhrnDdJK9/kg2XD1r9uGqPo1cUbujc+IYdlYdEErWNu69gVcYgdxlmVmzTWnetw==" crossorigin="anonymous" referrerpolicy="no-referrer"/>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0rem;
            padding: 0rem;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            font-family: Helvetica, Arial, sans-serif;
            background-color: #f9f9f9;
        }
        main {
            display: flex;
            flex-direction: column;
            justify-content: flex-start; 
            align-items: stretch;
            margin: 0 5rem 2rem 5rem;
            gap: 0.5rem; 
        }
        footer {
            background-color: #245F3E;
            position: relative;
            bottom: 0;
            width: 100%;
            height: 20rem;
        } 
        .sub {
            font-size: 1.5rem;
            font-weight: 400;  
            margin-top: 0.7rem;
            margin-bottom: 2.5rem;  
            max-width: 90%;
        } 
        * {
            box-sizing: border-box;
        } 
        h2 {
            font-size: 1.75rem;
            font-weight: 500;
            margin: 0 0 1.25rem 0;
        }
        i {
            font-size: 1.75rem;
            color: black; 
            margin-right: 0.75rem;
            font-weight: 400;  
            text-decoration: none;
        }
        a {
            text-decoration: none;   
        }
        .header-container {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            width: 100%;
            gap: 2rem;  
            padding: 3rem 0rem 1rem 3rem;
        }  
        header {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            gap: 1.25rem; 
            margin: 0;
            padding: 0.5rem 1rem;
            border: 1px solid #e0e0e0;
            background-color: #f5f5f5;
            position: relative;
            top: 0;
        } 
        header img {
            border-radius: 50%; 
            border: 4px solid #e4c600;
            margin-right: 0.75rem;
            width: 3.25rem;
            height: 3.25rem;
            object-fit: cover;
            cursor: pointer;
            transition: transform 0.2s ease;
        }
        .dropdown {
            position: relative;
            width: 14.5rem;
        }
        .dropdown-btn { 
            margin: 0;
            width: 100%;
            padding: 0.75rem 1rem;
            border: 0.08rem solid #b6b6b6;
            border-radius: 0.75rem;
            background: #f9f9f9;
            text-align: center;
            cursor: pointer;
            font-family: Helvetica, Arial, sans-serif;
            font-weight: 400;
            font-size: 1rem;
        }
        .dropdown-btn:hover{
            background-color: #000000;
            color: white;
        }
        .dropdown-menu {
            position: absolute;
            top: 100%;
            left: 0;
            margin: 0;
            right: 0;
            background: white;
            border: 0.08rem solid #ccc;
            border-radius: 0.75rem;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            z-index: 10;
            overflow: hidden;
        }
        .dropdown-item {
            padding: 0.75rem;
            cursor: pointer;
            transition: background 0.2s;
            font-family: Helvetica, Arial, sans-serif;
            font-weight: 400;
            text-align: center;
            border-bottom: 1px solid rgb(196, 196, 196);
        }
        .dropdown-item:hover {
            background-color: #000000;
            color: white;
        }
        .hidden {
            display: none;
        }
        .upper, .time {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 0;
        }
        .export-btn {
            background-color: #040404;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            transition: background-color 0.2s;
        }
        .export-btn svg {
            fill: white;
            width: 20px;
            height: 20px;
            display: inline-block;
            vertical-align: middle;
        }
        .export-btn:hover {
            background-color: #1d4178;
        }

        .export-btn i {
            color: white;
            font-size: 1.2rem;
            margin: 0;
        }
        .content {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        .first, .second, .third {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }
        .card {
            flex: 1;
            flex-direction: column;
            min-width: 280px;
            min-height: 180px;
            background: #fff;
            border-radius: 0.75rem;
            border: 0.08rem solid #b6b6b6;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding: 1.5rem;
        }
        .card h4 {
            font-size: 1.25rem;
            font-weight: 400;
            margin: 0 0 1.25rem 0;
            width: 100%;
            text-align: left;
        }
        .stat-container {
            flex: 0.33;
            min-width: 280px;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .stat {
            background: #fff;
            border-radius: 0.75rem;
            border: 0.08rem solid #b6b6b6;
            padding: 1.75rem;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            height: calc(50% - 0.5rem);
            transition: all 0.2s ease;
        }

        .stat:hover, .card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            border-color: #999;
        }
        .stat-number {
            font-size: 2.25rem;
            font-weight: 600;
            color: #111;
            letter-spacing: -0.5px;
        }
        .stat-label {
            font-size: 0.95rem;
            color: #555;
            font-weight: 500;
        }
        .stat-change {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 1.15rem;
            color: #16a34a;
            font-weight: 500;
        }
        .stat-change svg {
            color: #16a34a;
        }  
        .stat-change.negative {
            color: #dc2626;
        }

        .stat-change.negative svg {
            fill: #dc2626;
        }
    </style>
</head>
<body> 
    <svg style="display: none;">
        <symbol id="file-export" viewBox="0 0 640 640" fill="currentColor">
            <path d="M128.5 64C93.2 64 64.5 92.7 64.5 128L64.5 512C64.5 547.3 93.2 576 128.5 576L384.5 576C419.8 576 448.5 547.3 448.5 512L448.5 416L526.6 416L495.6 447C486.2 456.4 486.2 471.6 495.6 480.9C505 490.2 520.2 490.3 529.5 480.9L601.5 408.9C610.9 399.5 610.9 384.3 601.5 375L529.5 303C520.1 293.6 504.9 293.6 495.6 303C486.3 312.4 486.2 327.6 495.6 336.9L526.6 367.9L448.5 367.9L448.5 234.4C448.5 217.4 441.8 201.1 429.8 189.1L323.2 82.7C311.2 70.7 295 64 278 64L128.5 64zM390 240L296.5 240C283.2 240 272.5 229.3 272.5 216L272.5 122.5L390 240zM256.5 392C256.5 378.7 267.2 368 280.5 368L384.5 368L384.5 416L280.5 416C267.2 416 256.5 405.3 256.5 392z"/>
        </symbol> 
        <symbol id="upward-trend" viewBox="0 0 640 640" fill="green">
            <path d="M416 224C398.3 224 384 209.7 384 192C384 174.3 398.3 160 416 160L576 160C593.7 160 608 174.3 608 192L608 352C608 369.7 593.7 384 576 384C558.3 384 544 369.7 544 352L544 269.3L374.6 438.7C362.1 451.2 341.8 451.2 329.3 438.7L224 333.3L86.6 470.6C74.1 483.1 53.8 483.1 41.3 470.6C28.8 458.1 28.8 437.8 41.3 425.3L201.3 265.3C213.8 252.8 234.1 252.8 246.6 265.3L352 370.7L498.7 224L416 224z"/>
        </symbol>
        <symbol id="downward-trend" viewBox="0 0 640 640" fill="red">
            <path d="M416 416C398.3 416 384 430.3 384 448C384 465.7 398.3 480 416 480L576 480C593.7 480 608 465.7 608 448L608 288C608 270.3 593.7 256 576 256C558.3 256 544 270.3 544 288L544 370.7L374.6 201.3C362.1 188.8 341.8 188.8 329.3 201.3L224 306.7L86.6 169.4C74.1 156.9 53.8 156.9 41.3 169.4C28.8 181.9 28.8 202.2 41.3 214.7L201.3 374.7C213.8 387.2 234.1 387.2 246.6 374.7L352 269.3L498.7 416L416 416z"/>
        </symbol>
    </svg>  
    <header>
        extension
    </header>
    <main> 
       <div class="upper">
            <div class="time">
                <h2 style="margin:0 0 0 0;">Analytics</h2>
                <div class="dropdown" style="margin-left: 1.5rem;">
                    <button class="dropdown-btn">This Quarter â–¾</button>
                    <div class="dropdown-menu hidden">
                        <div class="dropdown-item">Curent Quarter</div>
                        <div class="dropdown-item">Q2</div>
                        <div class="dropdown-item">Q3</div>
                        <div class="dropdown-item">Q4</div>
                    </div>
                </div>
            </div>
            <div class="export">
                <button id="exportBtn" class="export-btn">
                    <svg width="20" height="20" style="fill: currentColor;">
                        <use href="#file-export"/>
                    </svg>
                    Export as PDF
                </button>
            </div>
        </div>
        <div class="content">
            <div class="first">
                <div class="card">
                    <h4>Active Projects</h4>
                    <canvas id="activeProjectsChart" width="350" height="115"></canvas>
                </div>
                <div class="stat-container">
                    </div>
            </div>

            <div class="second">
                <div class="card" style="flex: 3.555;">
                    <h4>Budget Allocation</h4>
                    <canvas id="budgetMultiLineChart" width="600" height="180"></canvas>
                </div>
                <div class="card">
                    <h4>Agenda Distribution</h4>
                    <canvas id="agendaDistributionChart" width="500" height="500"></canvas>
                </div>
            </div>

            <div class="third">
                <div class="card">
                    <h4>Trained Individuals</h4>
                    <canvas id="trainedChart" width="900" height="500"></canvas>
                </div>
            </div>
        </div>
    </main>
    <footer>
        <p>test</p>
    </footer>
    <script>
        // CRITICAL: Register the DataLabels plugin
        Chart.register(ChartDataLabels);



        // --- General Fetch Function ---
        async function fetchChartData(endpoint) {
            try {
                const response = await fetch(endpoint);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return await response.json();
            } catch (error) {
                console.error(`Error fetching data from ${endpoint}:`, error);
                return null;
            }
        }

        // --- Dropdown Logic (Untouched) ---
        document.querySelectorAll('.dropdown-btn').forEach(btn => {
            btn.addEventListener('click', e => {
                e.stopPropagation(); 
                const menu = btn.nextElementSibling;
                document.querySelectorAll('.dropdown-menu').forEach(m => {
                    if (m !== menu) m.classList.add('hidden');
                });
                menu.classList.toggle('hidden');
            });
        });
        document.querySelectorAll('.dropdown-item').forEach(item => {
            item.addEventListener('click', e => {
                e.stopPropagation();
                const menu = item.parentElement;
                const btn = menu.previousElementSibling;
                btn.textContent = e.target.textContent;
                menu.classList.add('hidden');
            });
        });
        document.addEventListener('click', () => {
            document.querySelectorAll('.dropdown-menu').forEach(menu => {
                menu.classList.add('hidden');
            });
        });

        // --- CHART 1: Active Projects (Line Chart) ---
        async function renderActiveProjectsChart() {
            const data = await fetchChartData(ENDPOINTS.active);
            if (!data) return;

            const ctx = document.getElementById('activeProjectsChart').getContext('2d');
            const activeProjectsChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.labels, // e.g., ["Jan", "Feb", "Mar", ...]
                    datasets: [{
                        label: data.label || "Active Projects",
                        data: data.data, // e.g., [5, 7, 6, ...]
                        fill: true,
                        borderColor: "rgba(75, 192, 192, 1)",
                        backgroundColor: "rgba(75, 192, 192, 0.2)",
                        tension: 0.25,
                        pointBackgroundColor: "#fff",
                        pointBorderColor: "rgba(75, 192, 192, 1)",
                        pointRadius: 5,
                        pointHoverRadius: 7
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { grid: { display: false }, title: { display: true, text: 'Timeframe', font: { size: 14 } } },
                        y: { beginAtZero: true, grid: { color: '#f0f0f0' }, title: { display: true, text: 'Projects', font: { size: 14 } } }
                    }
                }
            });
            return activeProjectsChart;
        }

        // --- CHART 2: Budget Allocation (Multi-line Chart) ---
        async function renderBudgetMultiLineChart() {
            const data = await fetchChartData(ENDPOINTS.budget);
            if (!data) return;

            const ctxBudget = document.getElementById('budgetMultiLineChart').getContext('2d');
            const budgetMultiLineChart = new Chart(ctxBudget, {
                type: 'line',
                data: {
                    labels: data.labels,
                    datasets: [
                        { label: "Allocated Budget", data: data.allocated, borderColor: "rgba(75, 192, 192, 1)", backgroundColor: "rgba(75, 192, 192, 0.2)", tension: 0.3, fill: false, pointRadius: 5 },
                        { label: "Used Budget", data: data.used, borderColor: "rgba(255, 99, 132, 1)", backgroundColor: "rgba(255, 99, 132, 0.2)", tension: 0.3, fill: false, pointRadius: 5 },
                        { label: "Remaining Budget", data: data.remaining, borderColor: "rgba(255, 206, 86, 1)", backgroundColor: "rgba(255, 206, 86, 0.2)", tension: 0.3, fill: false, pointRadius: 5 }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: "top", labels: { font: { size: 13 } } },
                        tooltip: { callbacks: { label: function(context) { return `${context.dataset.label}: â‚±${context.raw}M`; } } }
                    },
                    scales: {
                        x: { title: { display: true, text: "" }, ticks: { autoSkip: false, maxRotation: 45, minRotation: 45 } },
                        y: { beginAtZero: true, title: { display: true, text: "Budget (in Millions)" } }
                    }
                }
            });
            return budgetMultiLineChart;
        }

        // --- CHART 3: Agenda Distribution (Pie Chart) ---
        async function renderAgendaDistributionChart() {
            const data = await fetchChartData(ENDPOINTS.agenda);
            if (!data) return;
            
            const backgroundColors = [
                "#FF6384","#36A2EB","#FFCE56","#4BC0C0","#9966FF",
                "#FF9F40","#8BC34A","#E91E63","#00BCD4"
            ];

            const ctxAgenda = document.getElementById('agendaDistributionChart').getContext('2d');
            const agendaDistributionChart = new Chart(ctxAgenda, {
                type: 'pie',
                data: {
                    labels: data.labels,
                    datasets: [{
                        label: "Agenda Distribution",
                        data: data.data,
                        backgroundColor: data.labels.map((_, i) => backgroundColors[i % backgroundColors.length]),
                        borderColor: "#fff",
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: false, // Default to hidden for space, will be shown on PDF export
                            position: "left",
                            labels: {
                                boxWidth: 15, padding: 15, font: { size: 11 },
                                generateLabels: function(chart) {
                                    const data = chart.data;
                                    const total = data.datasets[0].data.reduce((a, b) => a + b, 0);
                                    return data.labels.map((label, i) => {
                                        const value = data.datasets[0].data[i];
                                        const percentage = ((value / total) * 100).toFixed(1);
                                        return {
                                            text: `${label.substring(0, 30)}... (${percentage}%)`,
                                            fillStyle: data.datasets[0].backgroundColor[i],
                                            // ... other properties
                                        };
                                    });
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let total = context.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                                    let value = context.raw;
                                    let percentage = ((value / total) * 100).toFixed(1);
                                    return `${context.label}: ${value} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
            return agendaDistributionChart;
        }

        // --- CHART 4: Trained Individuals (Bar Chart) ---
        async function renderTrainedChart() {
            const data = await fetchChartData(ENDPOINTS.trained);
            if (!data) return;

            // Sort data by count descending (if not already sorted by Django view)
            const sortedData = data.labels.map((label, i) => ({ label, count: data.data[i] }))
                .sort((a, b) => b.count - a.count);

            const trainedLabels = sortedData.map(item => item.label);
            const trainedData = sortedData.map(item => item.count);
            
            const ctxTrained = document.getElementById('trainedChart').getContext('2d');
            const trainedChart = new Chart(ctxTrained, {
                type: 'bar',
                data: {
                    labels: trainedLabels,
                    datasets: [{
                        label: 'Trained Individuals',
                        data: trainedData,
                        backgroundColor: trainedLabels.map((_, i) => {
                            const hue = Math.floor((i / trainedLabels.length) * 270);
                            return `hsl(${hue} 70% 55%)`;
                        }),
                        borderColor: '#ffffff',
                        borderWidth: 1
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const value = context.raw;
                                    const total = context.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                                    const pct = ((value / total) * 100).toFixed(1);
                                    return `${context.label}: ${value} (${pct}%)`;
                                }
                            }
                        },
                        datalabels: {
                            anchor: 'end',
                            align: 'right',
                            formatter: (val) => val,
                            color: '#111',
                            font: { weight: 'bold' }
                        }
                    }
                }
            });
            return trainedChart;
        }
        
        // --- Stat Block (No changes requested, using dummy data) ---
        const statsData = [
            { label: "Active Users", number: "247", change: +12, trend: "up" },
            { label: "Total Visits", number: "1,429", change: -8, trend: "down" }
        ];

        function renderStats() {
            const statContainer = document.querySelector('.stat-container');
            statContainer.innerHTML = statsData.map(stat => `
                <div class="stat">
                    <div class="stat-label">${stat.label}</div>
                    <div class="stat-number">${stat.number}</div>
                    <div class="stat-change ${stat.trend === 'down' ? 'negative' : ''}">
                        <svg width="50" height="50" style="fill: currentColor;">
                            <use href="#${stat.trend === 'down' ? 'downward-trend' : 'upward-trend'}"/>
                        </svg>
                        ${Math.abs(stat.change)}% from last month
                    </div>
                </div>
            `).join('');
        }

        // --- Initialization and PDF Export ---

        let chartsInstance = {}; // Store chart instances

        async function initCharts() {
            renderStats(); // Render stats first
            chartsInstance.active = await renderActiveProjectsChart();
            chartsInstance.budget = await renderBudgetMultiLineChart();
            chartsInstance.agenda = await renderAgendaDistributionChart();
            chartsInstance.trained = await renderTrainedChart();
        }

        document.addEventListener('DOMContentLoaded', initCharts);

        document.getElementById('exportBtn').addEventListener('click', async function () {
            try {
                const chartsList = [
                    { title: 'Active Projects', chart: chartsInstance.active },
                    { title: 'Budget Allocation', chart: chartsInstance.budget },
                    { title: 'Agenda Distribution', chart: chartsInstance.agenda },
                    { title: 'Trained Individuals', chart: chartsInstance.trained }
                ].filter(item => item.chart); // Filter out any chart that failed to load

                // Temporarily show agenda legend for PDF
                if (chartsInstance.agenda) {
                    chartsInstance.agenda.options.plugins.legend.display = true;
                    chartsInstance.agenda.update();
                }

                await new Promise(r => setTimeout(r, 500)); 

                const pdfContainer = document.createElement('div');
                pdfContainer.style.background = 'white';

                chartsList.forEach((c, index) => {
                    const pageDiv = document.createElement('div');
                    pageDiv.className = 'pdf-page';
                    pageDiv.style.margin = '0';
                    pageDiv.style.padding = '0';
                    pageDiv.style.textAlign = 'center';

                    const title = document.createElement('h2');
                    title.textContent = c.title;
                    title.style.margin = '0 0 10px 0';
                    pageDiv.appendChild(title);

                    c.chart.update('none');

                    const img = new Image();
                    img.src = c.chart.toBase64Image();
                    img.style.display = "block";
                    img.style.margin = "0 auto";
                    img.style.maxWidth = "95%";
                    img.style.height = "auto";

                    pageDiv.appendChild(img);

                    if (index < chartsList.length - 1) {
                        pageDiv.style.pageBreakAfter = 'always';
                    }
                    pdfContainer.appendChild(pageDiv);
                });

                const options = {
                    margin: 10,
                    filename: 'analytics-charts.pdf',
                    image: { type: 'jpeg', quality: 1 },
                    html2canvas: { scale: 2, useCORS: true },
                    jsPDF: { unit: 'mm', format: 'a4', orientation: 'landscape' }
                };

                await html2pdf().from(pdfContainer).set(options).save();

                // Hide agenda legend again
                if (chartsInstance.agenda) {
                    chartsInstance.agenda.options.plugins.legend.display = false;
                    chartsInstance.agenda.update();
                }

            } catch (error) {
                console.error('PDF export failed:', error);
                alert('PDF export failed.');
            }
        });
    </script>
</body>
</html>

{% endblock %}